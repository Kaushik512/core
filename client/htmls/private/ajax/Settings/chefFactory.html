<style>

#dirArea {
	border-right: 1px solid #000000;
    height: 100%;
    overflow: auto;
    width: 21%;
    float:left;
    display: none;
}
#fileEditorArea {
	height: 100%;
    overflow: auto;
    width: 79%;
    float:right;
    display: none;
}
#fileEditorContainer {
	height: 90%;
    width: 100%;
    display:none;

}
#fileEditorDiv{
	height: 100%;
	width: 100%;
	border-bottom: 1px solid black; 
}
#workingIndicatorContainer {
	position: absolute;
	top:0;
	left: 0;
	z-index: 10;
	height: 100%;
	width: 100%;
	background-color:rgba(255,255,255,0.8); 
	padding-top: 18%;
	display: none;
	
}
#editorBtnContainer {
	display: none;
    padding-left: 21%;
    padding-top: 10px;
}

#fileEditorMsgContainer{
	height: 100%;
    padding-top: 15%;
    text-align: center;
    width: 100%;
}

#workingMsg{
	display: block;
    padding-top: 10px;
}
.editorBtn {
	margin-left: 10%;
}

</style>
 	
<div id="dirArea">
 <ul class="nav nav-tabs">
              <li class="active"><a id="cookbook_link" href="#cookbookDirArea" data-toggle="tab">Cookbooks</a></li>
              <li><a id="roles_tab" href="#rolesDirArea" data-toggle="tab">Roles</a></li>        
 </ul>
 <div class="tab-content">
      <div class="tab-pane active" id="cookbookDirArea"></div>
      <div class="tab-pane active" id="rolesDirArea"></div>
</div>
</div>

<div id="fileEditorArea">
	<div id="fileEditorContainer">
		<div id="fileEditorDiv"></div>

	</div>
	<div id="editorBtnContainer"><button class="btn btn-primary btn-lg editorBtn" role="button" disabled>Clone</button><button class="btn btn-primary btn-lg save editorBtn" role="button">Save</button><button class="btn btn-primary btn-lg editorBtn" role="button" disabled>Test</button></div>
	<div id="fileEditorMsgContainer">
     <span id='chefAccountMsg' style="display:block;position:absolute;top:4px"></span>
     <span id='chefInstructionMsg'> <span style="font-size:24px">Welcome to Chef Factory </span><br/><br/>
     <span style="font-size:20px">You can Clone, Edit and Upload a Cookbook,Roles to Chef Server.</span><br/>
     <span style="font-size:20px">
     Please select a Cookbook or Role. </span> </span>
	</div>
</div>
<div id="workingIndicatorContainer" class="text-center">
<img src="img/loading.gif" style="height:10%;width:auto"/>
<span id="workingMsg"></span>
</div>


<script src="js/jquery-filetree/jqueryFileTree.js" type="text/javascript"></script>
<script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">

$(function() {
    var urlParams = {};
    (window.onpopstate = function() {
        var url = window.location.href;
        var indexOfQues = url.lastIndexOf("?");
        if (indexOfQues != -1) {
            var sub = url.substring(indexOfQues + 1);
            console.log(sub);
            urlParams.id = sub;
        }
    })();

    var $fileEditorDivContianer = $('#fileEditorContainer').hide();
    var $fileEditorDiv = $('#fileEditorDiv');
    var $editorBtnContainer = $('#editorBtnContainer').hide();
    var $workingIndicatorContainer = $('#workingIndicatorContainer');
    var $workingMsg = $('#workingMsg');
    var $fileEditorMsgContainer = $('#fileEditorMsgContainer');
    var editor = ace.edit("fileEditorDiv");

    editor.setTheme("ace/theme/clouds");
    editor.getSession().setMode("ace/mode/ruby");
    $workingMsg.empty().append('Please Wait ... Syncing Cookbooks');
    $workingIndicatorContainer.show();
    var $dirArea = $('#dirArea');
    $cookbookdir = $('#cookbookDirArea');
    $rolesDirArea = $('#rolesDirArea');
    $databagDirArea = $('#databagDirArea');
    //$workingIndicatorContainer.hide();
    var url = '/cheffactory/' + urlParams.id + '/cookbooks/'; //'/userCookbooks/save';
    var isCookBook = true;
    var rolesSynced = false;
    $('#cookbook_link').on('shown.bs.tab', function(e) {
        url = '/cheffactory/' + urlParams.id + '/cookbooks/'; //'/userCookbooks/save';
        isCookBook = true;
    });
    $('#roles_tab').on('shown.bs.tab', function(e) {
        url = '/cheffactory/' + urlParams.id + '/roles/';
        isCookBook = false;
        $fileEditorDivContianer.hide();
        $editorBtnContainer.hide();
        $fileEditorMsgContainer.show();
        if (!rolesSynced) {
            $workingMsg.empty().append('Please Wait ... Syncing Roles');
            $workingIndicatorContainer.show();
            $rolesDirArea.fileTree({
                root: '/',
                script: '/cheffactory/' + urlParams.id + '/roles/',
                onFolderLoad: function(path, data) {
                    if (path === '/') {
                        $dirArea.show();
                        $('#fileEditorArea').show();
                        $workingIndicatorContainer.hide()
                    }
                }
            }, function(file) {
                $fileEditorMsgContainer.hide();
                $.get('/cheffactory/' + urlParams.id + '/roles/?path=' + file, function(data) {
                    if (data.resType == 'file') {
                        $fileEditorDivContianer.show();
                        $editorBtnContainer.show();
                        $fileEditorDiv.attr('data-file-path', file);
                        editor.setValue(data.fileData);
                    }
                });
            });
            rolesSynced = true;
        }
    });
    $('#databag_link').on('shown.bs.tab', function(e) {
        alert('here');
    });




    $cookbookdir.fileTree({
        root: '/',
        script: '/cheffactory/' + urlParams.id + '/cookbooks/',
        onFolderLoad: function(path, data) {
            if (path === '/') {
                $dirArea.show();
                $('#fileEditorArea').show();
                $('#chefAccountMsg').append('Chef Account : ' + data.chefUserName);
                $workingIndicatorContainer.hide()
            }
        }
    }, function(file) {
        $fileEditorMsgContainer.hide();
        $.get('/cheffactory/' + urlParams.id + '/cookbooks/?path=' + file, function(data) {
            if (data.resType == 'file') {
                $fileEditorDivContianer.show();
                $editorBtnContainer.show();
                $fileEditorDiv.attr('data-file-path', file);
                editor.setValue(data.fileData);
            }
        });
    });

    $('.save').click(function(e) {
        var filePath = $fileEditorDiv.attr('data-file-path');
        var fileContent = editor.getValue();
        var str = 'Please Wait ... Uploading Cookbook';
        if (!isCookBook) {
            str = 'Please Wait ... Uploading Roles';
        }
        $workingMsg.empty().append(str);
        $workingIndicatorContainer.show();
        $.post(url, {
            filePath: filePath,
            fileContent: fileContent
        }, function(data, success) {
            $workingIndicatorContainer.hide();
            console.log(data);
        });

    });



});
</script>