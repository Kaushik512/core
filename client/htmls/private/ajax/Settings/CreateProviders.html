  <script>
    // $(".tree-view").hide();

  </script>
  <style type="text/css">
   #createProvider .marginbottom{
    margin-bottom: 10px;
  }
  #createProvider .width-60{
    width:60%;
  }
  #createProvider .width-20{
    width:20%;
  }
  #createProvider .addimage, .removeimage{
   cursor: pointer;
 }
 #createProvider .addNewRegion {
  border:solid gray 1px; padding:10px;
  margin-bottom: 15px;
}
#createProvider .addRow ,.removeRow{
  float: left;
  margin-top: 32px;
  margin-left:3.5px;
}
#createProvider .addRegion, .removeRegion{
  position: relative;
  top: -18px;
  left: 17px;
  float: right;
}
#createProvider .row{
  margin-bottom: 10px;
}
</style>
<div class="row" id="createProvider">
 <div class="col-md-12">
  <div class="col-md-12">
   <form action="" id="myForm54">
    <div class="widget-box">
     <div class="widget-header">
      <h4 class="widget-margin" style="color:black;">Add New Provider<span id="spnprovider"></span></h4>
    </div>
    <div class="widget-body">
      <div class="widget-main" style="min-height:300px">
       <div>
        <section id="widget-grid" class="">
         <!-- START ROW -->
         <div class="row">
          <!-- NEW COL START -->
          <article class="col-sm-12 col-md-12 col-lg-12">
           <!-- Widget ID (each widget will need unique ID)-->
           <div class="jarviswidget" id="wid-id-3" data-widget-editbutton="false" data-widget-custombutton="false">
            <!-- widget div-->
            <div id="appender">
             <!-- widget content -->
             <div class="row">
               <div class="col-lg-6 col-md-6">
                <label for="name">Provider Type:<span style="color:Red;" class="control-label">&nbsp;*</span></label>
                <select id="providertype" unique="true" uniqueconditionedby="orgname"  class="chooseOrganization width-100" style="vertical-align:central"  cat-validation="required" cdata="catalyst" skiprowid="yes">
                 <option value="">Select Provider</option>
                 <option value="aws">AWS</option>
               </select>
             </div>   
             <div class="col-lg-6 col-md-6">
               <label for="">Name:<span style="color:Red;" class="control-label">&nbsp;*</span></label>
               <!-- <i class="icon-append fa fa-building"></i> -->
               <input name="ctl00$MainContent$orgname" placeholder="Enter Name of the Provider" id="name" class="form-control" type="text"  cdata="catalyst" cat-validation="required,max15">
             </div>    
           </div>

           <div class="row">
            <!-- -->
            <div class="col-lg-6 col-md-6">
             <label for="">Access Key:<span style="color:Red;" class="control-label">&nbsp;*</span></label>
             <!-- <i class="icon-append fa fa-building"></i> -->
             <input name="ctl00$MainContent$orgname" value="AKIAI6TVFFD23LMBJUPA" id="accessKey" class="form-control" type="text"  cdata="catalyst" cat-validation="required" placeholder="Enter the Access Key">

             <span data-val-controltovalidate="orgname" id="MainContent_Req_orgname" data-val="true" data-val-evaluationfunction="RequiredFieldValidatorEvaluateIsValid" data-val-initialvalue="" style="visibility:hidden;">Required</span>
           </div>
           <div class="col-lg-6 col-md-6">
             <label for="">Secret Key:<span style="color:Red;" class="control-label">&nbsp;*</span></label>
             <!-- <i class="icon-append fa fa-building"></i> -->
             <input name="ctl00$MainContent$orgname" value="qZOZuI2Ys0/Nc7txsc0V2eMMVnsEK6+Qa03Vqiyw" id="secretKey" class="form-control" type="text"  cdata="catalyst" cat-validation="required" placeholder="Enter the Secret Key">

             <span data-val-controltovalidate="orgname" id="MainContent_Req_orgname" data-val="true" data-val-evaluationfunction="RequiredFieldValidatorEvaluateIsValid" data-val-initialvalue="" style="visibility:hidden;">Required</span>
           </div>

         </div>

       </div>
       <!-- end widget div -->
     </div>
     <!-- end widget -->             
   </article>
   <!-- END COL -->
 </div>
 <!-- END ROW -->
</section>
<!-- end widget grid -->
</div>
</div>
</div>
<div class="widget-toolbox clearfix">
  <div class="btn-group pull-right">
    <button id="btnsubmit" class="btn btn-primary btn-mini" style="margin-right:11px;">
     <i class="ace-icon fa fa-check bigger-110"></i>
     Save
   </button>
   <a class="btn btn-primary btn-mini" onclick="window.history.back();" id="btncancel">
     <i class="ace-icon fa fa-undo bigger-110"></i>
     Cancel
   </a>
 </div>
</div>
</div>
</form>
</div>
</div>
</div>
<!--row ends here-->
<!--Popup for selecting a cloud provider before proceeding-->
<script>

  var UtilityMethods={

    initTooltip:function(){
     var $tool=$("[rel=tooltip]");
     if ($tool.length) {
      $tool.tooltip();
    }
  },
  getRandomNumber:function(){      
    return parseInt(Math.random()*10000000000);
  },
  getIdFromURL:function(){
    var options=location.toString().split('?');
    return options.length >1 ? (options[1]!=="new" ? options[1]:"" ):"";
  },
  initializeSelect2:function(){
    $('select').select2();
  }
};


function bindChange_importPemFile() {
  $('input[type="file"]').off('change').on('change',function() {
    $(this).next().val(this.files[0].name);
    $(this).next().next().val($(this).val());
  });
}


function inLineReady(){
 $("input[type='text']").on("click", function () {
   $(this).select();
   $("#msgOrgName").hide();
 });
 //enableUniqueCheckingForInputs(9);
}

inLineReady();

function appendLoader(){
  removeLoader();
  $("form[id*='myForm']").find("div.pull-right > button").attr('disabled','disabled').parent().prepend('<label id="masterssavespinner" class="" style="float:left;"><img  style="margin-left:5px;margin-right:25px;margin-top:8px;" src="img/select2-spinner.gif" /></label>');
}
function removeLoader(){
  $('#masterssavespinner').remove();
}

function checkForKeyPair(){
  var accessKey=$('#accessKey').val(),
  secretKey=$('#secretKey').val();
  if(accessKey && secretKey && accessKey!=='' && secretKey!==''){
    loadKeyPair(accessKey,secretKey);
  }else{
    $('#btnsubmit').attr('disabled','disabled');
  }
}

function loadKeyPair(accessKey,secretKey){
  appendLoader();
  var data1=new FormData();
  data1.append('accessKey',accessKey);
  data1.append('secretKey',secretKey);
  data1.append('region',"us-west-2");
  $.ajax({
    method: "POST",
    url: "/aws/providers/keypairs/list",
    data:data1,
    processData: false,
    contentType:false,
    error:function(XMLHttpRequest, textStatus, errorThrown) {
      bootbox.alert(XMLHttpRequest.responseText);
      removeLoader();
    } 
  }).done(function( msg ) {
    var str='<option value="">Choose Any Key Pair</option>',val=msg['KeyPairs'],len=val.length;
  for(var i=0;i<len;i++){
    str=str+'<option value="'+val[i].KeyName+'">'+val[i].KeyName+'</option>';
  }
  $('select.keyvalue').html(str);
  $('#btnsubmit').removeAttr('disabled');
  removeLoader();
});
}

function setValues(data){
  $('#name').val(data.name);
  $('#accessKey').val(data.accessKey);
  $('#secretKey').val(data.secretKey);
  $('#providertype').val(data.providerType);
  var createTemplateInstance=new createTemplate($('#appender'));
  for(var i=0;i<data.keyPairs.length;i++){
    if(i==0){
      $('#appender').append(createTemplateInstance.getFinalTemplate(true));
    }else{
      $('#appender').append(createTemplateInstance.getFinalTemplate(false));
    }
    
  }
}
$(document).ready(function () {
  $("#name").focus();
  $('#accessKey').blur(checkForKeyPair);
  $('#secretKey').blur(checkForKeyPair);

  $('#myForm54').submit(function() {
  $(this).validate();
  if(isFormValid()){
    saveProviderData();
  }else{
    bootbox.alert("invalid form data");
  }
  return false; // for demo
});


  if(!UtilityMethods.getIdFromURL()){
    var createTemplateInstance=new createTemplate($('#appender'));
    $('#appender').append(createTemplateInstance.getFinalTemplate(true,1));
  bindChange_importPemFile();
  UtilityMethods.initializeSelect2();

}else{
  
  $.ajax({
   method: "GET",url: "/aws/providers/"+UtilityMethods.getIdFromURL(),   
   success: function(data, success) {
    debugger;
    data= typeof data=="string" ?JSON.parse(data):data;
    d4ddata=data;
    setValues(data);
    UtilityMethods.initializeSelect2();
    checkForKeyPair();
  },
  error: function(jqxhr) {
    removeLoader();
    bootbox.alert(jqxhr.status);
  },
  failure: function(data) {
    bootbox.alert(data);
  }
});

}



});

  function saveProviderData(){
    appendLoader();


    var getRegionListForFormSubmission=function(){
      var list=[];
      $('select.region').each(function(){
        var obj={},keyPair=[];
        obj.region_name=$(this).val();
        $(this).parents('.addNewRegion').find('.pemrow').each(function(){
          keyPair.push({
            "keyPair_name":$(this).find('select.keyvalue').val(),
            "file_name" :$(this).find('input.filename').val(),
            "file":$(this).find('input.file')[0].files[0]
          });
        });

        obj.keyPairs=keyPair;
        list.push(obj);
      });
      return list;
    },
    reqBody={},
    FormData;
    reqBody.name=$('#name').val();
    reqBody.accessKey=$('#accessKey').val();
    reqBody.secretKey=$('#secretKey').val();
    reqBody.providerType=$('#providertype').val();
    reqBody.regions=getRegionListForFormSubmission();
    
    formdata=new FormData();
    formdata.append('regions',reqBody.regions.keyPairs[0].file,reqBody.regions.keyPairs[0].file_name);
    //debugger;
    console.log(reqBody);
    //reqBody.instanceUserName='root';
    $.ajax({
     method: "POST",
     url: "/providers",
     data: formdata,  
     processData: false,
     contentType:false,
     success: function(data, success) {
              //alert('Successfully Saved ' + data);
              if (data!=500) {
                if ($('#btncancel').length){
                  $('#btncancel').click(); 
                }                
                removeLoader();
              }
              else{
               removeLoader();
               alert(data.toString());
             }
           },
           error: function(jqxhr) {
            removeLoader();
            bootbox.alert(jqxhr.status);
          },
          failure: function(data) {
            bootbox.alert(data);
          }
        });

  }


  function createTemplate(parentToAttach){
    var that=this,parentEl=$(parentToAttach).addClass('customTemplateParent');
    var getAddButton=function(classs){
      var title=''
      if(classs=='addRegion'){
        titile='title="Add New Region" data-placement="top"';
      }else if(classs=='addRow'){
        titile='title="Add New Key Pair" data-placement="top"';
      }
      return '<img src="img/add.png" class="addimage '+(classs ?classs :'')+'" '+ titile +' rel="tooltip" data-placement="top" />'
    },

    getRemoveButton=function(classs){
      var title=''
      if(classs=='removeRegion'){
        titile='title="Remove this Region" data-placement="top"';
      }else if(classs=='removeRow'){
        titile='title="Remove this Key Pair" data-placement="top"';
      }
      return '<img src="img/remove.png" class="removeimage '+(classs ?classs :'')+'" '+ titile +' rel="tooltip"  />'
    },
    getKeyValueList=function(){
      return '<div class="col-lg-6 col-md-6" style="width:47%;">'
      +'<label for="name">Select Key Pair:<span style="color:Red;" class="control-label">&nbsp;*</span></label>'
      +'<select id="'+UtilityMethods.getRandomNumber()+'" unique="true" uniqueconditionedby="orgname"  class="chooseOrganization width-100 keyvalue" '
      +'style="vertical-align:central" cat-validation="required" skiprowid="yes" cdata="catalyst">'
      +'  <option value="">Select Any Key Pair</option>'
      +'</div>' ;
    };
    var getRegion=function(){
      return  '<div class="row">'
      +'<div class="col-lg-6 col-md-6">'
      +'<label for="name">Region:<span style="color:Red;" class="control-label">&nbsp;*</span></label>'
      +'<select id="'+UtilityMethods.getRandomNumber()+'" unique="true" uniqueconditionedby="orgname"  class="region chooseOrganization width-100" style="'+'vertical-align:central" cat-validation="required" skiprowid="yes" cdata="catalyst">'
      +'<option value="">Select Region</option>'
      +'<option value="us-west-2">us-west-2</option>'
      +'</select>'
      +'</div></div>';
    };
    var getPemFileRow=function(){
      return '<div class="col-lg-6 col-md-6 authPemFile" style="display: block;"><div class="smart-forms"><label for="" style="margin-left:16px;">Upload .pem file for Provider<span style="color:Red;" class="control-label">&nbsp;*</span></label>'
      +'<label for="templatesicon" name="field" class="file">'
      +'<span class="button btn-primary btn-importbyIP" style="height:26px;line-height:22px;  padding: 1px '
      +'14px;position: absolute;right:4px;">Browse</span>'
      +'<input id="'+UtilityMethods.getRandomNumber()+'" type="file" class="gui-file file" cdata="catalyst" cat-validation="required">'
      +'<input type="text" readonly="" class="gui-input filename">'
      +'<input type="text" class="folderpath" style="visibility:hidden;" cdata="catalyst" />'
      +'</label></div></div>';
    };

    this.getRow=function(isAdd,isRemove,notrequired){
      var str='';
      if(isAdd){
        str=getAddButton('addRow');
      }else if(isRemove){
        str=getRemoveButton('removeRow');
      }else if(notrequired){
        str='';
      }
      return '<div class="row pemrow">'+getKeyValueList() + getPemFileRow() + str+'</div>';
    };

    this.getFinalTemplate=function(isAddApplicable,noOfRow){
      noOfRow=noOfRow ? parseInt(noOfRow) : 1;
      var str='';
      for(var i=0;i<noOfRow;i++){
        if(i==0){
          str=str+that.getRow(false,false,false);
        }else{
          str=str+that.getRow(false,false,false);
        }

      }
      return '<div class="addNewRegion">'+ (isAddApplicable ? getAddButton('addRegion') : getRemoveButton('removeRegion'))+getRegion() + str+'</div>'
    };

    $(parentEl).delegate('.addimage','click',function(){
      if($(this).hasClass('addRow')){
        $(this).parent().parent().append(that.getRow(false,true)).find('select').select2();
      }else if($(this).hasClass('addRegion')){
        $(this).parents('.customTemplateParent').append(that.getFinalTemplate()).find('select').select2();
      }
      UtilityMethods.initTooltip();
      bindChange_importPemFile();
    });

    $(parentEl).delegate('.removeimage','click',function(){
      if($(this).hasClass('removeRow')){
        $(this).parent().remove();

      }else if($(this).hasClass('removeRegion')){
        $(this).parent().remove();
      }
      UtilityMethods.initTooltip();
    });

  }


</script>