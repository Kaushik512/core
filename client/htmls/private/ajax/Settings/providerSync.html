<style>

  .table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
    border-top: 0px !important;
  }

  tr.show-settings:hover .settings{
    display:block;
  }

  div.settings{
    display:none;
    width: 32px;
    height: 18px;
  }

  .dropdown-content{
    border-radius: 5px;
      left: -30px;
      min-width: 98px;
      right: 0;
  }

  .show-settings input{
    border: 1px solid #999;
  }

  .show-settings input, span{
    height: 20px;
  }

  .marginSpaceTop {
     margin-top:20px;"
  }

</style>

<div class="clearfix"></div>
<ul class="nav nav-tabs " role="tablist">
  <li class="active"><a href="#organiz" role="tab" data-toggle="tab">Instances</a></li>
</ul>

<!-- Tab panes -->
<div  class="tab-content instancesListContainer">
  <div  class="tab-pane active tabContent table-responsive" id="instanceListDiv" >
    <table class="table table-hover table-bordered" id="instanceListTable" style="font-size:13px;margin-bottom:55px;text-align: center";>
    
    <thead>
      <tr>
        <th style="text-align: center">Name/Id</th>
        <th style="text-align: center">OS</th>
        <th style="text-align: center">IP Address</th>
        <th style="text-align: center">Region</th>
        <th style="text-align: center">Managed</th>
        <th style="text-align: center">status</th>
        <th style="text-align: center">Actions</th>
      </tr>
    </thead>
    <tbody>
      
      

    </tbody>
  </table>
   <footer class="footer">
      <div style="text-align:center" class="clearfix form-actions">
        <div>
            <input type="button" id="providerSyncBtn" style="margin-left:200px;" value="Import Instances" class="btn btn-primary showChefImportNodesModalBtn">
        </div>
      </div>
    </footer>
 

</div>

</div>  

<div class="modal fade" id="providerSyncModal" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="" id="myForm12" autocomplete="off">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Import Instance</h4>
      </div>
      <div class="modal-body modalbody-height">
         
          
          <div class="col-lg-6 marginSpaceTop">
            
              <label for="exampleInputEmail1">Organization</label>
              <div class="input-groups">
                <select id="providerSyncOrgSelect"  class="width-100 form-control" disabled>
                  
                </select>
                </div>
            
          </div>

          

          <div class="col-lg-6 marginSpaceTop">  
              <label for="exampleInputEmail1">Business Groups<span class="control-label redSpan">&nbsp;*</span></label>
          <div class="input-groups">
              
              <select id="providerSyncBgSelect"  class="width-100 form-control" cdata="catalyst" cat-validation="required" autofocus>

                
              </select>
            </div>
            
          </div>

        <div class="col-lg-6 marginSpaceTop" >
            <label for="exampleInputEmail1">Project<span class="control-label redSpan">&nbsp;*</span></label>
            <div class="input-groups">
              
              <select id="providerSyncProjectSelect"  class="width-100 form-control">
              </select></div>
            
          </div>
          
          
        <div class="col-lg-6 marginSpaceTop">
          
            <label for="exampleInputEmail1">Environment<span class="control-label redSpan">&nbsp;*</span></label>
            <div class="input-groups">
              <select id="providerSyncEnvSelect"  class="width-100 form-control" >
                    
              </select>
            </div>
          
        </div>

        <div class="col-lg-6 marginSpaceTop" >
          
            <label for="exampleInputEmail1">Config Management<span class="control-label redSpan">&nbsp;*</span></label>
            <div class="input-groups">
              <select id="providerSyncInfraManagerSelect"  class="width-100 form-control" >
                    
              </select>
            </div>
          
        </div>

          

          <div class="col-lg-6 credentialSection marginSpaceTop" >
        
            <label for="exampleInputEmail1">Username<span class="control-label redSpan">&nbsp;*</span></label>
           <div class="input-groups"> 
            <input type="text" name="importUsernameInput" class="form-control" id="importUsernameInput" required value="" autofocus>
              <b class="tooltip tooltip-top-right">
              <i class="fa fa-user txt-color-teal"></i> Please enter Instance Username</b>
          
           </div>
          </div>
      
          <div class="col-lg-6 marginSpaceTop" >
            <label for="">Choose Authentication Type</label>
            <div class="input-groups">
            <select id="pemFileDropdown2"  class="authenticationType width-100 form-control" cdata="catalyst" cat-validation="required">
              <option value="password">Password</option>
              <option value="pemFile">Pem File</option>
            </select>
          </div>
          
          </div>

          
      
     
      
      
      <div class="col-lg-6 credentialSection authPassword marginSpaceTop">
        
          <label for="exampleInputEmail1">Password</label>
           <div class="input-groups">
          <input type="password" class="form-control" id="importPasswordInput" required="true" cdata="catalyst" cat-validation="required"><span data-val-controltovalidate="orgname" id="MainContent_Req_orgname" data-val="true" data-val-initialvalue="" style="visibility:hidden;">Required</span>
            <b class="tooltip tooltip-top-right">
            <i class="fa fa-lock txt-color-teal"></i> Please enter Instance Password</b>
          </div>
        
      </div>

      <div class="col-lg-6 credentialSection authPemFile marginSpaceTop" >
        <div class="smart-forms">
            <label for="exampleInputEmail1">Pem File</label>
            <div class="input-groups">
            <label for="" name="field" class="file">
                <span class="button btn-primary">Browse</span>
                <input id="importPemfileInput" type="file" class="gui-file" onchange="$(this).next().val(this.files[0].name)">
                <input type="text" readonly="" class="gui-input">
            </label>
          </div>
        </div>
      </div>

     
      
    
    
         
      </div>
      <div class="modal-footer">
          <div class="marginForButtons">
            <label id="saveSpinner" class="hidden"><img  style="margin-left:5px;margin-right:25px;" src="img/select2-spinner.gif"></label>
          <a type="button" class="btn btn-default" data-dismiss="modal">Close</a>
          <button type="button" class="btn btn-primary importNodesBtn">Sync</button>
        </div>
      </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="providerSyncResultModal" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Importing Instances</h4>
      </div>
      <div class="modal-body">
      </div>
       <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->





<script type="text/javascript">





(function() {

  var urlParams = {};
  (window.onpopstate = function() {
    var url = window.location.href;
    var indexOfQues = url.lastIndexOf("?");
    if (indexOfQues != -1) {
      var sub = url.substring(indexOfQues + 1);
      console.log(sub);
      urlParams.providerId = sub;

    }

  })();

  var $orgListInput = $('#providerSyncOrgSelect').attr('disabled','disabled');
  var $bgList = $('#providerSyncBgSelect');
  var $projectList = $('#providerSyncProjectSelect');
  var $envList = $('#providerSyncEnvSelect');
  var $infraManagerList = $('#providerSyncInfraManagerSelect');

  $('#providerSyncBtn').click(function(e) {
    $('#saveSpinner').addClass('hidden');
    $('.importNodesBtn').removeAttr('disabled');
    var perm = haspermission('instancelaunch', 'execute');

    //alert(perm);
    if (!perm) {

      bootbox.alert('Insufficient permission to perform operation.');
      $('#chefImportNodesModal').modal('hide');
      return;
    } else {
      var $checkBoxes = $('.nodeCheckBox:checked');
      if (!$checkBoxes.length) {
        bootbox.alert('Please Choose instances first');
        return;
      }
      $('#providerSyncModal').modal('show');
      $('#myForm12').trigger("reset");
      $envList.empty();

      $('#pemFileDropdown2').change();
    }
  });

  $(".authPassword").show();
  $(".authPemFile").hide();
  $('.authenticationType').change(function(e) {
    if (this.value == "password") {
      $(".authPassword").show();
      $(".authPemFile").hide();
    } else {
      $(".authPassword").hide();
      $(".authPemFile").show();
    }
  });

  
   
   var serviceURL = "../d4dMasters/";

  function getRelatedValues_Top(jsonID, comparedField, filterByValue, outputField) {
    var result = [];
    readMasterJson_Top(jsonID);
    //formData = d4ddata.masterjson;
    //alert('Top' + JSON.stringify(d4ddata));
    if (d4ddata) {
      //alert('grvt:' + JSON.stringify(d4ddata))  ;
      $.each(d4ddata, function(k, v) {

        if (v[comparedField] == filterByValue && v[outputField]) {
          result.push(v['rowid'] + '|' + v[outputField]);
        }

      });

    }
    //alert(result.toString());
    return (result);
  }

  function getRelatedValues_Top_rowid(jsonID, comparedField, filterByValue, outputField) {
    var result = [];
    readMasterJson_Top(jsonID);
    //formData = d4ddata.masterjson;
    //alert('Top' + JSON.stringify(d4ddata));
    if (d4ddata) {
      //alert('grvt:' + JSON.stringify(d4ddata))  ;
      $.each(d4ddata, function(k, v) {

        if (v[comparedField] == filterByValue && v[outputField]) {
          var rowids = v[outputField + '_rowid'].split(',');
          var txts = v[outputField].split(',');
          for (var i = 0; i < txts.length; i++) {
            result.push(rowids[i] + '|' + txts[i]);
          }

        }

      });

    }
    //alert(result.toString());
    return (result);
  }


  function readMasterJson_Top(section) {
    //alert(serviceURL + "readmasterjsonnew/" + section);
    $.ajax({
      type: "get",
      dataType: "text",
      async: false,
      url: serviceURL + "readmasterjsonnew/" + section,
      success: function(data) {
        // alert(JSON.stringify(data));   
        d4ddata = JSON.parse(data);
      },
      failure: function(data) {
        alert(data.toString());
      }
    });
    return (d4ddata);
  }


  //loading provider with org
  $.get('/providers/' + urlParams.providerId, function(provider) {
    var org = provider.org

    $orgListInput.append($('<option></option>').val(org.rowid).html(org.orgname).attr('selected', 'selected'));

    $bgList.empty();
    $bgList.append($('<option></option>').val('choose').html('Choose'));
    //alert('Org Rowid' + data.orgname_rowid);
    var getBGs = getRelatedValues_Top(2, "orgname_rowid", org.rowid, "productgroupname");
    //alert('getBGs ' + JSON.stringify(getBGs));
    for (var i = 0; i < getBGs.length; i++) {
      if (getBGs[i].indexOf('|') >= 0) {
        var txtval = getBGs[i].split('|');
        $bgList.append($('<option></option>').val(txtval[0]).html(txtval[1]));
      }

    }



    $bgList.change(function(e) {
      var bgName = $(this).val();
      if (bgName == 'choose') {
        return;
      }
      $projectList.empty();
      $projectList.append($('<option></option>').val('choose').html('Choose'));

      var getProjs = getRelatedValues_Top(4, "productgroupname_rowid", bgName, "projectname");
      // alert(JSON.stringify(getProjs));
      for (var i = 0; i < getProjs.length; i++) {
        if (getProjs[i].indexOf('|') >= 0) {
          var txtval = getProjs[i].split('|');
          $projectList.append($('<option></option>').val(txtval[0]).html(txtval[1]));
        }
      }
    });
    $projectList.change(function(e) {
      var projName = $(this).val();
      if (projName == 'choose') {
        return;
      }
      var getEnvs_ = getRelatedValues_Top_rowid(4, "rowid", projName, "environmentname");
      //debugger;
      //alert(JSON.stringify(getEnvs_));
      var getEnvs = getEnvs_.toString().replace(/"/g, '').split(',');
      // alert(getEnvs.length);
      // var getEnvs = JSON.parse(getEnvs_);
      for (var i = 0; i < getEnvs.length; i++) {
        if (getEnvs[i].indexOf('|') >= 0) {
          var txtval = getEnvs[i].split('|');
          $envList.append($('<option></option>').val(txtval[0]).html(txtval[1]));
          // alert('Env: ' + txtval[0] + ' ' +  txtval[1]);
        }
      }
    });
    // loading inframanagers 
    $.get(serviceURL + 'organization/' + org.rowid + '/configmanagement/list', function(configMgmntList){
      var $configManagementDropdown = $('#providerSyncInfraManagerSelect');
      for (var i = 0; i < configMgmntList.length; i++) {
        var $options = $('<option></option>');
        var name;
        if (configMgmntList[i].configType === 'puppet') {
          name = configMgmntList[i].puppetservername;
        } else {
          name = configMgmntList[i].configname;
        }
        $options.html(name);
        $options.val(configMgmntList[i].rowid);
        $configManagementDropdown.append($options);
      }
    });

  });
 


  




  var $tbody = $('#instanceListTable tbody');
  function loadManagedInstances(managnedData) {

    for(var i=0;i<managnedData.length;i++) {
      var $tr = $('<tr></tr>');
      var $tdId = $('<td></td>').append(managnedData[i].platformId);
      $tr.append($tdId);

      var $tdOs = $('<td></td>').append(managnedData[i].hardware.os);
      $tr.append($tdOs);

      var $tdIpAddress = $('<td></td>').append(managnedData[i].instanceIP);
      $tr.append($tdIpAddress);


      var region = ''; 
      if(managnedData[i].providerData && managnedData[i].providerData.region) {
        region = managnedData[i].providerData.region;
      } 
      var $tdRegion = $('<td></td>').append(region);
      $tr.append($tdRegion);

      var $tdIsManagd = $('<td></td>').css({
        'background-color': 'green'
      });
      $tr.append($tdIsManagd);

      var $tdStatus = $('<td></td>').append(managnedData[i].instanceState);
      $tr.append($tdStatus);

      var $button = '';
      
      if (managnedData[i].instanceState === 'terminated') {
       
        $button = $('<input type="button">').val('Delete').attr('id', managnedData[i]._id);;
        $button.click(function() {
          var id = $(this).attr('id');
          $.ajax({
            method: 'DELETE',
            url: '/instances/' + id,
            success: function() {
              $tr.remove();
            },
            error: function() {
              alert('unable to delete instance');
            }
          });

        });

      }

      
      var $tdAction = $('<td></td>').append($button);
      $tr.append($tdAction);

      $tbody.append($tr);
    }

  }

  function loadUnmanagedInstances(unManagnedData) {

    for(var i=0;i<unManagnedData.length;i++) {
      var $tr = $('<tr></tr>').attr('instanceId',unManagnedData[i]._id);
      var $tdId = $('<td></td>').append(unManagnedData[i].platformId);
      $tr.append($tdId);

      var $tdOs = $('<td></td>').append(unManagnedData[i].os);
      $tr.append($tdOs);

      var $tdIpAddress = $('<td></td>').append(unManagnedData[i].ip);
      $tr.append($tdIpAddress);
      
      var region = ''; 
      if(unManagnedData[i].providerData && unManagnedData[i].providerData.region) {
        region = unManagnedData[i].providerData.region;
      } 
      var $tdRegion = $('<td></td>').append(region);
      $tr.append($tdRegion);


      var $tdIsManagd = $('<td></td>').css({
        'background-color':'red'
      }).append(false);
      $tr.append($tdIsManagd);

      var $tdStatus = $('<td></td>').append(unManagnedData[i].state);
      $tr.append($tdStatus);
      var $input = '';
      if(unManagnedData[i].state === 'running') {
        $input = $('<input class="nodeCheckBox" type="checkbox">').val(unManagnedData[i]._id);
      }
 
      var $tdAction = $('<td></td>').append($input);
      $tr.append($tdAction);

      $tbody.append($tr);
    }

  }

  //loading Data
  $.get('/providers/' + urlParams.providerId + '/managedInstances', function(managedInstances) {
    
    loadManagedInstances(managedInstances);
    $.get('/providers/' + urlParams.providerId + '/unmanagedInstances', function(unmanagnedInstances) {
      loadUnmanagedInstances(unmanagnedInstances);
      $('#instanceListDiv').show();

    });
  });


  $('.importNodesBtn').click(function(e) {
    var $checkBoxes = $('.nodeCheckBox:checked');
    var reqBody = {};
    reqBody.orgId = $orgListInput.val();
    reqBody.bgId = $bgList.val();
    reqBody.projectId = $projectList.val();
    reqBody.envId = $envList.val();
    reqBody.configManagmentId = $infraManagerList.val();


    if (!((reqBody.bgId && reqBody.bgId.length) && (reqBody.projectId && reqBody.projectId.length) && reqBody.projectId !== 'choose' && reqBody.bgId !== 'choose')) {
      alert('Please Select a Business Group & Project');
      return;
    }



    reqBody.instanceIds = [];
    $checkBoxes.each(function() {
      reqBody.instanceIds.push($(this).val());
    });

    reqBody.credentials = {};
    reqBody.credentials.username = $('#importUsernameInput').val();

    var $dropdown = $('#pemFileDropdown2');
    if (!($dropdown.val() === 'pemFile')) {
      reqBody.credentials.password = $('#importPasswordInput').val();
      if (!reqBody.credentials.username) {
        alert('Please Enter Username');
        return;
      }
      if (!reqBody.credentials.password) {
        alert('Please Enter Password or Choose a Pem file');
        return;
      }
      // reqBody.users = $('#userListSelect').val();
      // if (!reqBody.users || !reqBody.users.length) {
      //   alert('Please Choose Users');
      //   return;
      // }
      // console.log(reqBody);

      makeRequest();
    } else {
      var pemFileInput = $('#importPemfileInput').get(0);
      if (!reqBody.credentials.username) {
        alert('Please Enter Username');
        return;
      }
      if (!pemFileInput.files.length) {
        alert('Please Choose a Pem file');
        return;
      }

      // reqBody.users = $('#userListSelect').val();
      // if (!reqBody.users || !reqBody.users.length) {
      //   alert('Please Choose Users');
      //   return;
      // }
      var reader = new FileReader();
      reader.onload = function(e) {
        // Render thumbnail.
        reqBody.credentials.pemFileData = e.target.result;

        makeRequest();

      };
      // Read in the image file as a data URL.
      reader.readAsText(pemFileInput.files[0]);

    }

    function makeRequest() {
      $('#saveSpinner').removeClass('hidden');
      $('.importNodesBtn').attr('disabled', 'disabled');
      console.log(reqBody);
      $.post('../providers/' + urlParams.providerId + '/sync', reqBody, function(data) {
        console.log(data);
         $('#providerSyncModal').modal('hide');
        var $chefResultModalContainer = $('#providerSyncResultModal');
        var $modalBody = $chefResultModalContainer.find('.modal-body');
        $modalBody.empty();
        var $progressBar = $('<progress value="0" max="' + reqBody.instanceIds.length + '"></progress>').css({
          width: '100%'
        });
        var $msgDiv = $('<div class="messageDiv"></div>').css({
          width: '100%'
        });

        $modalBody.append($progressBar).append($msgDiv);
        $('#saveSpinner').addClass('hidden');

        $('#chefImportNodesModal').modal('hide');
        $chefResultModalContainer.modal('show');
        var timeout;
        var count = 0;

        function pollTaskStatus(taskId, timestamp) {
          timeout = setTimeout(function() {
            $.get('../taskstatus/' + taskId + '/status?timestamp=' + timestamp, function(data) {
              console.log(data);
              if (!data.completed) {
                if (data.statusList && data.statusList.length) {

                  $progressBar.val(data.statusList.length);
                  $msgDiv.empty();
                  for (var i = 0; i < data.statusList.length; i++) {
                    $msgDiv.append($('<div></div>').append(data.statusList[i].status.message));
                  }

                  pollTaskStatus(taskId, data.statusList[data.statusList.length - 1].timestamp);
                } else {
                  pollTaskStatus(taskId, timestamp);
                }
              } else {
                if (data.statusList && data.statusList.length) {
                  $progressBar.val(data.statusList.length);
                  $msgDiv.empty();
                  for (var i = 0; i < data.statusList.length; i++) {
                    $msgDiv.append($('<div></div>').append(data.statusList[i].status.message));
                  }
                }
                $progressBar.val(reqBody.selectedNodes.length);
                if (reqBody.selectedNodes.length) {

                  var nodeData = $($checkBoxes[0]).data('node');
                  if (nodeData && nodeData.chef_environment) {
                    //$chefResultModalContainer.modal('hide');
                    //window.location.href = '#ajax/Dev.html?org='+reqBody.orgId+'&projid='+reqBody.projectId+'&envid='+nodeData.chef_environment;
                  }
                }
              }
            })
          }, 1000);

        }
        pollTaskStatus(data.taskId, 0);
        //Refreshing the workzone tree

      }).error(function() {
        alert('Unable to import instances. Please try again later');
      });
    }

  });

  
})();
</script>