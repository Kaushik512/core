<div class="row">
    
        <div class="col-md-12">

            <div class="widget-box">
                <div class="widget-header">
                    <h5 class="widget-title" style="color:#4e5964;">
                        <strong>List of Dashboards</strong>
                    </h5>
                    <div class="widget-toolbar no-border">
                        <div>

                          
                        <a href="#modalForTrackEdit" data-backdrop="false" data-toggle="modal" class="btn btn-minier btn-primary addDashboardItem">
                            <i class="ace-icon ace-icon fa fa-plus bigger-110"></i>&nbsp;New
                        </a>                                                                                                            
                    </div>
                </div>

            </div>
            <div class="widget-body">
                <div class="widget-main" style="min-height:300px">
                    <div class="col-md-12 table-responsive" style="padding-left:0px; padding-right:0px;">
                         
                          
                         <table id="trackTable" class="tableData table table-striped table-bordered table-hover dataTable no-footer" cellpadding="5px" style="text-align:center;">
                             
                                <thead>
                                    <tr class="rowCustomStyle">
                                        <td>S.No</td>
                                        <td>Name</td>
                                        <td>Description</td>
                                        <td>Action</td>
                                    </tr>
                                </thead>
                                <tbody id="trackTableInput">
                
                                </tbody>
                                    
                            </table>
                          
                        
                    </div>
                </div> <!--widget main ends here-->
              </div> <!--widget body ends here-->
            </div> <!--widget box ends here-->  
        </div>
    
</div>              

<!--modal for ItemList-->
<div class="modal fade" id="modalForTrackEdit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
   <div class="modal-dialog " style="">
      <div class="modal-content">
         <form role="form" id="trackItemUrl">
            <div class="modal-header">
               <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
               <h4 class="modal-title">Create A Dashboard Item
               </h4>
            </div>
            <div class="modal-body" style="height:300px;">
               <div class="col-lg-12 col-md-12">
                  <label for="">Name:</label>
                  <input autofocus type="text" name="trackName" class="trackName form-control" id="trackName"/>
               </div>
               <div class="col-lg-12 col-md-12 margintop15">
                  <label for="">URL:</label>
                  <input type="url" name="trackUrl" class="trackUrl form-control" id="trackUrl"/> 
               </div>
               <div class="col-lg-12 col-md-12 margintop15">
                  <label for="">Description:</label>
                  <textarea rows="5" cols="64" name="trackDescription" class="trackDescription" id="trackDescription"></textarea>
               </div>
                <input type="hidden" id="trackEditHiddenInputId">
               <!-- <input type="hidden" id="trackUrlHiddenName">
               <input type="hidden" id="trackNameHidden"> -->
               <input type="hidden" id="trackEditHiddenInput">
            </div>
            <div class="modal-footer">
               <label id="saveItemSpinner" class="hidden"><img  style="margin-left:5px;margin-right:25px;" src="img/select2-spinner.gif"></label>
               <a type="button" class="btn btn-default" data-dismiss="modal"><i class="ace-icon fa fa-times bigger-110"></i>&nbsp;Close</a>
               <button type="submit" id="saveBtnTrack" class="btn btn-primary" value="Save"><i class="ace-icon fa fa-check bigger-110"></i>&nbsp;Save</button>
            </div>
         </form>
      </div>
   </div>
</div>
<!--modal for Itemlist-->   


<script>

//initialising the datatable...
if (!$.fn.dataTable.isDataTable('#trackTable')) {
    //var $taskListArea = $('.taskListArea').empty();
    var $trackDatatable = $('#trackTable').DataTable({
        "pagingType": "full_numbers",
        "bInfo": false,
        "bLengthChange": false,
        "paging": false,
        "bFilter": false,
        "aoColumns": [{
            "bSortable": true
        }, {
            "bSortable": false
        }, {
            "bSortable": false
        }, {
            "bSortable": false
        }],
        "fnRowCallback": function(nRow, aData, iDisplayIndex) {
            $("td:first", nRow).html(iDisplayIndex + 1);
            return nRow;
        }

    });
}

//calling the global track functionality when track params are available..
$(document).ready(function(e) {
    getGlobalTrack();
});

//to show the focus on first input ....
$(document).on('shown.bs.modal', function(e) {
    $('[autofocus]', e.target).focus();
});


//this is a functionality to get the list of global track items that have been created....
function getGlobalTrack() {
    //for getting the list of tracks

    var trackUrlDetails = '../track';
    $.get(trackUrlDetails, function(data) {

        console.log(data);
        if (data && data.length) {
            for (var kk = 0; kk < data.length; kk++) {
                createTableForTrack(data[kk]);
            }
        }


    }).fail(function(jxhr) {
        var msg = "Server Behaved Unexpectedly";
        if (jxhr.responseJSON && jxhr.responseJSON.message) {
            msg = jxhr.responseJSON.message;
        } else if (jxhr.responseText) {
            msg = jxhr.responseText;
        }
        bootbox.alert(msg);
    });
};


//creating a table for showcasing the list of track items on the dashboard page..
function createTableForTrack(trackData) {
    var $trackNameList = $('#trackTableInput');
    var $tr = $('<tr class="trackItemRow"></tr>').attr('data-trackId',trackData._id);
    $tr.data('trackData', trackData);
    var $tdSerial = $('<td/>');
    var $tdDescription = $('<td class="trackDescription">' + trackData.description + '</td>');
    var $tdName = $('<td class="trackName"><a title="' + trackData.url + '" target="_blank" href="' + trackData.url + '">' + trackData.name + '</a></td>');
    var $tdAction = $('<td/>');

    $tdAction.append('<div class="btn-group"><button class="btn btn-info pull-left btn-sg tableactionbutton editRowTrackUrl" data-placement="top" value="Update" title="Edit"><i class="ace-icon fa fa-pencil bigger-120"></i></button></div>').append('<div style="margin-left:14px;" class="btn-group"><button class="btn btn-danger pull-left btn-sg tableactionbutton globalTrackUrlRemove" data-placement="top" value="Remove" title="Delete"><i class="ace-icon fa fa-trash-o bigger-120"></i></button></div>');
    $tr.append($tdSerial).append($tdName).append($tdDescription).append($tdAction);
    $trackNameList.append($tr);
    $trackDatatable.row.add($tr).draw();

    //for editing track items from the table...
    $tdAction.find('button.editRowTrackUrl').click(function() {
       // var trackUrlData = $tr.data('trackData');
        var datatrackId = $tr.data('data-trackId');
        var $editModal = $('#modalForTrackEdit');
        $('textarea#trackDescription').val('');
        $editModal.modal('show');
        $editModal.find('#trackEditHiddenInput').val('edit');
        $editModal.find('h4.modal-title').html('Edit URL for &nbsp;-' + trackData.name);
        $editModal.find('#trackName').val(trackData.name);
        $editModal.find('#trackUrl').val(trackData.url);
        $editModal.find('textarea#trackDescription').val(trackData.description);
        $editModal.find('#trackEditHiddenInputId').val(trackData._id);
        alert(trackData._id);
        return false;
    });

    //for deletion of track items from the table..
    $tdAction.find('button.globalTrackUrlRemove').click(function() {

        var $this = $(this);
        var $tr = $this.parents('tr.trackItemRow');
        var trackIdDelete = $('#trackEditHiddenInputId').val();
        bootbox.confirm('Are you sure you want to Delete Dashboard Url -&nbsp;' + name, function(result) {
            if (result) {
                $.ajax({
                    url: '../track/' + trackIdDelete,
                    method: 'DELETE',
                    success: function() {
                        $trackDatatable.row($tr).remove().draw(false);

                    },
                    error: function(jxhr) {
                        alert(result);
                        var msg = "Unable to Delete URL please try again later";
                        if (jxhr.responseJSON && jxhr.responseJSON.message) {
                            msg = jxhr.responseJSON.message;
                        } else if (jxhr.responseText) {
                            msg = jxhr.responseText;
                        }
                        bootbox.alert(msg);
                    }
                });
            }
        });
        return false;
    });
};

//when the user clicks on the new button the setting the value to 'new' for the hidden field to know that user is creating the new item..
$('.addDashboardItem').click(function(e) {
    $('#trackEditHiddenInput').val('new');
});

//save form for creating a new Dashboard item and updation of the item(name,url & description)..
$('#trackItemUrl').submit(function(e) {
    $('#saveItemSpinner').removeClass('hidden');
    var $form = $('#trackItemUrl');
    var trackUrlNameDes = [];
    var trackData = {};
    trackData.name = $form.find('#trackName').val().trim();
    trackData.url = $form.find('#trackUrl').val().trim();
    trackData.description = $form.find('#trackDescription').val().trim();
    var dashboardEditNew = $(this).find('#trackEditHiddenInput').val();
    var trackId = $form.find('#trackEditHiddenInputId').val();
    
   // alert(trackId);
    var url;

    var reqBody = {
        trackUrlNameDes: [trackData]
    }

    //for edit
    if (dashboardEditNew === 'edit') {
        console.log(dashboardEditNew);
        url = '../track/' + trackId + '/update';
        reqBody = {
            "name": trackData.name,
            "url": trackData.url,
            "description": trackData.description
        };
    } else {
        url = '../track';
        reqBody = {
            "name": trackData.name,
            "url": trackData.url,
            "description": trackData.description
        };
    }

    $.ajax({
        method: "POST",
        url: url,
        data: {
            trackData: reqBody
        },
        success: function(data, success) {
            alert(JSON.stringify(reqBody));
            console.log("data>>>>>>>" + JSON.stringify(data));
            $('#modalForTrackEdit').modal('hide');
            $('#saveItemSpinner').addClass('hidden');
            $('#saveBtnTrack').removeAttr('disabled');
            console.log(dashboardEditNew);
            
            if (dashboardEditNew === 'new') {
                createTableForTrack(data);
                $('#saveBtnTrack').removeAttr('disabled');
            }else{
                console.log(dashboardEditNew);
                var $tr = $('tr[data-trackId="' + trackId + '"]');
                 $tr.find('.trackName').html('<a style="word-break:break-word;" href="' + reqBody.url + '" target="_blank">' + reqBody.name + '</a> ');
                 $tr.find('.trackDescription').html(reqBody.description);
                 $tr.data('trackData', {
                     _id: trackId,
                     name: reqBody.name,
                     url: reqBody.url,
                     description: reqBody.description
                 })
            }
        },
        error: function(jxhr) {
            console.log(jxhr);
            var msg = "Server Behaved Unexpectedly";
            if (jxhr.responseJSON && jxhr.responseJSON.message) {
                msg = jxhr.responseJSON.message;
            } else if (jxhr.responseText) {
                msg = jxhr.responseText;
            }
            bootbox.alert(msg);

            $('#saveItemSpinner').addClass('hidden');
            $('#saveBtnTrack').removeAttr('disabled');
        },
        failure: function(jxhr) {
            console.log(jxhr);
            var msg = "Server Behaved Unexpectedly";
            if (jxhr.responseJSON && jxhr.responseJSON.message) {
                msg = jxhr.responseJSON.message;
            } else if (jxhr.responseText) {
                msg = jxhr.responseText;
            }
            bootbox.alert(msg);

            $('#saveItemSpinner').addClass('hidden');
            $('#saveBtnTrack').removeAttr('disabled');
        }
    });
    return false;
});
</script>
                             