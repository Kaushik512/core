<style>
  .table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
    border-top: 0px !important;
  }

  tr.show-settings:hover .settings{
    display:block;
  }

  div.settings{
    display:none;
    width: 32px;
    height: 18px;
  }
  .dropdown-content{
    border-radius: 5px;
      left: -30px;
      min-width: 98px;
      right: 0;
  }
  .show-settings input{
    border: 1px solid #999;
  }
  .show-settings input, span{
    height: 20px;
  }

</style>

<div class="clearfix"></div>
<ul class="nav nav-tabs " role="tablist">
  <li class="active"><a href="#organiz" role="tab" data-toggle="tab">Nodes</a></li>
</ul>

<!-- Tab panes -->
<div  class="tab-content nodeListContainer">
  <div  class="tab-pane active tabContent table-responsive" id="organiz" style="display:none">
    <table class="table table-hover table-bordered" style="font-size:13px;margin-bottom:55px";>
    
    <thead>
      <tr>
        <th style="text-align: center">Node Name</th>
        <th style="text-align: center">IP Address</th>
        <th style="text-align: center">FQDN</th>
        <th style="text-align: center">Platform</th>
        <th style="text-align: center">Uptime</th>
      
        <th style="text-align: center">Environment</th>
      
        <th style="text-align: center">Actions</th>
      </tr>
    </thead>
    <tbody>
  

    </tbody>
  </table>
   <footer class="footer">
      <div style="text-align:center" class="clearfix form-actions">
        <div>
            <input type="button" style="margin-left:200px;" value="Import Nodes" class="btn btn-primary showChefImportNodesModalBtn">
        </div>
      </div>
    </footer>
  <!-- <div style="text-align:center"> <input type="button" class="btn btn-primary showChefImportNodesModalBtn" value="Import Nodes"/> </div> -->

</div>

</div>  

<div class="modal fade" id="chefImportNodesModal" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="" autocomplete="off">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Import Nodes</h4>
      </div>
      <div class="modal-body modalbody-height">
         
          
          <div class="col-lg-6">
            
              <label for="exampleInputEmail1">Organization</label>
                <select id="chefImportOrgSelect"  class="width-100 aaa" disabled>
                  
                </select>
            
          </div>

          <div class="col-lg-6 credentialSection">
        
            <label for="exampleInputEmail1">Username<span style="color:Red;" class="control-label">&nbsp;*</span></label>
            
            <input type="text" name="importUsernameInput" class="form-control" id="importUsernameInput" required value="">
              <b class="tooltip tooltip-top-right">
              <i class="fa fa-user txt-color-teal"></i> Please enter Instance Username</b>
          
        
          </div>

          <div class="col-lg-6" style="margin-top:20px;">  
              <label for="exampleInputEmail1">Business Groups<span style="color:Red;" class="control-label">&nbsp;*</span></label>
              <select id="chefImportBgSelect"  class="width-100 aaaaa" cdata="catalyst" cat-validation="required">
                
              </select>
            
          </div>

          <div class="col-lg-6" style="margin-top:20px;">
          
            <label for="">Choose Authentication Type</label>
            <select id="pemFileDropdown"  class="authenticationType width-100" cdata="catalyst" cat-validation="required">
              <option value="password">Password</option>
              <option value="pemFile">Pem File</option>
            </select>
          
          </div>

          <div class="col-lg-6" style="margin-top:20px;">
            <label for="exampleInputEmail1">Project<span style="color:Red;" class="control-label">&nbsp;*</span></label>
            
              <select id="chefImportProjectSelect"  class="width-100">
              </select>
            
        </div>
      
      <div class="col-lg-6" style="display:none">
        
          <label for="exampleInputEmail1">Provider</label>
          
          <select id="chefImportProviderSelect"  class="form-control" cat-validation="required">
                
          </select>
        
        
      </div>
      
      
      <div class="col-lg-6 credentialSection authPassword" style="margin-top:20px;">
        
          <label for="exampleInputEmail1">Password</label>
          
          <input type="password" class="form-control" id="importPasswordInput" required="true" cdata="catalyst" cat-validation="required"><span data-val-controltovalidate="orgname" id="MainContent_Req_orgname" data-val="true" data-val-initialvalue="" style="visibility:hidden;">Required</span>
            <b class="tooltip tooltip-top-right">
            <i class="fa fa-lock txt-color-teal"></i> Please enter Instance Password</b>
          
        
      </div>

      <div class="col-lg-6 credentialSection authPemFile" style="margin-top:20px;">
        <div class="smart-forms">
            <label for="exampleInputEmail1">Pem File</label>
            <label for="" name="field" class="file">
                <span class="button btn-primary">Browse</span>
                <input id="importPemfileInput" type="file" class="gui-file">
                <input type="text" readonly="" class="gui-input">
            </label>
        </div>
      </div>

     
      <div class="col-lg-6" style="margin-top:20px;">
          <label class="">Assign Users<span style="color:Red;" class="control-label">&nbsp;*</span></label>
          
              <div class="userListLoadingContainer"></div>
              <select class="custom-scroll" multiple="" id="userListSelect" style="display:none" cdata="catalyst" cat-validation="required">
                  <option value="1">User1</option>
                  <option value="2">User2</option>
                  <option value="3">User3</option>
                  <option value="4">User4</option>
                  <option value="5">User5</option>
              </select> 
          
      </div>
    
    
         
      </div>
      <div class="modal-footer">
        <a type="button" class="btn btn-default" data-dismiss="modal">Close</a>
        <button type="button" class="btn btn-primary importNodesBtn">Import</button>
      </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="chefImportNodesResultModal" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Importing Nodes</h4>
      </div>
      <div class="modal-body">
      </div>
       <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">
$(document).ready(function() {
   $('.authenticationType').select2();
   $('#chefImportBgSelect').select2();
   $('#chefImportProjectSelect').select2();
 });
$(".authPassword").show();
$(".authPemFile").hide();
$('.authenticationType').change(function(e) {
    if (this.value == "password") {
        $(".authPassword").show();
        $(".authPemFile").hide();
    } else {
        $(".authPassword").hide();
        $(".authPemFile").show();
    }
});



drawBreadCrumb1();
var urlParams ={};
(window.onpopstate = function () {
  var url = window.location.href;
  var indexOfQues = url.lastIndexOf("?");
  if(indexOfQues!=-1) {
  var sub =  url.substring(indexOfQues+1);
   console.log(sub);
  urlParams.chefId = sub;
  
 }
     
})();
$(function(){

var $orgListInput = $('#chefImportOrgSelect');
var $bgList = $('#chefImportBgSelect');
var $projectList = $('#chefImportProjectSelect');


$('.nodeListContainer').append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');

$.get('../chef/servers/'+urlParams.chefId,function(data){
   console.log('chefServer ==>',data);
   $orgListInput.append($('<option></option>').val(data.orgname).html(data.orgname).attr('selected','selected'));
   $orgListInput.select2();
    var getProviders = getRelatedValues_Top(9, "providername", '', "providername");
    var $providerlist = $('#chefImportProviderSelect');
    $providerlist.append($('<option></option>').val('choose').html('Choose'));
    for(var i=0;i<getProviders.length;i++) {
      $providerlist.append($('<option></option>').val(getProviders[i]).html(getProviders[i]));
    }
    $providerlist.append($('<option></option>').val('azure').html('Azure Data Center'));
    $providerlist.append($('<option></option>').val('datacenter').html('Data Center'));

     $providerlist.change(function(e){
      var val = $providerlist.val();
      if(val == 'datacenter' || val == 'azure') {
         $('.credentialSection').show();
      } else {
         $('.credentialSection').hide();
      }


     });
   
    $bgList.empty();
    $bgList.append($('<option></option>').val('choose').html('Choose'));
    var getBGs = getRelatedValues_Top(2, "orgname",data.orgname, "productgroupname"); 
    for(var i=0;i<getBGs.length;i++) {
        $bgList.append($('<option></option>').val(getBGs[i]).html(getBGs[i]));
    }


    
    $bgList.change(function(e){
      var bgName = $(this).val();
      if(bgName == 'choose') {
          return;
      }
      $projectList.empty();
      $projectList.append($('<option></option>').val('choose').html('Choose'));

      var getProjs = getRelatedValues_Top(4, "productgroupname", bgName, "projectname");
      for(var i=0;i<getProjs.length;i++) {
         $projectList.append($('<option></option>').val(getProjs[i]).html(getProjs[i]));
      }
    });

  $.get('../chef/servers/'+urlParams.chefId+'/nodes',function(nodeList){
    $('.nodeListContainer img').remove();

    var $tableBody = $('.table-hover tbody');
    

    for(var i=0;i<nodeList.length;i++) {
       var $tr = $('<tr></tr>').addClass('show-settings').attr('data-nodeName',nodeList[i]);
       $tr.append($('<td></td>').addClass('chef-nodeName').append(nodeList[i]));
       $tr.append($('<td></td>').addClass('chef-ip').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
       $tr.append($('<td></td>').addClass('chef-fqdn').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
       $tr.append($('<td></td>').addClass('chef-platform').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
       $tr.append($('<td></td>').addClass('chef-uptime').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
    
       $tr.append($('<td></td>').addClass('chef-env').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
       $nodecheckboxlabel = $('<label></label>').addClass('checkbox');
       $nodecheckboxinput = $('<input class="nodeCheckBox smart-form" data-nodeName="'+nodeList[i]+'" type="checkbox" name="nodesChecked"/><i></i>');
       $nodecheckboxlabel.append($nodecheckboxinput);

       // $tr.append($('<td></td>').addClass('chef-checkbox').append($('<input class="nodeCheckBox" data-nodeName="'+nodeList[i]+'" type="checkbox" name="nodesChecked"/>'))); 
       $tr.append($('<td></td>').addClass('chef-checkbox smart-form').append($nodecheckboxlabel)); 
       $tableBody.append($tr);  

       $.get('../chef/servers/'+urlParams.chefId+'/nodes/'+nodeList[i],function(node){
           var $tr = $tableBody.find('tr[data-nodeName="'+node.name+'"]');
            var ip = 'unknown';
            if(node.automatic.ipaddress) {
                ip = node.automatic.ipaddress;
            }
            $tr.find('.chef-ip').empty().append('<span>'+ip+'</span>');

            var fqdn = 'unknown';
            if(node.automatic.fqdn) {
                fqdn = node.automatic.fqdn;
            }
            $tr.find('.chef-fqdn').empty().append('<span>'+fqdn+'</span>');
            var platform = 'unknown';
            if(node.automatic.platform) {
                platform = node.automatic.platform;
            }
            $tr.find('.chef-platform').empty().append('<span>'+platform+'</span>');

            var uptime = 'unknown';
            if(node.automatic.uptime) {
                uptime = node.automatic.uptime;
            }
            $tr.find('.chef-uptime').empty().append('<span>'+uptime+'</span>');


           
            
            var environment = 'unknown';
            if(node.chef_environment) {
                environment = node.chef_environment;
            }

            $tr.find('.chef-env').empty().append('<span>'+environment+'</span>');
            $tr.find('.nodeCheckBox').data('node',node);
            
            
         });


    }


    $('#organiz').show();

  });



});

  var serviceURL = "../d4dMasters/";
          function getRelatedValues_Top(jsonID, comparedField, filterByValue, outputField) {
                var result = [];
                readMasterJson_Top(jsonID);
                //formData = d4ddata.masterjson;
                //alert('Top' + JSON.stringify(d4ddata));
                if(d4ddata){
                  $.each(d4ddata,function(k,v){
                   // alert('k:' + k + ' v:' + v);
                    if(v[comparedField] == filterByValue && v[outputField]){
                      result.push(v[outputField]);
                    }
                  });

                }
                return (result);
            }
          

          function getRelatedValues_Top__old(jsonID, comparedField, filterByValue, outputField) {
                var result = [];

                readMasterJson_Top(jsonID);
                formData = d4ddata.masterjson;
                // var comparedField = "orgname";
                //  var filterByValue = "Scholastic";
                //  var outputField = "productgroupname";
                
                //debugger;
                $.each(eval(formData.rows.row), function (i, item) {
                    $.each(item.field, function (k, item1) {

                        if (item1.name == comparedField && (item1.values.value == filterByValue || filterByValue == '')) {
                            // alert(item1.values.value);
                            //found the row, now get the next column
                           // debugger;
                            $.each(item.field, function (j, item2) {
                                if (item2.name == outputField) {
                                    //  alert(item2.values.value);
                                    result.push(item2.values.value);
                                }
                            });
                        }
                    });
                });
                //alert(jsonID + ' ' + result.toString());
                return (result);
            }
            function readMasterJson_Top_old(section) {

                $.ajax({
                    type: "get",
                    dataType: "text",

                    async: false,
                    url: serviceURL + "readmasterjson/" + section,
                    success: function (data) {
                        // alert(data.toString());   
                        d4ddata = JSON.parse(data);
                    },
                    failure: function (data) {
                        alert(data.toString());
                    }
                });
                return (d4ddata);
            }

            function readMasterJson_Top(section) {

                $.ajax({
                    type: "get",
                    dataType: "text",

                    async: false,
                    url: serviceURL + "readmasterjsonnew/" + section,
                    success: function (data) {
                        // alert(data.toString());   
                        d4ddata = JSON.parse(data);
                    },
                    failure: function (data) {
                        alert(data.toString());
                    }
                });
                return (d4ddata);
            }


$('.showChefImportNodesModalBtn').click(function(e){
   var $checkBoxes = $('.nodeCheckBox:checked');
   if(!$checkBoxes.length) {
        alert('Please Choose nodes first');
        return; 
   }
  $('#chefImportNodesModal').modal('show');
});
$('#importPemfileInput').change(function(){
    //console.log(this.files);
    $(this).next().val(this.files[0].name);
});
 $('.importNodesBtn').click(function(e){
   var $checkBoxes = $('.nodeCheckBox:checked');
   var reqBody = {};
   reqBody.orgId = $orgListInput.val();
   reqBody.bgId = $bgList.val();
   reqBody.projectId = $projectList.val();
   /*if(!reqBody.bgId || !reqBody.bgId.length){
    alert('Please Select Business Groups & Project');
    return;
   }*/
   if (!reqBody.projectId || reqBody.projectId === 'choose'){
    alert('Please Select a Project');
    return;
   }
   

   reqBody.selectedNodes = [];
   $checkBoxes.each(function(){
     reqBody.selectedNodes.push($(this).attr('data-nodeName'));
   });
 
     reqBody.credentials = {};
     reqBody.credentials.username = $('#importUsernameInput').val();

    var $dropdown = $('#pemFileDropdown');
    if (!($dropdown.val()==='pemFile')) {
       reqBody.credentials.password = $('#importPasswordInput').val();
       if(!reqBody.credentials.username){
         alert('Please Enter Username');
         return;
       } if(!reqBody.credentials.password) {
         alert('Please Enter Password or Choose a Pem file');
         return;
       }
       reqBody.users = $('#userListSelect').val();
        if(!reqBody.users || !reqBody.users.length) {
        alert('Please Choose Users');
        return;
       }
       console.log(reqBody);
       makeRequest();
     } else {
       var pemFileInput = $('#importPemfileInput').get(0);
       if(!reqBody.credentials.username){
          alert('Please Enter Username');
          return;
       }
       if(!pemFileInput.files.length) {
         alert('Please Choose a Pem file');
         return;
       }

      reqBody.users = $('#userListSelect').val();
        if(!reqBody.users || !reqBody.users.length) {
        alert('Please Choose Users');
        return;
       }
       var reader = new FileReader();
       reader.onload = function(e) {
           // Render thumbnail.
            reqBody.credentials.pemFileData = e.target.result;
           
            makeRequest();
           
       };
       // Read in the image file as a data URL.
       reader.readAsText(pemFileInput.files[0]);
 
     }       

      function makeRequest() {
        console.log(reqBody);
   $.post('../chef/servers/'+urlParams.chefId+'/sync/nodes',reqBody,function(data){
    console.log(data);
    var $chefResultModalContainer = $('#chefImportNodesResultModal');
    var $modalBody = $chefResultModalContainer.find('.modal-body');
    $modalBody.empty();
    var $progressBar = $('<progress value="0" max="'+reqBody.selectedNodes.length+'"></progress>').css({
      width:'100%'
    });
    var $msgDiv = $('<div class="messageDiv"></div>').css({
      width:'100%'
    });

     $modalBody.append($progressBar).append($msgDiv);
     $('#chefImportNodesModal').modal('hide');
     $chefResultModalContainer.modal('show');
     var timeout;
     var count = 0;
     function pollTaskStatus(taskId,timestamp) {
        timeout= setTimeout(function(){
          $.get('../task/'+taskId+'/status?timestamp='+timestamp,function(data){
            console.log(data);
            if(!data.completed) {
              if(data.statusList && data.statusList.length) {
                 
                 $progressBar.val(data.statusList.length);
                 $msgDiv.empty();
                 for(var i=0;i < data.statusList.length;i++) {
                   $msgDiv.append($('<div></div>').append(data.statusList[i].status.message));
                 }

                 pollTaskStatus(taskId,data.statusList[data.statusList.length -1].timestamp);
              } else {
                pollTaskStatus(taskId,timestamp);
              }
            } else {
              if(data.statusList && data.statusList.length) {
                $progressBar.val(data.statusList.length);
                  $msgDiv.empty();
                 for(var i=0;i < data.statusList.length;i++) {
                   $msgDiv.append($('<div></div>').append(data.statusList[i].status.message));
                 } 
               } 
               $progressBar.val(reqBody.selectedNodes.length);
               if(reqBody.selectedNodes.length) {

                var nodeData= $($checkBoxes[0]).data('node');
                if(nodeData && nodeData.chef_environment) {
                  $chefResultModalContainer.modal('hide');
                   //window.location.href = '#ajax/Dev.html?org='+reqBody.orgId+'&projid='+reqBody.projectId+'&envid='+nodeData.chef_environment;
                 }
               }
            }
          })   
        },1000);

     }
     pollTaskStatus(data.taskId,0);

   }).error(function(){
    alert('Unable to import instances. Please try again later');
   });
  }

 });

 });


(function(){

var $loadingContainer = $('.userListLoadingContainer').empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />').show();    
$.get('../users',function(userList){
  var $userListSelect = $('#userListSelect').empty(); 
  userList.sort(function(a, b){
    var keyA =Object.keys(a);
    var keyB =Object.keys(b);
    
    if(keyA[0] < keyB[0]) return -1;
    if(keyA[0] > keyB[0]) return 1;
    return 0;
  }); 
  for(var i=0;i<userList.length;i++) {
    var keys = Object.keys(userList[i]);
    var $option = $('<option></option>').append(keys[0]).val(keys[0]);
    $userListSelect.append($option);
  }
  $loadingContainer.hide();
  $userListSelect.show();
}).error(function(){
    $loadingContainer.empty().append('Unable to load users. Please try again later.');
});
})();



</script>
<script>


var b = $('#tabContent tr td').width();
var c = $('#tabContent tr ').width(); 
 b=c;
$('.tabContent tr').find('span').on('click', function(){
  var w = $(this).width();
  var h = $(this).height();
  var a = $(this).html();
  $(this).hide();
  $(this).parent().children('input').show().focus().val(a);
  $(this).parent().children('input').css({"width": w+'px'});
});

$('.tabContent tr').find('input').on('blur', function(){
  var inputVal = $(this).val();
  $(this).hide();
  $(this).parent().children('span').show().html(inputVal);
});
</script>

<script>
   $(document).ready(function () {
   
       $('#myform12').submit(function() {
           $(this).validate();
   
           if($(this).valid){
                /*alert('valid form submitted'); // for demo*/
               if(!saveform('12'))return false;;
           }else{
                alert('invalid valid form submitted'); // for demo
           }
           return false; // for demo
       });
   });
       
</script>