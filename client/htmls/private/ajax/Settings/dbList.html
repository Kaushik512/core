<div class="row">

  <div class="col-md-12">
   <div class="col-md-12">
         <div class="widget-box">
            <div class="widget-header">
               <h4 class="widget-margin" style="color:black;"></h4>
            </div>
            <div class="widget-body">
               <div class="widget-main" style="min-height:200px">
                  <section id="widget-grid" class="">
                     <!-- START ROW -->
                     <div class="row">
                        <!-- Widget ID (each widget will need unique ID)-->
                        <div class="jarviswidget" id="wid-id-3" data-widget-editbutton="false" data-widget-custombutton="false">
                           <!-- widget div-->
                           <div>
                              <!-- widget content -->
                              <div class="widget-body no-padding">
                                 <div class="col-lg-12 col-md-12">
                                  <!--table-->

                                  <div class="widget-body">
                                    <div class="nodeListContainer"></div>
                    <div class="widget-main dataBagTable hidden" style="min-height:300px">
                        <div class="col-md-4 table-responsive" style="padding-left:0px; padding-right:0px;">
                          <a href="#modalForDB" data-backdrop="false" data-toggle="modal" style="cursor:pointer;"> <img src="img/add.png" style="float:right;" class="addDB" rel="tooltip" data-placement="top" /></a>
                          <div style="height:294px;overflow-y:auto;" id="dbNameTable_wrapper" class="dataTables_wrapper no-footer">
                         <table id="dbNameTable" class="tableData table table-striped table-bordered table-hover dataTable no-footer" cellpadding="5px" width="100%" style="text-align:center;">
                             
                                <thead>
                                    <tr class="rowCustomStyle">
                                        <td>List of Data Bags</td>
                                    </tr>
                                </thead>
                                <tbody id="dbNameTableTest">
                                </tbody>
                                    
                            </table>
                          </div>
                        </div>
                        
                   
                    
                   
                    
                


                                  <!--table ends here-->
                                    
                                 
                                 
                                  <div class="spinner hidden"><img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" /></div>
                        <div class="col-md-4 table-responsive tableHidden" id="listData" style="padding-left:10px; padding-right:0px;display:none;">
                          <a href="#modalForItems" data-backdrop="false" data-toggle="modal" style="cursor:pointer;"> <img src="img/add.png" style="float:right;" class="addList" rel="tooltip" data-placement="top" /></a>
                           <div style="height:294px;overflow-y:auto;" id="dbNameTable_wrapper" class="dataTables_wrapper no-footer">
                         <table id="listNameTable" class="tableData table table-striped table-bordered table-hover dataTable no-footer" cellpadding="5px" width="100%" style="text-align:center">
                             
                                <thead>
                                    <tr class="rowCustomStyle">
                                      <td></td>
                                    </tr>
                                </thead>
                                <tbody>
                                       
                                </tbody>
                                    
                            </table>
                          </div>
                        </div>
                        <div class="spinnerNew hidden"><img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" /></div>
                        <div class="col-md-4 table-responsive" id="jsonData" style="padding-right:0px;margin-top:18px;display:none;">
                          <table id="listTable" class="table table-striped table-bordered table-hover dataTable no-footer" cellpadding="5px" width="100%" style="text-align:center">
                            <thead>
                              <tr class="rowCustomStyle">
                                <td></td>
                              </tr>
                              <tbody>
                                <tr>
                                  <td>
                            <textarea  style="width:100%" rows="10" cols="25" name="jsonName" class="jsonName" id="jsonListName"></textarea>
                          </td>
                        </tr>
                      </tbody>
                          </table>
                        </div>

                         </div>
                                 
                                 </div>   
                                 
                                 
                                 
                              </div>
                              <!-- end widget content -->
                           </div>
                           <!-- end widget div -->
                        </div>
                        <!-- end widget -->
                     </div>
                     <!-- END ROW -->
                  </section>
                  <!-- end widget grid -->
               </div>
            </div>
         </div>
   </div>
 </div>
</div>

<!--modal for DBList-->
<div class="modal fade" id="modalForDB" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog " style="">
        <div class="modal-content"> 
            <form role="form" id="instanceDBName">
             <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">
                    &nbsp;Create Data Bag
                </h4>

            </div> 
            
            
             <div class="modal-body" style="height:78px;">
                <div class="col-lg-6 col-md-6">

                            <label for="">Name<span style="color:Red;" class="control-label">&nbsp;*</span></label>

                            <input type="text" name="dbName" class="form-control dbName" id="instanceDataName" autofocus/>
                </div>
                
                    <input type="hidden" id="serverIDHiddenInput">
                

            </div>
            
               <div class="modal-footer">
                <label id="saveSpinner" class="hidden"><img  style="margin-left:5px;margin-right:25px;" src="img/select2-spinner.gif"></label>
        <input type="submit" id="saveBTN" class="btn btn-primary" value="Save" />
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>   
  </form>
         </div>
    </div>
</div>
<!--modal for DBlist-->

<!--modal for ItemList-->
<div class="modal fade" id="modalForItems" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog " style="">
        <div class="modal-content"> 
            <form role="form" id="instanceItemName">
             <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">
                    &nbsp;Create Item
                </h4>

            </div> 
            
            
             <div class="modal-body" style="height:218px;">
                <div class="col-lg-6 col-md-6">

                            <label for="">ID<span style="color:Red;" class="control-label">&nbsp;*</span></label>

                            <input type="text" name="listID" class="form-control listID" id="instanceListID" autofocus/>
                          </div>
                            <div class="col-lg-6 col-md-6" style="margin-top:30px">
                              
                            <input id="check_id" type="checkbox" name="encryption" value="key"> Do you want to encrypt?
                          </div>
                            
                            <div class="col-lg-12 col-md-12" style="margin-top:10px">
                            <label for="">Item Body</label><span style="color:red;" class="jsonError hidden">&nbsp;&nbsp;Invalid JSON</span>
                            <br/>
                            <textarea rows="5" cols="60" name="listName" class="listName" id="instanceListName" autofocus>{}</textarea>
                </div>
                
                
                    <input type="hidden" id="dataBagIDHiddenInput">
                     <input type="hidden" id="itemEditHiddenInput">
                

            </div>
            
               <div class="modal-footer">
                <label id="saveItemSpinner" class="hidden"><img  style="margin-left:5px;margin-right:25px;" src="img/select2-spinner.gif"></label>
        <input type="submit" id="saveBTNList" class="btn btn-primary" value="Save" />
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>   
  </form>
         </div>
    </div>
</div>
<!--modal for Itemlist-->

<script>
$(document).on('shown.bs.modal', function(e) {
    $('[autofocus]', e.target).focus();
});
$('.nodeListContainer').append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');



$('.addDB').click(function(e) {
    $('#instanceDBName').trigger('reset');
    $('.tableHidden').css('display','none');
    $('#dbNameTable tbody tr').removeClass('selectedOne');
});

$('.addList').click(function(e){
    $('#instanceItemName').trigger('reset');
    $('input.listID').removeAttr('disabled');
    $('#listNameTable tbody tr').removeClass('selectedOne');
    $('#jsonData').css('display','none');
});

 if (!$.fn.dataTable.isDataTable('#dbNameTable')) {
     //var $taskListArea = $('.taskListArea').empty();
     var $dataBagDatatable = $('#dbNameTable').DataTable({
         "pagingType": "full_numbers",
         "bInfo": false,
         "bLengthChange": false,
         //"iDisplayLength" : 7,
         "paging": false,
         "bFilter":false,
         "aoColumns": [{
                 "bSortable": false
             }]

     });
 }

 if (!$.fn.dataTable.isDataTable('#listNameTable')) {
     //var $taskListArea = $('.taskListArea').empty();
     var $itemDatatable = $('#listNameTable').DataTable({
         "pagingType": "full_numbers",
         "bInfo": false,
         "bLengthChange": false,
         //"iDisplayLength" : 7,
         "paging": false,
         "bFilter":false,
         "aoColumns": [{
                 "bSortable": false
             }]

     });
 }


$(document).ready(function(e) {
    var urlParams = {};
    (window.onpopstate = function() {
        var url = window.location.href;
        var indexOfQues = url.lastIndexOf("?");
        if (indexOfQues != -1) {
            var sub = url.substring(indexOfQues + 1);
            console.log(sub);
            var params = sub.split('&')
            for (var i = 0; i < params.length; i++) {
                var paramParts = params[i].split('=');
                urlParams[paramParts[0]] = paramParts[1];
            }
        }

    })();

    $.get('/d4dMasters/readmasterjsonnew/10', function(data) {
        for (i = 0; i < data.length; i++) {
            //alert(JSON.stringify(data));
            //alert(data[i].configname);
            var rowid = urlParams.id;
            if (rowid === data[i].rowid) {
                console.log(data[i]);
                $('.widget-header').find('h4.widget-margin').html('Data Bags for Chef Server -&nbsp;' + data[i].configname);
            }
        }
    });
   

    //for getting the list of data-bags
    var chefServer = '../chef/servers/' + urlParams.id + '/databag/list';

    $.get(chefServer, function(data) {
        $.each(data, function(k) {
          
            var $dbNameList = $('#dbNameTableTest');
            //alert(JSON.stringify(data));
            var dbNameIds = {};
            if (k.dbNameIds && k.dbNameIds.length) {
                dbNameIds = k.dbNameIds;
            }
           
            var name = k;
            var $tr = $('<tr class="dbTest"></tr>');
            var $tdName = $('<td class="dBNameCheck"></td>');
            var $tdClick = $('<a id="dbNameClick" style="cursor:pointer;">' + name + '</a>');
            $tdName.append($tdClick);
            $tdName.append('<div class="btn-group del" style="float:right;"><button class="deleteRow" value="Remove" title="Remove"><i class="ace-icon fa fa-trash-o bigger-120"></i></button></div>');
            $tr.append($tdName);
            $dbNameList.append($tr);
            $dataBagDatatable.row.add($tr).draw();
            $('#dbNameTable tbody tr').click(function() {
                //alert('You clicked row ' + ($(this).index() + 1));
                //$(this).addClass("selected").siblings().removeClass("selected");
                $('#dbNameTable tbody tr').removeClass('selectedOne');
                $(this).addClass('selectedOne');
                $('#listNameTable').find('tbody tr.itemsList').empty();
                $('.tableHidden').css('display','none');
                $('#jsonData').css('display','none');
            });

            $tdName.find('button.deleteRow').click(function() {
                var $this = $(this);
                var $tr = $this.parents('tr.dbTest');
                console.log(name);
                var dataBagName = name;
                console.log(dataBagName);
               // alert(name);
                //alert(urlParams.id);
                $('.tableHidden').css('display','none');
               bootbox.confirm('Are you sure you want to delete Data Bag -&nbsp;' + dataBagName, function(result) {
                    if (result) {
                        $.ajax({
                            url: '../chef/servers/' + urlParams.id + '/databag/' + dataBagName + '/delete',
                            method: 'DELETE',
                            success: function() {
                                //$tr.remove();
                                $dataBagDatatable.row($tr).remove().draw(false);
                            },
                            fail: function() {
                                alert("Unable to delete URL please try again later");
                            }
                        });
                    }
                    //return false;
                });
            });

            $tdClick.click(function(e) {
                $itemDatatable.clear().draw();
                $('.tableHidden').css('display','none');
                $('#jsonData').css('display','none');
                $('.spinner').removeClass('hidden');
                $('#dataBagIDHiddenInput').val(k);
                //alert(k);
                getList(k);

                $('#listNameTable thead').find('tr.rowCustomStyle td').html('Items for -&nbsp;' + k);
                
            });


        });
              console.log(">>>>>>>>>>>>>>>>>>>>>>>>");
                $('.nodeListContainer').addClass('hidden');
                $('.dataBagTable').removeClass('hidden');
                //alert('You clicked row ' + ($(this).index() + 1));
                $('#dbNameTable tbody tr:first td a').trigger('click');

    });

    function getList() {
        
        var dataBagName = $('#dataBagIDHiddenInput').val();
        console.log(dataBagName);
        var listItems = '../chef/servers/' + urlParams.id + '/databag/' + dataBagName + '/item/list';
        $.get(listItems, function(data) {
          if(data.length > 0){
            $.each(data, function(k) {
                console.log(data);
                if (k) {
                    //$('#listNameTable').find('tbody tr td.dataAvList').addClass('hidden');
                  }
                    $('.spinner').addClass('hidden');
                    $('.tableHidden').css('display', 'block');
                    createItemTableRow(data[k]);
                    //$('#listNameTable').find('tbody tr td.dataAvList').addClass('hidden');
            });
          }
          else{
            //alert('hhh');
            $('.spinner').addClass('hidden');
            $('.tableHidden').css('display', 'block');
            //$('#listNameTable tbody').find('tr td.dataAvList').removeClass('hidden');
          }
        });
    };

    //for db submit..
    $('#instanceDBName').submit(function(e) {
        $('#saveSpinner').removeClass('hidden');
        $('#saveBTN').attr('disabled','disabled');
        var reqBodyName = {};
        var $row = $('<tr class="dbTest"/>');
        var $form = $('#instanceDBName');
        reqBodyName.name = $form.find('.dbName').val();
        $('.dbName').focus();
        //var serverId = $form.find('#serverIDHiddenInput').val();
        if (!(reqBodyName.name)) {
            alert("Please Enter Name");
            $('#saveSpinner').addClass('hidden');
            $('#saveBTN').removeAttr('disabled');
            return false;

        }
        $.post('../chef/servers/' + urlParams.id + '/databag/create', reqBodyName, function(data) {
            var $tdNameNew = $('<td class="dBNameCheck"></td>');
            var $tdClick = $('<a id="dbNameClick" style="cursor:pointer;">' + reqBodyName.name + '</a>');
            $tdNameNew.append($tdClick);
            $tdNameNew.append('<div class="btn-group del" style="float:right;"><button class="deleteRow" value="Remove" title="Remove"><i class="ace-icon fa fa-trash-o bigger-120"></i></button></div>');

            $row.append($tdNameNew);
            console.log(reqBodyName.name);
            //$('#dbNameTable').find('tbody tr td.dataAv').addClass('hidden');
            $('#saveSpinner').addClass('hidden');
            $('#saveBTN').removeAttr('disabled');
            $('#dbNameTable').find('tbody').append($row);
            $('#modalForDB').modal('hide');
            $dataBagDatatable.row.add($row).draw();

            $('#dbNameTable tbody tr').click(function() {
                //alert('You clicked row ' + ($(this).index() + 1));
                //$(this).addClass("selected").siblings().removeClass("selected");
                $('#dbNameTable tbody tr').removeClass('selectedOne');
                $(this).addClass('selectedOne');
                $('#listNameTable').find('tbody tr.itemsList').empty();
                $('.tableHidden').css('display','none');
                $('#jsonData').css('display','none');
            });

            $tdNameNew.find('button.deleteRow').click(function() {
                var $this = $(this);
                var $row = $this.parents('tr.dbTest');
                console.log(reqBodyName.name);
                var dataBagName = reqBodyName.name;
                console.log(dataBagName);
                $('.tableHidden').css('display','none');
                bootbox.confirm('Are you sure you want to Delete Data Bag -&nbsp;' + dataBagName, function(result) {
                    if (result) {
                        $.ajax({
                            url: '../chef/servers/' + urlParams.id + '/databag/' + dataBagName + '/delete',
                            method: 'DELETE',
                            success: function() {
                                $dataBagDatatable.row($row).remove().draw(false);
                            },
                            fail: function() {
                                alert("Unable to delete URL please try again later");
                            }
                        });
                    }
                   // return false;
                });
            });
            $tdClick.click(function(e) {
                //alert('hello');

                $itemDatatable.clear().draw();
                $('.tableHidden').css('display','none');
                $('#jsonData').css('display','none');
                $('.spinner').removeClass('hidden');
                //alert(JSON.stringify(reqBodyName.name));
                $('#dataBagIDHiddenInput').val(reqBodyName.name);
                $('#listNameTable thead').find('tr.rowCustomStyle td').html('Items for -&nbsp;' + reqBodyName.name);
                getList();
            });

        });
        return false;
    });

//new function for creating items from databags
function createItemTableRow(k){
        var itemTable = $('#listNameTable tbody');
        var $trForItems = $('<tr class="itemsList"/>');
        var $tdForItems = $('<td class="listData"/>');
        $tdForItems.append('<a style="cursor:pointer;" id="listNameClickNew">' + k + '</a>').append('<div class="btn-group" style="float:right;"><button class="editRow" value="Update" title="Update"><i class="ace-icon fa fa-pencil bigger-120"></i></button></div>').append('<div style="margin-right:10px;float:right;" class="btn-group del"><button class="deleteRow" value="Remove" title="Remove"><i class="ace-icon fa fa-trash-o bigger-120"></i></button></div>');

        $trForItems.append($tdForItems);
        $('#listNameTable').find('tbody').append($trForItems);
        $itemDatatable.row.add($trForItems).draw();

        $('#listNameTable tbody tr').click(function() {
                //alert('You clicked row ' + ($(this).index() + 1));
                //$(this).addClass("selected").siblings().removeClass("selected");
                $('#listNameTable tbody tr').removeClass('selectedOne');
                $(this).addClass('selectedOne');
                //$('#listNameTable').find('tbody tr.itemsList').empty();
                //$('#jsonData').css('display','none');
            });

        

        //for edit
        $tdForItems.find('button.editRow').click(function() {
            $('.spinnerNew').addClass('hidden');
            $('#jsonData').css('display','none');
            var $this = $(this);
            var $trNew = $this.parents('tr.itemsList');
            var $editModal = $('#modalForItems');
            $('textarea#instanceListName').val('');
            $editModal.modal('show');
            $editModal.find('.listID').val(k);
            $('input.listID').attr('disabled','disabled');
            $editModal.find('.listName').val();
            $editModal.find('#itemEditHiddenInput').val('edit');
            var dataBagName = $('#dataBagIDHiddenInput').val();
                console.log(dataBagName);
                console.log(k);
                var itemId = k;
                console.log(itemId);
                $.get('../chef/servers/' + urlParams.id + '/databag/' + dataBagName + '/item/' + itemId + '/find', function(data) {
                   // alert('hello');
                    console.log(data);
                    
                    var res = JSON.stringify(data);
                    $('#instanceListName').val(res);
                });
                return false;
        });

        //for delete
        $tdForItems.find('button.deleteRow').click(function() {
          $('#jsonData').css('display','none');
            var $this = $(this);
            var $trNew = $this.parents('tr.itemsList');
            var dataBagName = $('#dataBagIDHiddenInput').val();
            console.log(dataBagName);
            console.log(k);
            var itemName = k;
            console.log(itemName);
            bootbox.confirm('Are you sure you want to Delete Item Name -&nbsp;' + itemName, function(result) {
                if (result) {
                    $.ajax({
                        url: '../chef/servers/' + urlParams.id + '/databag/' + dataBagName + '/item/' + itemName + '/delete',
                        method: 'DELETE',
                        success: function() {
                            //$trNew.remove();
                            $itemDatatable.row($trNew).remove().draw(false);
                            
                        },
                        fail: function() {
                            alert("Unable to delete URL please try again later");
                        }
                    });
                }
            });
            return false;
        });
        $tdForItems.click(function(e){
          $('.spinnerNew').removeClass('hidden');
          $('textarea#jsonListName').val('');
          var dataBagName = $('#dataBagIDHiddenInput').val();
          var itemId = k;
            
            $.get('../chef/servers/' + urlParams.id + '/databag/' + dataBagName + '/item/' + itemId + '/find', function(data) {
                // alert('hello');
                console.log(data);
                var res = JSON.stringify(data);
                $('.spinnerNew').addClass('hidden');
                $('#jsonData').css('display','block');
                $('#listTable thead').find('tr.rowCustomStyle td').html(itemId);
                //$('#listTable tbody').find('tr')
                $('#jsonListName').val(res);

            });
        });
    };

    //for list items
    $('.addList').click(function(e){
        $('#itemEditHiddenInput').val('new');
    });

    //submit for Item Name
    $('#instanceItemName').submit(function(e) {
        $('#saveItemSpinner').removeClass('hidden');
        $('#saveBTNList').attr('disabled','disabled');
        var $form = $('#instanceItemName');
        var itemID = $form.find('.listID').val();
        $('.listID').focus();
        var jsonString = $form.find('.listName').val();
        var jsonObj;
        try {
            jsonObj = JSON.parse(jsonString);
        } catch (err) {
            //alert('Invalid JSON');
            $('.jsonError').removeClass('hidden');
            $('#saveItemSpinner').addClass('hidden');
            $('#saveBTNList').removeAttr('disabled', 'disabled');
            return false;
        }
        if (!(itemID)) {
            alert("Please Enter ID");
            $('#saveItemSpinner').addClass('hidden');
            $('#saveBTNList').removeAttr('disabled', 'disabled');
            return false;
        }
        var dataBagName = $form.find('#dataBagIDHiddenInput').val();
        var itemsEditNew = $(this).find('#itemEditHiddenInput').val();
        console.log(dataBagName);
        var isEncrypt=false;
        if ($('#check_id').is(":checked")) {
            isEncrypt=true;
        }
        console.log($('#check_id').is(":checked"));
        console.log(isEncrypt);
        var url;
        var reqBody;
        if (itemsEditNew === 'edit') {
            url = '../chef/servers/' + urlParams.id + '/databag/' + dataBagName + '/item/' + itemID + '/update';
            reqBody = {
                "isEncrypt":isEncrypt,
                "dataBagItem": jsonObj
            };
        } else {
            url = '../chef/servers/' + urlParams.id + '/databag/' + dataBagName + '/item/create';
            reqBody = {
                "id": itemID,
                "isEncrypt":isEncrypt,
                "dataBagItem": jsonObj
            };
        }

        
        $.ajax({
            method: "POST",
            url: url,
            data: reqBody,
            success: function(data, success) {
                
                $('#modalForItems').modal('hide');
                $('#saveItemSpinner').addClass('hidden');
                $('#saveBTNList').removeAttr('disabled');
                console.log(itemsEditNew);
                if(itemsEditNew ==='new'){
                  console.log(itemID);
                  createItemTableRow(itemID);
                   $('#saveBTNList').removeAttr('disabled');
                }
            },
            error: function(jqxhr) {
                bootbox.alert(jqxhr.responseText);
                $('#saveItemSpinner').addClass('hidden');
                $('#saveBTNList').removeAttr('disabled');
            },
            failure: function(data) {
                bootbox.alert(data.responseText);
                $('#saveItemSpinner').addClass('hidden');
                //$('#saveBTNList').removeAttr('disabled');
            }
        });
        return false;
    });

});
</script>


