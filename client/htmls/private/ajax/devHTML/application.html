<style type="text/css">
input {
    border: 1px solid #cccccc;
}

.jarviswidget .widget-body {
    padding-bottom: 0px !important;
}
</style>
<div class="tab-pane" id="l6">
    <div class="jarviswidget jarviswidget-color-blueLight" id="wid-id-application" data-widget-colorbutton="false" data-widget-editbutton="false" data-widget-togglebutton="false" data-widget-deletebutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-sortable="false">
        <div>
            <div class="widget-body no-padding">
                <div class="col-lg-6 col-md-6 availableApp" style="padding-left: 0px; margin-bottom: 15px;margin-top:5px;">
                    <label for="chooseApplication">Choose Available Application:<span style="color:red">*</span></label>
                    <div class="input-groups">
                        <select id="chooseApplication" name="chooseApplication" class="required chooseApplication width-100">
                            <!-- <option data-selectedAppName="All Application" value="">All Application</option> -->
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 hidden">
                    <div class="panel-heading">
                        <span class="pull-right swap-view">
				      <a class="btn btn-primary envAppDeployList" href="#modalAppCardTableDetails" data-toggle="modal" style="margin-top: 15px;">
				        <span style="font-weight: bold;">List of Application</span>
                        <i title="Add Application Details" class="fa fa-list fa-2x" style="color:#ffffff;cursor:pointer;font-size:13px;"></i>
                        </a>
                        <a class="btn btn-primary envAppDeployModal" href="#modalAppCardDetails" data-toggle="modal" style="margin-top: 15px;">
                            <span style="font-weight: bold;">Add Application</span>
                            <i title="Add Application Details" class="fa fa-plus fa-2x" style="color:#ffffff;cursor:pointer;font-size:13px;"></i>
                        </a>
                        </span>
                    </div>
                </div>
                <div class="row">
                    <article class="col-sm-12 col-md-12 col-lg-12">
                        <div class="widget-body font-size12" id="widgetAppDeploy" style="border: 1px solid rgb(221, 221, 221);">
                            <div class="panel-group smart-accordion-default" id="accordion-AppDeploy">
                            </div>
                            <div id="nodataAppDeploy" style="display:none">
                            </div>
                            <!-- <ul id="myTab3" class="nav nav-tabs tabs-pull-left">
				          <li class="pull-left active">
				              <a href="#l1" data-toggle="tab"><i class="fa fa-shield"></i>&nbsp;Application Deployment<span id="appDeployName"></span></a>
				          </li>
				      </ul>
				      <div id="myTabContent3" class="nav tab-content">
				        <div class="tab-pane active" id="l1">
				          <div class="panel-group smart-accordion-default" id="accordion-AppDeploy">
				           
				          </div>
				          <div id="nodataAppDeploy" style="display:none">

				          </div>
				        </div>
				      </div> -->
                        </div>
                    </article>
                </div>
                <div class="accordianTemplateContainer" style="display:none">
                    <div class="panel panel-default accordianTemplate">
                        <div class="panel-heading">
                            <h4 class="panel-title">
				          <a class="envAppDeployAnchor" data-toggle="collapse" data-parent="#accordion-AppDeploy" href="#collapseAppEnv1"> 
				            <i class="fa fa-fw fa-plus-circle txt-color-blue"></i> 
				            <i class="fa fa-fw fa-minus-circle txt-color-blue"></i>
				            <b style="font-size:12px;" class="envAppDeployName"><u></u></b>
				          </a>
				        </h4>
                        </div>
                        <div id="collapseAppEnv1" class="panel-collapse collapse in envAppDeployAccordian" style="padding: 5px;">
                            <div class="table-responsive table-div">
                                <table id="tableappDeploydetails" class="table table-striped table-bordered table-hover dataTable envAppDeployTable" style="border:1px solid #eeeeee !important; text-align:center;font-size:12px;margin-top:45px;" width="100%" cellpadding="5px">
                                    <thead>
                                        <tr class="rowCustomStyle" style="font-weight:bold;">
                                            <!-- <td style="color:#fff;background-color: #2c3742;">S.No.</td> -->
                                            <td style="color:#fff;background-color: #2c3742;">App Name</td>
                                            <td style="color:#fff;background-color: #2c3742;">App-Instance Name</td>
                                            <td style="color:#fff;background-color: #2c3742;">Version</td>
                                            <td style="color:#fff;background-color: #2c3742;">Host Name</td>
                                            <td style="color:#fff;background-color: #2c3742;">Node IP</td>
                                            <td style="color:#fff;background-color: #2c3742;">Last Deploy</td>
                                            <td style="color:#fff;background-color: #2c3742;">Status</td>
                                            <td style="color:#fff;background-color: #2c3742;">Application Type</td>
                                            <td style="color:#fff;background-color: #2c3742;">Container ID</td>
                                            <td style="color:#fff;background-color: #2c3742;">Logs</td>
                                            <!-- <td style="color:#fff;background-color: #2c3742;">App Links</td>
				                        <td style="color:#fff;background-color: #2c3742;">Action</td> -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="modalAppCardDetails" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form role="form" id="formAppDeploy" autocomplete="off">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                        X
                                    </button>
                                    <h4 class="modal-title">
				                    <i class="fa fa-th-list txt-color-blue"></i>&nbsp;&nbsp;Associate App Deploy<span style="color:red;font-size:12px" id="errorParam"></span>
				                </h4>
                                </div>
                                <div class="modal-body">
                                    <div class="addApptoAppend">
                                        <div style="margin:5px 0px 0px;" class="row application4Params">
                                            <div style="padding-left:0px;" class="col-lg-6">
                                                <label for="name">Application Name:<span style="color:red">*</span>
                                                </label>
                                                <input type="text" autofocus="" style="height:36px;" class="form-control" id="appNameInput">
                                            </div>
                                            <div style="padding-left:0px;" class="col-lg-6">
                                                <label for="name">Description:
                                                </label>
                                                <input type="text" style="height:36px;" class="form-control" id="applicationDescriptionInput">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="btn-group" style="margin-left:200px;">
                                        <a class="btn btn-primary" id="parameterAppDeploySaveBtn">
                                            <i class="ace-icon fa fa-save bigger-110"></i> Save
                                        </a>
                                        <a style="margin-left:10px;" class="btn btn-primary cancelAppDeploy" data-dismiss="modal">
                                            <i class="ace-icon fa fa-undo bigger-110"></i> Cancel
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="modalAppCardTableDetails" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form role="form" id="formAppDeployTableHistory" autocomplete="off">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                        X
                                    </button>
                                    <h4 class="modal-title">
				                    <i class="fa fa-th-list txt-color-blue"></i>&nbsp;&nbsp;List of Application
				                </h4>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive table-div">
                                        <table id="tableappParamDeploy" class="table table-striped table-bordered table-hover dataTable" style="border:1px solid #eeeeee !important; text-align:center;font-size:12px;" width="100%" cellpadding="5px">
                                            <thead>
                                                <tr class="rowCustomStyle" style="font-weight:bold;">
                                                    <td style="color:#fff;background-color: #2c3742;">S.No.</td>
                                                    <td style="color:#fff;background-color: #2c3742;">Application Name</td>
                                                    <td style="color:#fff;background-color: #2c3742;">Application Description</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="btn-group" style="margin-left:200px;">
                                        <a style="margin-left:10px;" class="btn btn-primary" data-dismiss="modal">
                                            <i class="ace-icon fa fa-undo bigger-110"></i> Cancel
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="modalAppCardLogDetails" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form role="form" id="formAppDeployLogs" autocomplete="off">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                        X
                                    </button>
                                    <h4 class="modal-title">
				                    <i class="fa fa-th-list txt-color-blue"></i>&nbsp;&nbsp;Logs
				                </h4>
                                </div>
                                <div class="modal-body">
                                    <div class="logsForAppDeploy">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="btn-group" style="margin-left:200px;">
                                        <a style="margin-left:10px;" class="btn btn-primary cancelAppDeploy" data-dismiss="modal">
                                            <i class="ace-icon fa fa-undo bigger-110"></i> Cancel
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function() {
    // $('#chooseApplication').select2();
    //debugger;
    getDropdownList();
    // getAllApplicationData(function(data){
    //   constructUI(data);
    // });
});

function saveRecord() {
    var dataDeploy = {
        "appDeployData": {
            "applicationName": "",
            "description": "",
            "projectId": ""
        }
    };
    var applicationName = $('#appNameInput').val();
    var applicationDescription = $('#applicationDescriptionInput').val();
    var projectId = urlParams.projid;
    if (!applicationName) {
        $('#errorParam').empty();
        $('#errorParam').append('Application name should not be empty');
        return;
    } else {
        dataDeploy.appDeployData.description = applicationDescription;
        dataDeploy.appDeployData.projectId = projectId;
        dataDeploy.appDeployData.applicationName = applicationName;
        console.log(JSON.stringify(dataDeploy));
        $.ajax({
            url: '/app/deploy/data/create',
            data: JSON.stringify(dataDeploy),
            type: 'POST',
            contentType: "application/json",
            success: function(data) {
                console.log(data);
                // var $chooseApplication = $('#chooseApplication');
                // $chooseApplication.empty();
                $('#modalAppCardDetails').modal("hide");
                getDropdownList();
            },
            error: function(jqxhr) {
                $("#errorParam").empty();
                $("#errorParam").append("    " + jqxhr.responseText);
            }
        });
    }
}

function getDropdownList() {
    // if($chooseApplication){
    //   $chooseApplication.empty();
    // }
    var projectId = urlParams.projid;
    $.get('/d4dMasters/project/' + projectId, function(dataTotalList) {
        var $chooseApplication = $('#chooseApplication');
        $chooseApplication.empty();
        $chooseApplication.append('<option value="All Application">All Application</option>');
        $('#chooseApplication').select2();
        var applicationNameArr = [];
        var applicationDescArr = {};
        /*$.each(dataTotalList, function(key, val) {
            if (val.rowid) {
                applicationNameArr.push(val.applicationname);
                if (!applicationDescArr[val.applicationname]) {
                    applicationDescArr[val.applicationname] = val.description;
                }
            }
        });*/
        //alert(JSON.stringify(dataTotalList));
        $.each(dataTotalList[0].appdeploy, function(key, val) {
            $option = $('<option value="' + val.applicationname + '">' + val.applicationname + '</option>');
            $chooseApplication.append($option);
        });

        $chooseApplication.change();



    }).fail(function() {
        alert("getDropdownList Error");
    });
}

function constructDataListTable() {
    var $taskenvArrayTable = $('#tableappParamDeploy').DataTable();
    $taskenvArrayTable.clear().draw(false);
    $.get('/d4dMasters/readmasterjsonnew/4', function(dataTotalList) {
        $.each(dataTotalList, function(key, val) {
            var $taskenvArrayTable = $('#tableappParamDeploy');
            var rowindex1 = $taskenvArrayTable.dataTable().fnGetData().length;
            $taskenvArrayTable.dataTable().fnAddData([
                rowindex1 + 1,
                val.applicationname,
                val.description
            ]);
        });
    }).fail(function() {});
}

function getenvName(callback) {
    var envId = urlParams.envid;
    $.ajax({
        url: '/d4dMasters/env/' + envId,
        type: 'GET',
        contentType: "application/json",
        success: function(dataenvName) {
            callback(dataenvName);
        },
        error: function(jqxhr) {

        },
        failure: function(data1) {

        }
    });
}

function getAllApplicationData() {
    var projectId = urlParams.projid;
    getenvName(function(envName) {
        $.get('/app/deploy/env/' + envName + '/project/' + projectId + '/list', function(data) {
            constructUI(data);
        }).fail(function() {});
    });
};

function getParticularApplicationData(selectedAppName) {
    $("#accordion-AppDeploy").empty();
    var projectId = urlParams.projid;
    getenvName(function(envName) {
        $.ajax({
            url: '/app/deploy/data/env/'+envName+'/' + selectedAppName + '/project/' + projectId + '/list',
            type: 'GET',
            contentType: "application/json",
            success: function(data) {
                constructUI(data);
            },
            error: function(jqxhr) {

            },
            failure: function(data) {

            }
        });
    });
}

function constructUI(data) {
    //alert(data);
    $("#accordion-AppDeploy").empty();
    if (data.length) {
        var $chooseApplication = $('#chooseApplication');

        var selectedAppName = $chooseApplication.val();
        //console.log(selectedAppName);
        if (typeof selectedAppName != 'undefined') {
            $('#appDeployName').append().text("  for '" + selectedAppName + "'");
            $('#widgetAppDeploy').show();
        } else {
            $('#appDeployName').append().text("");
            $('#widgetAppDeploy').hide();
        }
        $("#nodataAppDeploy").css({
            "text-align": "center",
            "margin-top": "20px",
            "display": "none"
        });
        var $accordianTemplate = $('.accordianTemplateContainer').find('.accordianTemplate');
        var dataenvAccordianName;
        if (data && data.length) {
            var $clone = $accordianTemplate.clone(true);
            for (var i = 0; i < data.length; i++) {
                console.log(data[i]);
                if (data[i].projectId) {
                    //alert("hiii");
                    if ($('#' + data[i].projectId + data[i].applicationName + data[i].envId + '_parentAccordian').length == 0) {
                        //$clone.attr('id', data[i].projectId + data[i].applicationName + data[i].envId + '_parentAccordian');
                        //$clone.find('.envAppDeployAnchor').attr('data-parent', '#' + data[i].projectId + data[i].applicationName + data[i].envId + '_parentAccordian');
                        if (typeof data[i].projectId + data[i].applicationName + data[i].envId == 'undefined') {
                            dataenvAccordianName = '';
                        } else {
                            // dataenvAccordianName = 'Application : ' + data[i].applicationName + '  &  ' + 'Environment : ' + data[i].envId;
                            dataenvAccordianName = 'Environment : ' + data[i].envId;
                        }
                        $clone.find('.envAppDeployName').html(dataenvAccordianName);
                        //$clone.find('.envAppDeployAnchor').attr('href', '#' + data[i].projectId + data[i].applicationName + data[i].envId + '_accordian');
                        //$clone.find('.envAppDeployAccordian').attr('id', data[i].projectId + data[i].applicationName + data[i].envId + '_accordian');
                        //$clone.find('.envAppDeployTable').attr('id', 'tableappDeploydetails');
                        $('#accordion-AppDeploy').append($clone);
                        if (!$.fn.dataTable.isDataTable('#tableappDeploydetails')) {
                            $('#tableappDeploydetails').DataTable({
                                "pagingType": "full_numbers",
                                "iDisplayLength": 5,
                                "aLengthMenu": [
                                    [5, 40, 100, -1],
                                    [5, 40, 100, "All"]
                                ],
                                "aaSorting": [
                                    [5, 'desc']
                                ],
                                "aoColumns": [
                                    // {
                                    //     "bSortable": true
                                    // }, 
                                    {
                                        "bSortable": true
                                    }, {
                                        "bSortable": true
                                    }, {
                                        "bSortable": true
                                    }, {
                                        "bSortable": true
                                    }, {
                                        "bSortable": true
                                    }, {
                                        "bSortable": true
                                    }, {
                                        "bSortable": true
                                    }, {
                                        "bSortable": true
                                    }, {
                                        "bSortable": true
                                    }, {
                                        "bSortable": false
                                    }
                                ]
                            });
                        }
                    }
                    var $taskenvArray = $('#tableappDeploydetails');
                    //var rowindex = $taskenvArray.dataTable().fnGetData().length;
                    // if (data[i].applicationStatus == "Successful") {
                    //     data[i].applicationStatus = '<img src="img/indicator_started.png">';
                    // } else if (data[i].applicationStatus == "Failure") {
                    //     data[i].applicationStatus = '<img src="img/indicator_stopped.png">';
                    // } else {
                    //     data[i].applicationStatus = '<img src="img/indicator_unknown.png">';
                    // }
                    // var appLinks = '<img style="height: 18px;margin-left: -5px;"src="img/projectdemo/app-performanceblack.png" title="App-Performance"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/logsblack.png" title="App-Logs"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/code_healthblack.png" title="Code-Health"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/UI_performanceblack.png" title="UI-Performance">';
                    //var logs = '<div class="moreinfoAppDeploy" id="" title="Logs Info" style="margin-left:27%"></div>';
                    //console.log(data[i].appLogs);


                    var logsAppDeploy;
                    if (!data[i]._id) {
                        logsAppDeploy = "NA";
                    } else {
                        logsAppDeploy = '<a class="moreinfoAppDeploy" id=' + data[i]._id + ' target="_blank" title="Logs Info" style="margin-left:27%"></a>';
                    }
                    if (!data[i].applicationName) {
                        data[i].applicationName = "NA";
                    }
                    if (!data[i].applicationInstanceName) {
                        if (data[i].hostName) {
                            data[i].applicationInstanceName = data[i].hostName;
                        } else {
                            data[i].applicationInstanceName = "NA";
                        }
                    }
                    if (!data[i].applicationVersion) {
                        data[i].applicationVersion = "NA";
                    }
                    if (!data[i].applicationType) {
                        data[i].applicationType = "NA";
                    }
                    if (!data[i].containerId) {
                        data[i].containerId = "NA";
                    }
                    if (!data[i].hostName) {
                        data[i].hostName = "NA";
                    }
                    if (!data[i].applicationNodeIP) {
                        data[i].applicationNodeIP = "NA";
                    }
                    if (!data[i].applicationLastDeploy) {
                        data[i].applicationLastDeploy = "NA";
                    }
                    if (!data[i].applicationStatus) {
                        data[i].applicationStatus = "NA";
                    }
                    var applicationLastDeployTime = data[i].applicationLastDeploy;
                    applicationLastDeployTime = applicationLastDeployTime.slice(0, -6);;
                    $taskenvArray.dataTable().fnAddData([
                        //rowindex + 1,
                        data[i].applicationName,
                        data[i].applicationInstanceName,
                        data[i].applicationVersion,
                        data[i].hostName,
                        data[i].applicationNodeIP,
                        applicationLastDeployTime,
                        data[i].applicationStatus,
                        data[i].applicationType,
                        data[i].containerId,
                        logsAppDeploy
                    ]);
                }
                if (typeof data[i].envId == 'undefined') {
                    $('#' + data[i].projectId + data[i].applicationName + data[i].envId + '_parentAccordian').hide();
                }
            }
            $(".moreinfoAppDeploy").click(function(e) {
                var $modal = $('#modalAppCardLogDetails');
                var $logContainer = $modal.find('.logsForAppDeploy').show();
                $logContainer.empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');
                $.ajax({
                    url: '/app/deploy/' + this.id + '/logs',
                    type: 'GET',
                    contentType: "application/json",
                    success: function(data) {
                        var datahttp = data.indexOf("http://");
                        if (datahttp == 0) {
                            $logContainer.empty();
                            window.open(data, "_blank");
                        } else {
                            $logContainer.empty();
                            $modal.modal('show');
                            data = data.replace(/,/g, "<br />");
                            $logContainer.append(data);
                        }
                    },
                    error: function(jqxhr) {
                        $logContainer.empty();
                        $modal.modal('show');
                        $logContainer.append('No Logs Available');
                    },
                    failure: function(data) {

                    }
                });
            });
        }
    } else {
        $("#nodataAppDeploy").empty();
        $("#nodataAppDeploy").css({
            "text-align": "center",
            "margin-top": "20px",
            "display": "block"
        }).append("No Data Available");
    }
}
var $chooseApplication = $('#chooseApplication');

$chooseApplication.change(function() {
    var selectedAppName = $(this).val();
    console.log(selectedAppName);
    if (typeof selectedAppName != 'undefined') {
        $('#appDeployName').append().text("  for '" + selectedAppName + "'");
        $('#widgetAppDeploy').show();
    } else {
        $('#appDeployName').append().text("");
        $('#widgetAppDeploy').hide();
    }
    if (selectedAppName == 'All Application') {
        getAllApplicationData(function(data) {
            constructUI(data);
        });
    } else {
        getParticularApplicationData(selectedAppName);
    }
});
$('#parameterAppDeploySaveBtn').on("click", function() {
    //saveRecord();
    //getDropdownList();
    /*getAllApplicationData(function(data){
        constructUI(data);
      });*/
});

$('.envAppDeployModal').click(function(e) {
    $('#formAppDeploy').trigger("reset");
    $("#errorParam").empty();
});
$('.envAppDeployList').click(function(e) {
    constructDataListTable();
});
// $('.moreinfoAppDeploy').attr('id').on("click", function() {
//     alert("I am here:");
// });
if (!$.fn.dataTable.isDataTable('#tableappParamDeploy')) {
    $('#tableappParamDeploy').DataTable({
        "pagingType": "full_numbers",
        "iDisplayLength": 5,
        "aLengthMenu": [
            [5, 40, 100, -1],
            [5, 40, 100, "All"]
        ],
        "aoColumns": [{
            "bSortable": true
        }, {
            "bSortable": true
        }, {
            "bSortable": true
        }]
    });
}
$("#tableappParamDeploy_length").hide();
$("#tableappParamDeploy_filter").hide();
var urlParams = {};
(window.onpopstate = function() {
    var url = window.location.href;
    var indexOfQues = url.lastIndexOf("?");
    if (indexOfQues != -1) {
        var sub = url.substring(indexOfQues + 1);
        console.log(sub);
        var params = sub.split('&')
        for (var i = 0; i < params.length; i++) {
            var paramParts = params[i].split('=');
            urlParams[paramParts[0]] = paramParts[1];
        }
    }
})();
</script>
