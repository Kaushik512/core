<div class="col-lg-12">
    <div class="col-lg-4 paddingleft0">
        <label>
            <strong>Select Task Type</strong>
        </label>
        <div class="row">
            <div class="col-lg-7 paddingright0">
                <select id="taskType" class="chooseTasktype width-100">
                    <option id="Chef" value="chef">Chef</option>
                    <option id="Jenkins" value="jenkins">Jenkins</option>
                   <!-- <option id="Custom" value="custom">Custom</option>-->
                </select>
            </div>  
        </div>
    </div>
</div>
        
    

<div id="chef-dropdown">
    <div class="col-lg-3 paddingleftright0">
        <div class="col-lg-12 margintop15">
                <label>
                    <strong>Task Name <span style="color:red">*</span></strong>
                </label>
                <div class="row">
                    <div class="col-lg-10">
                        
                            <input id="chefTaskName" type="text" cat-validation="required,nospecial" cdata="catalyst" class="form-control inputTaskName" name="ctl00$MainContent$orgname" autofocus>
                        
                    </div>  
                </div>
        </div>
        <div class="col-lg-12 margintop15">
            <label>
                <strong>Chef Server Name</strong>
            </label>
            <div class="row">
                <div class="col-lg-10">
                    
                        
                        <input type="text" class="form-control chefServerName" placeholder="" disabled>
                    
                </div>  
            </div>
        </div>
        <div class="col-lg-12 margintop15">
            <div class="smart-form marginleft15">
                <label>
                    <img src="img/templateicons/Select-nodes---deployment.png">
                    <strong>Select Nodes <span style="color:red">*</span></strong>
                </label>
                <div class="row">
                    <div class="col-lg-9">
                        <ul id="selectedNodesChefTask" class="deploymentNodeList selectedNodesChefTaskCSS">
                         
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-9 paddingleftright0">
        <div class="col-lg-12 paddingleftright0 margintop-56">
            <div class="panel-group smart-accordion-default" id="accordion-assigntask">
                <div class="panel panel-default divconfigureparameterrunlist">
                  <div class="panel-heading">
                      <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion-assigntask" href="#CollapseassignRunlist"> <i class="fa fa-fw fa-plus-circle txt-color-blue"></i> <i class="fa fa-fw fa-minus-circle txt-color-red"></i>Assign Runlist</a>
                      </h4>
                  </div>
                  <div id="CollapseassignRunlist" class="panel-collapse collapse in">
                    <div style="float:right;margin-right:60px;"><a style="font-size:14px!important" href="#modalForHelp" data-toggle="modal"><i class="fa fa-question"></i>&nbsp;Help</a>
                    </div>
                    <div class="col-lg-12 runlistContainer">
                        
                    </div>
                  </div>
                  <!--modal for help-->

<div class="modal fade" id="modalForHelp" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog " style="">
        <div class="modal-content"> 
            
             <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">
                    &nbsp;CookBook Information
                </h4>

            </div> 
            
            
             <div class="modal-body" style="height:400px;overflow-y:auto">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                        <th>CookBook Name</th>
                        <th>Description</th>
                        <tr>
                    </thead>
                    <tbody>
                        <tr>
                        <td>apache2-windows</td>
                        <td>Installation &amp; Configuration of Apache Server</td>
                        </tr>
                            <tr>
                                <td>apache2</td>
                                <td>Installation &amp; Configuration of Apache Server</td>
                            </tr>
                        <!--2nd set-->
                        <tr>
                        <td>cassandra</td>
                        <td>Installation and configuration of Cassandra Server</td>
                        </tr>
                            <tr>
                                <td>eclipse_windows</td>
                                <td>Installtion of Eclispe on Windows</td>
                            </tr>   
                            <!--3rd set-->

                        <tr>
                        <td>visualstudio_windows</td>
                        <td>Installation of Visual Studio</td>
                        </tr>
                            <tr>
                                <td>iis</td>
                                <td>Installation and configuration of IIS Server</td>
                            </tr>
                            <!--4th set-->
                        <tr>
                        <td>jboss7</td>
                        <td>Installation and Configuration of JBOSS7 Server</td>
                        </tr>
                            <tr>
                                <td>tomcat</td>
                                <td>Installs and configures Tomcat, Java servlet engine and webserver</td>
                            </tr>
                            <!--5th set-->
                            <tr>
                        <td>weblogic</td>
                        <td>Installation and Configuration of weblogic</td>
                        </tr>
                            <tr>
                                <td>java</td>
                                <td>Installation of Java</td>
                            </tr>
                            <!--6th set-->
                            <tr>
                        <td>java_windows</td>
                        <td>Installation of Java</td>
                        </tr>
                            <tr>
                                <td>nodejs</td>
                                <td>Installation of NodeJS and npm package</td>
                            </tr>   
                            <!--7th set-->

                            <tr>
                        <td>php</td>
                        <td>Installation and Configuration of PHP</td>
                        </tr>
                            <tr>
                                <td>lamp_role</td>
                                <td>Installation and Configuration of LAMP stack</td>
                            </tr>   

                            <!--8th set-->
                            <tr>
                        <td>mysql-windows</td>
                        <td>Installation and Configuration of Mysql</td>
                        </tr>
                            <tr>
                                <td>mysql</td>
                                <td>Installation and Configuration of Mysql</td>
                            </tr>   
                            <!--9th set-->

                            <tr>
                        <td>oracle_windows</td>
                        <td>Installation and Configuration of Oracle</td>
                        </tr>
                            <tr>
                                <td>postgresql</td>
                                <td>Installation and Configurationof postgresql</td>
                            </tr>   
                            <!--10th set-->
                            <tr>
                        <td>service_apache</td>
                        <td>Service cookbook for apache server</td>
                        </tr>
                            <tr>
                                <td>service_iptables</td>
                                <td>Service cookbook for firewall</td>
                            </tr>   

                            <!--11th set-->
                            <tr>
                        <td>service_jboss</td>
                        <td>Service cookbook for Jboss server</td>
                        </tr>
                            <tr>
                                <td>service_mysql</td>
                                <td>Service cookbook for Mysql</td>
                            </tr>   
                            <!--12th set-->
                            <tr>
                        <td>service_nginx</td>
                        <td>Service cookbook for nginx </td>
                        </tr>
                            <tr>
                                <td>service_tomcat</td>
                                <td>Service cookbook for tomcat</td>
                            </tr>   
                            <!--13th set-->
                            <tr>
                        <td>service_weblogic</td>
                        <td>service cookbook for weblogic</td>
                        </tr>
                            <tr>
                                <td>seven_zip</td>
                                <td>Installation of 7Zip</td>
                            </tr>
                            <!--14th set-->
                            <tr>
                        <td>git</td>
                        <td>Installs git and optionally sets up a git server as a daemon under runit</td>
                        </tr>
                            <tr>
                                <td>wget_windows</td>
                                <td>Installs wget on windows</td>
                            </tr>
                            <!--15th set-->
                            <tr>
                        <td>toad_windows</td>
                        <td>Installation and Configuration of TOAD</td>
                        </tr>
                            <tr>
                                <td>docker</td>
                                <td>Installation and Configuration of docker engine</td>
                            </tr>   
                            <tr>
                                <td>jenkins</td>
                                <td>Installs and configures Jenkins CI master &amp; node slaves.</td>
                            </tr>   
                    </tbody>
                </table>

            </div>
            
                <div class="modal-footer">
        
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                </div>   
  
         </div>
    </div>
</div>
                </div>

                <div class="panel panel-default divchefrunlist">
                    <div class="panel-heading">
                      <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion-assigntask" href="#CollapsecookbookAttributes" class="collapsed"><i class="fa fa-fw fa-plus-circle txt-color-blue"></i> <i class="fa fa-fw fa-minus-circle txt-color-red"></i>Cookbook Attributes</a>
                      </h4>
                    </div>
                    <div id="CollapsecookbookAttributes" class="panel-collapse collapse">
                        <div class="col-lg-12">
                            <div class="smart-form margin15">
                                <label class="marginbottom4">
                                    <img src="img/templateicons/Select-nodes---deployment.png">
                                    <strong>Cookbook Attributes 
                                        <a id="editAttributesBtn" class="bpEditBtn btn btn-primary editAttributesBtnCSS" rel="tooltip" data-placement="top" data-original-title="Edit">
                                            <i class="ace-icon fa fa-pencil"></i>
                                        </a>
                                        <span style="color:red" id="attrmessage"></span>
                                    </strong>
                                </label>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <textarea id="attrtextarea" style="width:100%;display:none" rows="6" onfocus="$('#attrmessage').html('');" onblur="validatejson($(this));" disabled> </textarea>
                                        <table id="attributesViewListTable" class="table table-striped table-bordered table-hover dataTable no-footer table-condensed tablesorter" cellpadding="5px" width="100%">
                                         <thead>
                                          <tr>
                                            <th>Attributes</th>
                                            <th>Values</th>
                                          </tr>
                                         </thead>
                                         <tbody class="attributesViewTableBody">

                                         </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
</div>
<div id="Jenkins-dropdown">
    <div class="col-lg-3 paddingleftright0">
        <div class="col-lg-12 margintop15">
            <label><b>Task Name</b><span style="color:red">*</span>
            </label>
            <div class="row">
                <div class="col-lg-10">
                    <input id="jenkinsTaskName" type="text" cat-validation="required,nospecial" cdata="catalyst" class="form-control inputTaskName" autofocus>                       
                </div>
            </div>              
        </div>
        <div class="col-lg-12 margintop15">
            <label><b>Select Jenkins Server</b><span style="color:red">*</span>
            </label>
            <div class="row">
                <div class="col-lg-10">
                    <select id="jenkinsServerList" class="width-100">
                        <option value="choose">Choose</option>
                        
                    </select>
                </div>
            </div>
        </div>
        <div class="col-lg-12 margintop15">
            <label><b>Select Job</b><span style="color:red">*</span></label>
            <div class="row">
                <div class="col-lg-10">
                    <select id="jobListJenkins" class="width-100" disabled>
                        
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
<!--
<div id="Custom-dropdown">
    <div class="col-lg-3 paddingleftright0">
        <div class="col-lg-12 margintop15">
            <label for="category"><b>Task Name</b><span style="color:red">*</span>
            </label>
            <div class="row">
                <div class="col-lg-10">
                    <input id="tasknameCustom" type="text" cat-validation="required,nospecial" cdata="catalyst" class="form-control inputTaskName" autofocus>
                </div>
            </div>             
        </div>
        
        <div class="col-lg-12 margintop15">
            <div class="smart-form marginleft15">
                    <label>
                        <img src="img/templateicons/Select-nodes---deployment.png">
                        <strong>Select Nodes <span style="color:red">*</span></strong>
                    </label>
                    <div class="row">
                        <div class="col-lg-9">
                            <ul id="selectedNodesCustomTask" class="deploymentNodeList">
                             
                            </ul>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    <div class="col-lg-9 paddingleftright0">
        <div class="col-lg-12 margintop15">
            <label><strong>Command Line</strong></label>
            <textarea rows="15" class="custom-scroll bordersolidgrey"></textarea> 
        </div>
    </div>
</div>-->
<div class="row">
        <div class="col-md-10 col-sm-12 col-xs-12 footerfixed">
            <div class="clearfix form-actions text-align-center">
                <div class="btn-group">
                    <a class="btn pull-left btn-primary btnSaveTask marginleft5px">
                        <i class="ace-icon fa fa-check bigger-110"></i>
                        Save Task
                    </a>  
                    <a class="btn pull-left btn-primary btnBack marginleft5px" onclick="window.history.back()">
                        <i class="ace-icon fa fa-rotate-left  bigger-110"></i>
                        Cancel
                    </a>                                     
                     
                </div>
            </div>
        </div>
</div>

<!--execute modal-->
<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="editAttributesModalContainer" class="modal fade" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">
                    x
                </button>
                <h4 class="modal-title">
                    <i class="fa fa-eraser txt-color-blue"></i>&nbsp;&nbsp;Edit Attributes
                </h4>
            </div>
            <div class="modal-body no-padding">
                <div class="loadingContainer">
                    <img class="center-block loadingContainerimageCSS" src="img/loading.gif" />
                </div>
                <div class="errorMsgContainer loadingerrorMsgContainerCSS"></div> 
                <form  class="attributesEditFormArea padding10" action="">
                    <table id="attributesEditListArea" class="table table-striped table-bordered table-hover dataTable no-footer table-condensed tablesorter" cellpadding="5px" width="100%">
                     <thead>
                      <tr>
                        <th>Attributes</th>
                        <th>Values</th>
                      </tr>
                     </thead>
                     <tbody class="attributesEditTableBody">

                     </tbody>
                    </table>
                    
                </form>
            </div>
           <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary saveAttribBtn">Save</button>
      </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!--/.modal-assignedExecute-->

<script type="text/javascript">


var urlParams = {};
(window.onpopstate = function() {
    var url = window.location.href;
    var indexOfQues = url.lastIndexOf("?");
    if (indexOfQues != -1) {
        var sub = url.substring(indexOfQues + 1);
        console.log(sub);
        var params = sub.split('&')
        for (var i = 0; i < params.length; i++) {
            var paramParts = params[i].split('=');
            urlParams[paramParts[0]] = paramParts[1];
        }
    }

})();

function validatejson(attrctrl){
    try{
        if(attrctrl.val().trim() != '')
            var attrjson = $.parseJSON(attrctrl.val());
    }catch(err){
        $('#attrmessage').html('Invalid JSON');
        $('#attrmessage').attr('title','Error:' + err);
    }
}

$(document).ready(function() {
    $(".chooseTasktype").select2();
    $("#jenkinsServerList").select2();
    $("#jobListJenkins").select2();
    $(".assignuserListJenkins").select2();

    
    $(document).on('shown.bs.modal', function(e) {
        $('[autofocus]', e.target).focus();
    });
    function loadUIData(taskData) {
        console.log(taskData);
        if(taskData) {
         //   alert(JSON.stringify(taskData));
            //debugger;
            $('.inputTaskName').val(taskData.name);
            $('#taskType').val(taskData.taskType);
            $('#taskType').change();
            $('#taskType').attr('disabled','disabled');
            //$('#taskType').val(taskData.taskType);
            if(taskData.taskConfig.attributes  && taskData.taskConfig.attributes.length)
                {
                    //$('#attrtextarea').text(JSON.stringify(taskData.taskConfig.attributesjson));
                     createAttribTableRowFromJson(taskData.taskConfig.attributes);
                      //createAttribTableRowFromJson([]);
                }
           // $('#attrtextarea').setValue(JSON.stringify(taskData.taskConfig.attributesjson));
        }

        
        $.get('../organizations/' + urlParams.org + '/businessgroups/'+urlParams['bg']+'/projects/' + urlParams.projid + '/environments/' + urlParams.envid + '/instances', function(data) {
            var $deploymentNodeList = $('.deploymentNodeList').empty();
            for (var i = 0; i < data.length; i++) {
                if (data[i].instanceState == 'running' || data[i].instanceState == 'pending' ||  data[i].instanceState == 'unknown') {
                    var checked = false;
                    if (taskData && taskData.taskType==='chef' && taskData.taskConfig.nodeIds && taskData.taskConfig.nodeIds.length) {
                        if (taskData.taskConfig.nodeIds.indexOf(data[i]._id) !== -1) {
                            checked = true;
                        }
                    }
                    var nodeName = data[i].chef.chefNodeName;
                    if(data[i].instanceIP) {
                        nodeName = data[i].instanceIP;
                    }
                    if(data[i].blueprintData && data[i].blueprintData.blueprintName) {
                        nodeName = data[i].blueprintData.blueprintName;
                    }
                    if(data[i].name) {
                        nodeName = data[i].name;
                    }

                    var $li = $('<li><label class="checkbox" style="margin: 5px;font-size:13px;"><input type="checkbox" name="deploymentNodesCheckBox" value="' + data[i]._id + '"><i></i>' + nodeName + '</label></li>');
                    if (checked) {
                        $li.find('input')[0].checked = true;
                        //$li.find('label').click();
                    }
                    $deploymentNodeList.append($li);
                }
            }
        });



        var runlist = null;
        if(taskData && taskData.taskType==='chef') {
            runlist = taskData.taskConfig.runlist;
        }
        var $ccrs = $chefCookbookRoleSelector(urlParams.org, function(data) {

        }, runlist,false,{
            deploy:true,
            all:true,
            roles:false,
            cookbooks:false
        });

        $.get('/organizations/'+urlParams.org+'/chefserver',function(data){
           console.log('chef logs ==> ',data);
           if(data && data.configname) {
            $('.chefServerName').val(data.configname);
           }
        });
        $('.runlistContainer').append($ccrs);
        $('#loadimageandtextlabel').find('.fontsize13').after("<span style='color:red'>*</span>");
        $('.runlistContainer').data('$ccrs',$ccrs);

        // jenkins 

        $.get('/jenkins/', function(jenkinsList) {
            jenkinsList = JSON.parse(jenkinsList);
            var $jenkinsServerListDropdown = $('#jenkinsServerList');
            for (var i = 0; i < jenkinsList.length; i++) {
             var keys = Object.keys(jenkinsList[i]);   
             var $option = $('<option></option>').val(jenkinsList[i][keys[0]]).html(keys[0]);
             $jenkinsServerListDropdown.append($option); 
            }
            //$jenkinsServerListDropdown.trigger();
           
            $jenkinsServerListDropdown.change(function(e){
                var jenkinsServerId = $(this).val();
                var $jobsList = $('#jobListJenkins').empty();
               $jobsList.prop("disabled", true);
                $.get('/jenkins/'+jenkinsServerId+'/jobs',function(jobsList){
                  for (var i = 0; i < jobsList.length; i++) {
                    var $option = $('<option></option>').val(jobsList[i].name).html(jobsList[i].name);
                    $jobsList.append($option);
                  }
                    $jobsList.prop("disabled", false);
                    if (taskData && taskData.taskType === 'jenkins') {
                        $jobsList.val(taskData.taskConfig.jobName);
                        $jobsList.change();
                    }
                });

            });

            if(taskData && taskData.taskType==='jenkins') {
                $jenkinsServerListDropdown.val(taskData.taskConfig.jenkinsServerId);
                $jenkinsServerListDropdown.change();
            }



        });

        $.get('../users', function(userList) {
            userList = JSON.parse(userList);
            var $userLists = $('.userLists').empty();
            userList.sort(function(a, b) {
                var keyA = Object.keys(a);
                var keyB = Object.keys(b);

                if (keyA[0] < keyB[0]) return -1;
                if (keyA[0] > keyB[0]) return 1;
                return 0;
            });
            
            for (var i = 0; i < userList.length; i++) {
                var keys = Object.keys(userList[i]);
                var $option = $('<option></option>').append(keys[0]).val(keys[0]);
                $userLists.append($option);
            }

        });


    }

    if (urlParams.taskId) {
        $.get('../tasks/'+urlParams.taskId, function(taskData) {
            loadUIData(taskData);
        });
    } else {
        loadUIData();
    }
    

    $('.btnSaveTask').click(function(e) {

        var taskType = $('#taskType').val();
        var taskData = {};
        
        taskData.taskType = taskType;
        //alert('value:' + $('#attrtextarea').val());
        if (taskType === 'chef') {
            var taskName = $('#chefTaskName').val();
            if (!taskName) {
                alert('Please enter a Task-Name');
                return;
            }
            taskData.name = taskName;
            var $selectedNodes = $('#selectedNodesChefTask input[type=checkbox]');

            console.log($selectedNodes.length);
            var nodesList = [];
            $selectedNodes.each(function() {
                if (this.checked) {
                    nodesList.push(this.value);
                }
            });
            if (!nodesList.length) {
                alert('Please choose nodes');
                return;
            }
            
            var $ccrs = $('.runlistContainer').data('$ccrs');
            var runlist = $ccrs.getSelectedRunlist();
            

            if (!runlist.length) {
                alert('Please choose runlist');
                return;
            }
            taskData.nodeIds = nodesList;
            taskData.runlist = runlist;
            //taskData.attributesjson = $('#attrtextarea').val().trim();
            $trAttribute = $('#attributesViewListTable').find('tbody tr');
            var attributes = [];
            $trAttribute.each(function(){
              var $tr = $(this);
              attributes.push({
                name : $tr.attr('data-attributeName'),
                jsonObj : $tr.data('jsonObj')
              });
            });
            taskData.attributes = attributes;
        } else if (taskType === 'jenkins') {
            var taskName = $('#jenkinsTaskName').val();
            if (!taskName) {
                alert('Please enter a Task-Name');
                return;
            }
            taskData.name = taskName;
           var jenkinsServerId = $('#jenkinsServerList').val();
           if(!jenkinsServerId) {
              alert('Please Choose a Jenkins Server');
              return;
           }

           var jenkinsJobName = $('#jobListJenkins').val();
           if(!jenkinsJobName && jenkinsJobName === 'choose') {
              alert('Please Choose a Jenkins Server');
              return;
           }
           var usersList = [].concat($('#jenkinsUserList').val());
           if(!usersList.length) {
              alert('Please Choose a users');
              return;
           }
          taskData.jenkinsServerId =  jenkinsServerId;
          taskData.jobName =  jenkinsJobName;
          taskData.users = usersList;
         
        } else {
            return;
        }

        
        

        var reqBody = {
            taskData: taskData
        };
        console.log(reqBody);

        if(urlParams.taskId) {
           $.post('../tasks/'+urlParams.taskId+'/update',reqBody,function(data){
                console.log(data);
                $('.btnBack').click();
           });
        } else {
          $.post('../organizations/' + urlParams.org + '/businessgroups/'+urlParams['bg']+'/projects/' + urlParams.projid + '/environments/' + urlParams.envid + '/tasks', reqBody, function(data) {
            console.log(data);
            $('.btnBack').click();
          });
       }

    });

    $('#editAttributesBtn').click(function(e){
        var $ccrs = $('.runlistContainer').data('$ccrs');
        var runlist = $ccrs.getSelectedRunlist();
        if(!runlist.length) {
           alert('Please choose a runlist first');
           return false;
        }
        var $modal = $('#editAttributesModalContainer');
        $modal.find('.attributesEditFormArea').hide();
        $modal.find('.errorMsgContainer').hide();
        $modal.find('.loadingContainer').show();
        $modal.modal('show');
        
        var reqBody = {
            cookbooks: [],
            roles: []
        }
        for (var i = 0; i < runlist.length; i++) {
           
            if (runlist[i].indexOf('recipe') === 0) {
                className = 'cookbook';
            } else {
                className = 'roles';
            }
            var name = '';
            var item = runlist[i];
            var indexOfBracketOpen = item.indexOf('[');
            if (indexOfBracketOpen != -1) {
                var indexOfBracketClose = item.indexOf(']');
                if (indexOfBracketClose != -1) {
                    name = item.substring(indexOfBracketOpen + 1, indexOfBracketClose);
                }
            }
            if (runlist[i].indexOf('recipe') === 0) {
                reqBody.cookbooks.push(name);
            } else {
                reqBody.roles.push(name);
            }
          
        }
        //var chefServerId = $chefCookbookRoleSelector.getChefServerId();
        var $ccrs = $('.runlistContainer').data('$ccrs');
        var chefServerId = $ccrs.getChefServerId();
        $.post('../chef/servers/' + chefServerId + '/attributes', reqBody, function(attributesList) {
            //var dataTable = $('#attributesEditListArea').DataTable();
            //dataTable.clear();
            var $tbody = $modal.find('.attributesEditTableBody');
            $tbody.empty();
            var $tbodyViewAttributes = $('#attributesViewListTable').find('tbody');
            for (var i = 0; i < attributesList.length; i++) {
                var attributesNamesList = Object.keys(attributesList[i].attributes);
                for (var j = 0; j < attributesNamesList.length;j++) {
                    var $tr = $('<tr/>');
                    var displayName = attributesNamesList[j];
                    if( attributesList[i].attributes[attributesNamesList[j]].display_name) {
                        displayName = attributesList[i].attributes[attributesNamesList[j]].display_name;
                    }
                    var $tdAttribName = $('<td/>').html(displayName);
                    var value = '';
                    if(attributesList[i].attributes[attributesNamesList[j]]['default']) {
                      value =  attributesList[i].attributes[attributesNamesList[j]]['default'];
                    }
                    var $trView = $tbodyViewAttributes.find('tr[data-attributeKey="'+attributesNamesList[j]+'"]');
                    if($trView.length) {
                        value = $trView.attr('data-attributeValue');
                    }
                    
                    var $attributeInput;
                    var choices = attributesList[i].attributes[attributesNamesList[j]].choice;
                    if (choices && choices.length) {
                        $attributeInput = $('<select class="attribValueInput" data-attribKey="'+attributesNamesList[j]+'" data-attribName="'+displayName+'"></select>');
                        for (var k = 0; k < choices.length; k++) {
                           var $option = $('<option></option>').val(choices[k]).html(choices[k]);
                           $attributeInput.append($option);
                        }
                        $attributeInput.val(value);
                    } else {
                       $attributeInput = $('<input type="text" class="attribValueInput" data-attribKey="'+attributesNamesList[j]+'" value="'+value+'" data-attribName="'+displayName+'"/>');
                    }


                    
                    var $tdAttribEditor = $('<td/>').append($attributeInput);
                    $tr.append($tdAttribName).append($tdAttribEditor);
                    //dataTable.row.add($tr).draw();
                    $tbody.append($tr)
                }
            }
            $modal.find('.errorMsgContainer').hide();
            $modal.find('.loadingContainer').hide();
            $modal.find('.attributesEditFormArea').show();
            
        }).fail(function(e){
            $modal.find('.errorMsgContainer').html('Unable to fetch attributes. Please try again later').show();
            $modal.find('.loadingContainer').hide();
            $modal.find('.attributesEditFormArea').hide();
        });
        return false;
    });

    function createAttribTableRowFromJson(attributes) {
        var $table = $('#attributesViewListTable');
        var $tbody = $table.find('tbody').empty();
        console.log(attributes);
        for (var j = 0; j < attributes.length; j++) {
             var attributeObj = attributes[j].jsonObj;
            function getVal(obj, currentKey) {
                var keys = Object.keys(obj);
                for (var i = 0; i < keys.length; i++) {
                    if (typeof obj[keys[i]] === 'object') {
                        getVal(obj[keys[i]], currentKey + '/' + keys[i]);
                    } else {
                        var keyString = currentKey + '/' + keys[i];
                        keyString = keyString.substring(1);
                        
                        var $tr = $('<tr/>').attr({
                            'data-attributeKey': keyString,
                            'data-attributeValue': obj[keys[i]],
                            'data-attributeName': attributes[j].name
                        }).data('jsonObj',attributes[j].jsonObj);;
                        var $tdAttributeKey = $('<td/>').html(attributes[j].name);
                        var $tdAttributeVal = $('<td/>').html(obj[keys[i]]);
                        $tr.append($tdAttributeKey).append($tdAttributeVal);
                        $tbody.append($tr);
                    }
                }
            }
            getVal(attributeObj, '');
        }
    }

    $('.saveAttribBtn').click(function(e) {
        var $modal = $('#editAttributesModalContainer');
        var $tbody = $modal.find('.attributesEditTableBody');
        var $input = $tbody.find('.attribValueInput');
        var attributes = [];
        $input.each(function() {
            var $this = $(this);
            var attributeKey = $this.attr('data-attribKey');
            console.log(attributeKey);
            var attribValue = $this.val();
            if (attribValue) {
                var attribPathParts = attributeKey.split('/');
                var attributeObj = {};
                var currentObj = attributeObj;
                for (var i = 0; i < attribPathParts.length; i++) {
                    if (!currentObj[attribPathParts[i]]) {
                        if (i === attribPathParts.length - 1) {
                            currentObj[attribPathParts[i]] = attribValue;
                            continue;
                        } else {
                            currentObj[attribPathParts[i]] = {};
                        }
                    }
                    currentObj = currentObj[attribPathParts[i]];
                }
                attributes.push({
                    name: $this.attr('data-attribName'),
                    jsonObj: attributeObj
                });
            }
        });
        console.log('attributeObj ==>', attributes);
        //$('#attrtextarea').text(JSON.stringify(attributeObj));
        createAttribTableRowFromJson(attributes);
        $modal.modal('hide');

    });



    $("#Jenkins-dropdown").hide();
   // $("#Custom-dropdown").hide();

    $('#taskType').change(function(e) {
        if (this.value == "chef") {
            $("#Jenkins-dropdown").hide();
           // $("#Custom-dropdown").hide();
            $("#chef-dropdown").show();
        } else if (this.value == "jenkins") {
            $("#Jenkins-dropdown").show();
           // $("#Custom-dropdown").hide();
            $("#chef-dropdown").hide();
        }/* else {
            $("#Jenkins-dropdown").hide();
            $("#Custom-dropdown").show();
            $("#chef-dropdown").hide();
        }*/
    });

    /*if (!$.fn.dataTable.isDataTable('#attributesEditListArea')) {
        //var $taskListArea = $('.taskListArea').empty();
        $taskDatatable = $('#attributesEditListArea').DataTable({
            "pagingType": "full_numbers",
            "aoColumns": [
                null, {
                    "bSortable": false
                }
            ]

        });
    }*/

});


$(document).ready(function() {
    var LocalBreadCrumb = localStorage.getItem("breadcrumb");
    var splitBread = null;
    if (LocalBreadCrumb != null && LocalBreadCrumb != 'undefined') {
        localStorage.removeItem("breadcrumb");
        splitBread = LocalBreadCrumb.split('>');
        if (splitBread.length > 0) {
            $('#ribbon').find('.breadcrumb').find('li').detach();
            for (var arraycount = 0; arraycount < splitBread.length; arraycount++) {
                var liNew = document.createElement('li');
                liNew.innerHTML = splitBread[arraycount];
                $('#ribbon').find('.breadcrumb').append(liNew);
            }
            var parentUl = $('li').filter(".referenceliClass.open").find('ul').find('li[data-envname=' + splitBread[3] + ']');
            parentUl.addClass('active');
        }
    }
});
//$('#loadimageandtextlabel').find('.fontsize13').text(Runlist);
</script>

