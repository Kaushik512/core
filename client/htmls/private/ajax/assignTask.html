<form action=""> 
        
            <div class="col-lg-4">
                <label>
                    <strong>Select Task Type</strong>
                </label>
                <div class="row">
                    <div class="col-lg-10">
                        
                            <select class="chooseTasktype width-100">
                                <option id="Chef" value="Chef">Chef</option>
                                <option id="Jenkins" value="Jenkins">Jenkins</option>
                                <option id="Custom" value="Custom">Custom</option>
                            </select>
                        
                    </div>  
                </div>
            </div>
        
    

<div id="chef-dropdown">
    
        
            <div class="col-lg-4">
                <label>
                    <strong>Task Name <span style="color:red">*</span></strong>
                </label>
                <div class="row">
                    <div class="col-lg-10">
                        
                            <input type="text" cat-validation="required,nospecial" cdata="catalyst" class="form-control inputTaskName" name="ctl00$MainContent$orgname" autofocus>
                        
                    </div>  
                </div>
            </div>
            <div class="col-lg-4">
                <label>
                    <strong>Chef Server Name</strong>
                </label>
                <div class="row">
                    <div class="col-lg-10">
                        
                            
                            <input type="text" class="form-control chefServerName" placeholder="" disabled>
                        
                    </div>  
                </div>
            </div>
                   
        
    
        
           
            <div class="col-lg-4" style="margin-top:15px;">
                <div class="smart-form" style="margin-left:15px";>
                <label>
                    <img src="img/templateicons/Select-nodes---deployment.png">
                    <strong>Select Nodes <span style="color:red">*</span></strong>
                </label>
                <div class="row">
                    <div class="col-lg-9">
                        <ul id="selectedNodesChefTask" class="deploymentNodeList" style="border:1px solid #dddddd;list-style:none outside none;height:200px;overflow-y:auto;">
                         
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div class="col-lg-7 runlistContainer" style="margin-top:15px;">
        </div> -->

        <div class="col-lg-8 runlistContainer" style="margin-top:15px;padding-left:0px;">
        </div>
    </form>
</div>
<div id="Jenkins-dropdown">
    

        
            
            <div class="col-lg-4">
                <label><b>Task Name</b><span style="color:red">*</span>
                </label>
                <div class="row">
                    <div class="col-lg-10">
                <input id="tasknameJenkins" type="text" cat-validation="required,nospecial" cdata="catalyst" class="form-control inputTaskName" autofocus>
                                           
                </div>
                </div>              
            </div>
            <div class="col-lg-4">
                <label><b>Select Jenkins Server</b><span style="color:red">*</span>
                </label>
                    <div class="row">
                    <div class="col-lg-10">
                    <select id="jenkinsServerList" class="width-100">
                        <option value="choose">Choose</option>
                        
                    </select>
                  
                </div>
            </div>
            </div>
            <div class="col-lg-4" style="margin-top:15px;">
                <label><b>Select Job</b><span style="color:red">*</span></label>
                <div class="row">
                    <div class="col-lg-10">
                    <select id="jobListJenkins" class="width-100">
                        <option value="choose">Choose</option>
                        
                    </select>
               </div>
           </div>
            </div>
            <div class="col-lg-6" style="margin-top:15px;">
                <label><strong>Assign Users</strong><span style="color:red">*</span></label>
                <div class="row">
                    <div class="col-lg-7">
                    <select multiple="" class="custom-scroll">
                        <option value="administrator">administrator</option>
                        <option value="consumer1">consumer</option>
                        <option value="designer1">designer</option>
                    </select>
                </div>
            </div>
                
            </div> 
        
    
</div>
<div id="Custom-dropdown">
    

        
            
            <div class="col-lg-4">
                <label for="category"><b>Task Name</b><span style="color:red">*</span>
                </label>
                <div class="row">
                    <div class="col-lg-10">
                <input id="tasknameCustom" type="text" cat-validation="required,nospecial" cdata="catalyst" class="form-control inputTaskName" autofocus>
                    </div>
                </div>                                 
            </div>
            <div class="col-lg-4">
              <label><strong>Command Line</strong></label>
              
                <textarea rows="3" class="custom-scroll"></textarea> 
              
              <!-- <div class="note">
                <strong>Note:</strong> expands on focus.
              </div> -->
            </div>
            <div class="col-lg-4">
                <div class="smart-form" style="margin-left:15px">
                <label>
                    <img src="img/templateicons/Select-nodes---deployment.png">
                    <strong>Select Nodes <span style="color:red">*</span></strong>
                </label>
                <div class="row">
                    <div class="col-lg-9">
                        <ul id="selectedNodesCustomTask" class="deploymentNodeList" style="border:1px solid #dddddd;list-style:none outside none;height:200px;overflow-y:auto;">
                         
                        </ul>
                    </div>
                </div>
            </div>
        </div>
            
            <div class="col-lg-4">
                <label><strong>Assign Users</strong><span style="color:red">*</span></label>
                <div class="row">
                    <div class="col-lg-10">
                    <select multiple="" class="custom-scroll">
                        <option value="administrator">administrator</option>
                        <option value="consumer1">consumer</option>
                        <option value="designer1">designer</option>
                    </select>
                </div>
            </div>
            </div> 
        
    
</div>
<div class="row">
        <div style="bottom:0px;position:fixed" class="col-md-10 col-sm-12 col-xs-12">
            <div style="text-align:center" class="clearfix form-actions">
                <div class="btn-group">
                    <a style="margin-left:5px" class="btn pull-left btn-primary btnSaveTask">
                        <i class="ace-icon fa fa-check bigger-110"></i>
                        Save Task
                    </a>  
                    <a style="margin-left:5px" class="btn pull-left btn-primary btnBack" onclick="window.history.back()">
                        <i class="ace-icon fa fa-rotate-left  bigger-110"></i>
                        Cancel
                    </a>                                     
                     
                </div>
            </div>
        </div>
</div>
<script type="text/javascript">


var urlParams = {};
(window.onpopstate = function() {
    var url = window.location.href;
    var indexOfQues = url.lastIndexOf("?");
    if (indexOfQues != -1) {
        var sub = url.substring(indexOfQues + 1);
        console.log(sub);
        var params = sub.split('&')
        for (var i = 0; i < params.length; i++) {
            var paramParts = params[i].split('=');
            urlParams[paramParts[0]] = paramParts[1];
        }
    }

})();


$(document).ready(function() {
    $(".chooseTasktype").select2();
    $("#jenkinsServerList").select2();
    $("#jobListJenkins").select2();
    $(".assignuserListJenkins").select2();
    $(document).on('shown.bs.modal', function(e) {
        $('[autofocus]', e.target).focus();
    });
    function loadUIData(taskData) {

        if(taskData) {
            $('.inputTaskName').val(taskData.name);
        }
        
        $.get('../organizations/' + urlParams.org + '/businessgroups/'+urlParams['bg']+'/projects/' + urlParams.projid + '/environments/' + urlParams.envid + '/instances', function(data) {
            var $deploymentNodeList = $('.deploymentNodeList').empty();
            for (var i = 0; i < data.length; i++) {
                if (data[i].instanceState == 'running' || data[i].instanceState == 'pending' ||  data[i].instanceState == 'unknown') {
                    var checked = false;
                    if (taskData && taskData.nodesIdList && taskData.nodesIdList.length) {
                        if (taskData.nodesIdList.indexOf(data[i]._id) !== -1) {
                            checked = true;
                        }
                    }
                    var $li = $('<li><label class="checkbox" style="margin: 5px;font-size:13px;"><input type="checkbox" name="deploymentNodesCheckBox" value="' + data[i]._id + '"><i></i>' + data[i].chef.chefNodeName + '</label></li>');
                    if (checked) {
                        $li.find('input')[0].checked = true;
                        //$li.find('label').click();
                    }
                    $deploymentNodeList.append($li);
                }
            }
        });



        var runlist = null;
        if(taskData) {
            runlist = taskData.runlist;
        }
        var $ccrs = $chefCookbookRoleSelector(urlParams.org, function(data) {

        }, runlist);

        $.get('/organizations/'+urlParams.org+'/chefserver',function(data){
           console.log('chef logs ==> ',data);
           if(data && data.configname) {
            $('.chefServerName').val(data.configname);
           }
        });
        $('.runlistContainer').append($ccrs);

        // jenkins 

        $.get('/jenkins/', function(jenkinsList) {
            jenkinsList = JSON.parse(jenkinsList);
            var $jenkinsServerListDropdown = $('#jenkinsServerList');
            for (var i = 0; i < jenkinsList.length; i++) {
             var keys = Object.keys(jenkinsList[i]);   
             var $option = $('<option></option>').val(jenkinsList[i][keys[0]]).html(keys[0]);
             $jenkinsServerListDropdown.append($option); 
            }
            //$jenkinsServerListDropdown.trigger();
            $jenkinsServerListDropdown.change(function(e){
                var jenkinsServerId = $(this).val();
                var $jobsList = $('#jobListJenkins').empty();
                $.get('/jenkins/'+jenkinsServerId+'/jobs',function(jobsList){
                  for (var i = 0; i < jobsList.length; i++) {
                    var $option = $('<option></option>').val(jobsList[i].name).html(jobsList[i].name);
                    $jobsList.append($option);
                  }
                });

            });
        });


    }

    if (urlParams.taskId) {
        $.get('../tasks/'+urlParams.taskId, function(taskData) {
            loadUIData(taskData);
        });
    } else {
        loadUIData();
    }
    

    $('.btnSaveTask').click(function(e) {
        if (!$("#chef-dropdown").is(':visible')) {
            return;
        }

        var $selectedNodes = $('#selectedNodesChefTask input[type=checkbox]');
        console.log($selectedNodes.length);
        var nodesList = [];
        $selectedNodes.each(function() {
            console.log('checked ==> '+this.checked);
            if(this.checked) {
             nodesList.push(this.value);
            }
        });
        if (!nodesList.length) {
            alert('Please choose nodes');
            return;
        }

        var $selectedRunlist = $('.deploymentSelectedRunList input');
        var runlist = [];
        $selectedRunlist.each(function() {
            runlist.push(this.value);
        });

        if (!runlist.length) {
            alert('Please choose runlist');
            return;
        }
        var taskName = $('.inputTaskName').val();
        if (!taskName) {
            alert('Please give a name');
            return;
        }

        var reqBody = {
            taskData: {
                name: taskName,
                nodesIdList: nodesList,
                runlist: runlist,
            }
        };

        if(urlParams.taskId) {
           $.post('../tasks/'+urlParams.taskId+'/update',reqBody,function(data){
                console.log(data);
                $('.btnBack').click();
           });
        } else {
          $.post('../organizations/' + urlParams.org + '/businessgroups/'+urlParams['bg']+'/projects/' + urlParams.projid + '/environments/' + urlParams.envid + '/tasks', reqBody, function(data) {
            console.log(data);
            $('.btnBack').click();
          });
       }

    });

    $("#Jenkins-dropdown").hide();
    $("#Custom-dropdown").hide();

    $('.chooseTasktype').change(function(e) {
        if (this.value == "Chef") {
            $("#Jenkins-dropdown").hide();
            $("#Custom-dropdown").hide();
            $("#chef-dropdown").show();
        } else if (this.value == "Jenkins") {
            $("#Jenkins-dropdown").show();
            $("#Custom-dropdown").hide();
            $("#chef-dropdown").hide();
        } else {
            $("#Jenkins-dropdown").hide();
            $("#Custom-dropdown").show();
            $("#chef-dropdown").hide();
        }
    });

   


});


$(document).ready(function() {
    var LocalBreadCrumb = localStorage.getItem("breadcrumb");
    var splitBread = null;
    if (LocalBreadCrumb != null && LocalBreadCrumb != 'undefined') {
        localStorage.removeItem("breadcrumb");
        splitBread = LocalBreadCrumb.split('>');
        if (splitBread.length > 0) {
            $('#ribbon').find('.breadcrumb').find('li').detach();
            for (var arraycount = 0; arraycount < splitBread.length; arraycount++) {
                var liNew = document.createElement('li');
                liNew.innerHTML = splitBread[arraycount];
                $('#ribbon').find('.breadcrumb').append(liNew);
            }
            var parentUl = $('li').filter(".referenceliClass.open").find('ul').find('li[data-envname=' + splitBread[3] + ']');
            parentUl.addClass('active');
        }
    }
});

</script>

