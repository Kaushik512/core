<style type="text/css">
  input{
    border:1px solid #cccccc;
  }
</style>
<div class="col-lg-6 col-md-6 availableApp" style="padding-left: 0px; margin-bottom: 15px;">
  <label for="chooseApplication">Choose Available Application:<span style="color:red">*</span></label>
  <div class="input-groups">
    <select id="chooseApplication" name="chooseApplication" class="required chooseApplication width-100">
    </select>
  </div>                                                      
</div>
<div class="col-lg-6 col-md-6">
  <div class="panel-heading">
    <span class="pull-right swap-view">
        <a class="btn btn-primary envAppDeployModal" href="#modalAppCardDetails" data-toggle="modal" style="margin-top: 10px;">
          <span style="font-weight: bold;">Add Application</span>
          <i title="Add Application Details" class="fa fa-plus fa-2x" style="color:#ffffff;cursor:pointer;font-size:13px;"></i>
        </a>
    </span>
  </div>
</div>
<div class="row">
  <article class="col-sm-12 col-md-12 col-lg-12">
    <div class="widget-body font-size12" id="widgetAppDeploy">
      <ul id="myTab3" class="nav nav-tabs tabs-pull-left">
          <li class="pull-left active">
              <a href="#l1" data-toggle="tab"><i class="fa fa-shield"></i>&nbsp;Application Deployment<span id="appDeployName"></span></a>
          </li>
      </ul>
      <div id="myTabContent3" class="nav tab-content">
        <div class="tab-pane active" id="l1">
          <div class="panel-group smart-accordion-default" id="accordion-AppDeploy">
           
          </div>
        </div>
      </div>
    </div>
  </article>
</div>
<div class="accordianTemplateContainer" style="display:none">
  <div class="panel panel-default accordianTemplate">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a class="envAppDeployAnchor" data-toggle="collapse" data-parent="#accordion-AppDeploy" href="#collapseAppEnv1"> 
            <i class="fa fa-fw fa-plus-circle txt-color-blue"></i> 
            <i class="fa fa-fw fa-minus-circle txt-color-red"></i>
            <b style="font-size:12px;" class="envAppDeployName"><u></u></b>
          </a>
        </h4>
      </div>
      <div id="collapseAppEnv1" class="panel-collapse collapse in envAppDeployAccordian" style="padding: 5px;">
        <div class="table-responsive table-div">
          <table id="tableappDeploydetails" class="table table-striped table-bordered table-hover dataTable envAppDeployTable" style="border:1px solid #eeeeee !important; text-align:center;font-size:12px;margin-top:45px;" width="100%" cellpadding="5px">
                <thead>
                    <tr class="rowCustomStyle" style="font-weight:bold;">
                        <td style="color:#fff;background-color: #2c3742;">S.No.</td>
                        <td style="color:#fff;background-color: #2c3742;">App Name</td>
                        <td style="color:#fff;background-color: #2c3742;">App-Instance Name</td>
                        <td style="color:#fff;background-color: #2c3742;">Version</td>
                        <td style="color:#fff;background-color: #2c3742;">Node IP</td>
                        <td style="color:#fff;background-color: #2c3742;">Last Deploy</td>
                        <td style="color:#fff;background-color: #2c3742;">Status</td>
                        <!-- <td style="color:#fff;background-color: #2c3742;">App Links</td>
                        <td style="color:#fff;background-color: #2c3742;">Action</td> -->
                    </tr>
                </thead>
                <tbody>                   
                </tbody>                   
          </table>                
        </div>
      </div>
  </div>
</div>

<div class="modal fade" id="modalAppCardDetails" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
          <form role="form" id="formAppDeploy" autocomplete="off">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    X
                </button>
                <h4 class="modal-title">
                    <i class="fa fa-th-list txt-color-blue"></i>&nbsp;&nbsp;Associate App Deploy<span style="color:red;font-size:12px" id="errorParam"></span>
                </h4>
            </div>
           
            <div class="modal-body">
                <div class="addApptoAppend">
                  <div style="margin:5px 0px 0px;" class="row application4Params">
                    <div style="padding-left:0px;" class="col-lg-6">
                      <label for="name">Application Name:
                      </label>
                      <input type="text" autofocus="" style="height:36px;" class="form-control" id="appNameInput">
                    </div>
                    <div style="padding-left:0px;" class="col-lg-6">
                      <label for="name">Description:
                      </label>
                      <input type="text" style="height:36px;" class="form-control" id="applicationDescriptionInput">
                    </div>
                  </div>
                </div>
                <!-- <div class="table-responsive table-div">
                  <table id="tableappParamDeploy" class="table table-striped table-bordered table-hover dataTable" style="border:1px solid #eeeeee !important; text-align:center;font-size:12px;margin-top:45px;" width="100%" cellpadding="5px">
                        <thead>
                            <tr class="rowCustomStyle" style="font-weight:bold;">
                                <td style="color:#fff;background-color: #2c3742;">S.No.</td>
                                <td style="color:#fff;background-color: #2c3742;">Application Name</td>
                                <td style="color:#fff;background-color: #2c3742;">Application Description</td>
                            </tr>
                        </thead>
                        <tbody>                   
                        </tbody>                   
                  </table>                
                </div> -->
            </div>
             <div class="modal-footer">
                <div class="btn-group" style="margin-left:200px;">                                 
                 <a class="btn btn-primary parameterAppDeploySaveBtn">
                    <i class="ace-icon fa fa-save bigger-110"></i>
                    Save
                </a>
                <a style="margin-left:10px;" class="btn btn-primary cancelAppDeploy" data-dismiss="modal">
                    <i class="ace-icon fa fa-undo bigger-110"></i>
                    Cancel
                </a>
                </div>
              </div>
             </form>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function (){
  loadAppData();
});
$('.envAppDeployModal').click(function(e) {
     $('#formAppDeploy').trigger("reset");
     $("#errorParam").empty();
 });
if (!$.fn.dataTable.isDataTable('#tableappParamDeploy')) {
    $('#tableappParamDeploy').DataTable({
        "pagingType": "full_numbers",
        "iDisplayLength": 5,
        "aLengthMenu": [
            [5, 40, 100, -1],
            [5, 40, 100, "All"]
        ],
        "aoColumns": [{
                "bSortable": true
            }, {
                "bSortable": true
            }, {
                "bSortable": true
            }
        ]
    });
}
$("#tableappParamDeploy_length").hide();
$("#tableappParamDeploy_filter").hide();
  var urlParams = {};
  (window.onpopstate = function() {
      var url = window.location.href;
      var indexOfQues = url.lastIndexOf("?");
      if (indexOfQues != -1) {
          var sub = url.substring(indexOfQues + 1);
          console.log(sub);
          var params = sub.split('&')
          for (var i = 0; i < params.length; i++) {
              var paramParts = params[i].split('=');
              urlParams[paramParts[0]] = paramParts[1];
          }
      }
  })();
  $('#widgetAppDeploy').hide();
  $('.parameterAppDeploySaveBtn').on("click", function() {
      var dataDeploy ={
        "appDeployData":{
          "description" : "",
          "projectId": ""
        }
      };
      var applicationName = $('#appNameInput').val();
      var applicationDescription = $('#applicationDescriptionInput').val();
      var projectId = urlParams.projid;
     
      //dataDeploy.appDeployData.applicationName= applicationName;
      dataDeploy.appDeployData.description = applicationDescription;
      dataDeploy.appDeployData.projectId = projectId;
      console.log(JSON.stringify(dataDeploy));

      $.ajax({
          url: '/app/deploy/'+applicationName+'/update',
          data: JSON.stringify(dataDeploy),
          type: 'POST',
          contentType: "application/json",
          success: function(data) {
              console.log(data);
              var $chooseApplication = $('#chooseApplication');
              $chooseApplication.empty();
              $('.parameterAppDeploySaveBtn').attr("data-dismiss","modal");
              loadAppData();
          },
          error: function(jqxhr) {
            $("#errorParam").empty();
            $("#errorParam").append("    "+jqxhr.responseText);
           // $('#formAppDeploy')[0].reset();
            //alert(data.responseText);
          }
      });
  });
  function loadAppData(){
  $.get('/app/deploy', function(data) {
    var $chooseApplication = $('#chooseApplication');
    $chooseApplication.append('<option value="">Select Application</option>');
    var applicationNameArr = [];
    $.each(data, function(key, val) {
      if(val.projectId){
        applicationNameArr.push(val.applicationName);
      }
    });

    var uniqueAppName = unique(applicationNameArr);

    $.each(uniqueAppName, function(key, val) {
        $option = $('<option data-applicationName="' + val + '" value="' + val + '">' + val + '</option>');
        $option.data('selectedAppName', val);
        $chooseApplication.append($option);
    });

    function unique(list) {
        var result = [];
        $.each(list, function(i, e) {
            if ($.inArray(e, result) == -1) result.push(e);
        });
        return result;
    }
    $chooseApplication.change(function(e) {
      $("#accordion-AppDeploy").empty();
      $selectedOption = $(this).find('option:selected');
      var selectedAppName = $selectedOption.data('selectedAppName');
      console.log(selectedAppName);
      if (typeof selectedAppName != 'undefined') {
          $('#appDeployName').append().text("  for '" + selectedAppName + "'");
          $('#widgetAppDeploy').show();
      } else {
          $('#appDeployName').append().text("");
          $('#widgetAppDeploy').hide();
      }
      var $accordianTemplate = $('.accordianTemplateContainer').find('.accordianTemplate');
      var dataenvAccordianName;
      for (var i = 0; i < data.length; i++) {
        if(data[i].projectId){
        dataenvAccordianName = '';
        applicationNameArr.push(data[i].applicationName);
        if (selectedAppName == data[i].applicationName) {
          var $clone = $accordianTemplate.clone(true);
          if($('#' + data[i].envId + '_parentAccordian').length == 0){
            $clone.attr('id', data[i].envId + '_parentAccordian');
            $clone.find('.envAppDeployAnchor').attr('data-parent', '#' + data[i].envId + '_parentAccordian');
            if(typeof data[i].envId == 'undefined'){
              dataenvAccordianName = '';
            }else{
              dataenvAccordianName = data[i].envId;
            }
            $clone.find('.envAppDeployName').html(dataenvAccordianName);
            $clone.find('.envAppDeployAnchor').attr('href', '#' + data[i].envId + '_accordian');
            $clone.find('.envAppDeployAccordian').attr('id', data[i].envId + '_accordian');
            $clone.find('.envAppDeployTable').attr('id', data[i].envId + '_tableappDeploydetails');
            $('#accordion-AppDeploy').append($clone);
            // if(dataenvAccordianName == ''){
            //   $('#' + data[i].envId + '_parentAccordian').hide();
            // }
            if (!$.fn.dataTable.isDataTable('#' + data[i].envId + '_tableappDeploydetails')) {
              $('#' + data[i].envId + '_tableappDeploydetails').DataTable({
                  "pagingType": "full_numbers",
                  "iDisplayLength": 5,
                  "aLengthMenu": [
                      [5, 40, 100, -1],
                      [5, 40, 100, "All"]
                  ],
                  "aoColumns": [{
                      "bSortable": true
                  }, {
                      "bSortable": true
                  }, {
                      "bSortable": true
                  }, {
                      "bSortable": true
                  }, {
                      "bSortable": true
                  }, 
                  // {
                  //     "bSortable": true
                  // }, {
                  //     "bSortable": true
                  // }, 
                  {
                      "bSortable": true
                  }, {
                      "bSortable": false
                  }]
              });
            }
          }
          var $taskenvArray = $('#' + data[i].envId + '_tableappDeploydetails');
          var rowindex = $taskenvArray.dataTable().fnGetData().length;
          // if (data[i].applicationStatus == "Successful") {
          //     data[i].applicationStatus = '<img src="img/indicator_started.png">';
          // } else if (data[i].applicationStatus == "Failure") {
          //     data[i].applicationStatus = '<img src="img/indicator_stopped.png">';
          // } else {
          //     data[i].applicationStatus = '<img src="img/indicator_unknown.png">';
          // }
          var appLinks = '<img style="height: 18px;margin-left: -5px;"src="img/projectdemo/app-performanceblack.png" title="App-Performance"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/logsblack.png" title="App-Logs"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/code_healthblack.png" title="Code-Health"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/UI_performanceblack.png" title="UI-Performance">';
          var upgrade = '<div class="updateupgrade" style="margin-left:30%;" title="Upgrade"></div>';
          $taskenvArray.dataTable().fnAddData([
            rowindex + 1,
            data[i].applicationName,
            data[i].applicationInstanceName,
            data[i].applicationVersion,
            data[i].applicationNodeIP,
            data[i].applicationLastDeploy,
            data[i].applicationStatus,
            // appLinks,
            // upgrade
          ]);
        }
      }}
    });
    $chooseApplication.select2();
  });
}
</script>