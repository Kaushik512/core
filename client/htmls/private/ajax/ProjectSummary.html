<style type="text/css">
  input{
    border:1px solid #cccccc;
  }
</style>
<div class="col-lg-6 col-md-6 availableApp" style="padding-left: 0px; margin-bottom: 15px;">
  <label for="chooseApplication">Choose Available Application:<span style="color:red">*</span></label>
  <div class="input-groups">
    <select id="chooseApplication" name="chooseApplication" class="required chooseApplication width-100">
    <option data-selectedAppName="All Application" value="">All Application</option>
    </select>
  </div>                                                      
</div>
<div class="col-lg-6 col-md-6">
  <div class="panel-heading">
    <span class="pull-right swap-view">
      <a class="btn btn-primary envAppDeployList" href="#modalAppCardTableDetails" data-toggle="modal" style="margin-top: 15px;">
        <span style="font-weight: bold;">List of Application</span>
        <i title="Add Application Details" class="fa fa-list fa-2x" style="color:#ffffff;cursor:pointer;font-size:13px;"></i>
      </a>
      <a class="btn btn-primary envAppDeployModal" href="#modalAppCardDetails" data-toggle="modal" style="margin-top: 15px;">
        <span style="font-weight: bold;">Add Application</span>
        <i title="Add Application Details" class="fa fa-plus fa-2x" style="color:#ffffff;cursor:pointer;font-size:13px;"></i>
      </a>
    </span>
  </div>
</div>
<div class="row">
  <article class="col-sm-12 col-md-12 col-lg-12">
    <div class="widget-body font-size12" id="widgetAppDeploy">
      <ul id="myTab3" class="nav nav-tabs tabs-pull-left">
          <li class="pull-left active">
              <a href="#l1" data-toggle="tab"><i class="fa fa-shield"></i>&nbsp;Application Deployment<span id="appDeployName"></span></a>
          </li>
      </ul>
      <div id="myTabContent3" class="nav tab-content">
        <div class="tab-pane active" id="l1">
          <div class="panel-group smart-accordion-default" id="accordion-AppDeploy">
           
          </div>
          <div id="nodataAppDeploy" style="display:none">

          </div>
        </div>
      </div>
    </div>
  </article>
</div>
<div class="accordianTemplateContainer" style="display:none">
  <div class="panel panel-default accordianTemplate">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a class="envAppDeployAnchor" data-toggle="collapse" data-parent="#accordion-AppDeploy" href="#collapseAppEnv1"> 
            <i class="fa fa-fw fa-plus-circle txt-color-blue"></i> 
            <i class="fa fa-fw fa-minus-circle txt-color-red"></i>
            <b style="font-size:12px;" class="envAppDeployName"><u></u></b>
          </a>
        </h4>
      </div>
      <div id="collapseAppEnv1" class="panel-collapse collapse in envAppDeployAccordian" style="padding: 5px;">
        <div class="table-responsive table-div">
          <table id="tableappDeploydetails" class="table table-striped table-bordered table-hover dataTable envAppDeployTable" style="border:1px solid #eeeeee !important; text-align:center;font-size:12px;margin-top:45px;" width="100%" cellpadding="5px">
                <thead>
                    <tr class="rowCustomStyle" style="font-weight:bold;">
                        <td style="color:#fff;background-color: #2c3742;">S.No.</td>
                        <td style="color:#fff;background-color: #2c3742;">App Name</td>
                        <td style="color:#fff;background-color: #2c3742;">App-Instance Name</td>
                        <td style="color:#fff;background-color: #2c3742;">Version</td>
                        <td style="color:#fff;background-color: #2c3742;">Application Type</td>
                        <td style="color:#fff;background-color: #2c3742;">Container ID</td>
                        <td style="color:#fff;background-color: #2c3742;">Host Name</td>
                        <td style="color:#fff;background-color: #2c3742;">Node IP</td>
                        <td style="color:#fff;background-color: #2c3742;">Last Deploy</td>
                        <td style="color:#fff;background-color: #2c3742;">Status</td>
                        <td style="color:#fff;background-color: #2c3742;">Logs</td>
                        <!-- <td style="color:#fff;background-color: #2c3742;">App Links</td>
                        <td style="color:#fff;background-color: #2c3742;">Action</td> -->
                    </tr>
                </thead>
                <tbody>                   
                </tbody>                   
          </table>                
        </div>
      </div>
  </div>
</div>

<div class="modal fade" id="modalAppCardDetails" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
          <form role="form" id="formAppDeploy" autocomplete="off">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    X
                </button>
                <h4 class="modal-title">
                    <i class="fa fa-th-list txt-color-blue"></i>&nbsp;&nbsp;Associate App Deploy<span style="color:red;font-size:12px" id="errorParam"></span>
                </h4>
            </div>
           
            <div class="modal-body">
                <div class="addApptoAppend">
                  <div style="margin:5px 0px 0px;" class="row application4Params">
                    <div style="padding-left:0px;" class="col-lg-6">
                      <label for="name">Application Name:<span style="color:red">*</span>
                      </label>
                     
                      <input type="text" autofocus="" style="height:36px;" class="form-control" id="appNameInput">
                    </div>
                    <div style="padding-left:0px;" class="col-lg-6">
                      <label for="name">Description:
                      </label>
                      <input type="text" style="height:36px;" class="form-control" id="applicationDescriptionInput">
                    </div>
                  </div>
                </div>
            </div>
             <div class="modal-footer">
                <div class="btn-group" style="margin-left:200px;">                                 
                 <a class="btn btn-primary" id="parameterAppDeploySaveBtn">
                    <i class="ace-icon fa fa-save bigger-110"></i>
                    Save
                </a>
                <a style="margin-left:10px;" class="btn btn-primary cancelAppDeploy" data-dismiss="modal">
                    <i class="ace-icon fa fa-undo bigger-110"></i>
                    Cancel
                </a>
                </div>
              </div>
             </form>
        </div>
    </div>
</div>
<div class="modal fade" id="modalAppCardTableDetails" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
          <form role="form" id="formAppDeployTableHistory" autocomplete="off">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    X
                </button>
                <h4 class="modal-title">
                    <i class="fa fa-th-list txt-color-blue"></i>&nbsp;&nbsp;List of Application
                </h4>
            </div>
           
            <div class="modal-body">
              <div class="table-responsive table-div">
                <table id="tableappParamDeploy" class="table table-striped table-bordered table-hover dataTable" style="border:1px solid #eeeeee !important; text-align:center;font-size:12px;" width="100%" cellpadding="5px">
                      <thead>
                          <tr class="rowCustomStyle" style="font-weight:bold;">
                              <td style="color:#fff;background-color: #2c3742;">S.No.</td>
                              <td style="color:#fff;background-color: #2c3742;">Application Name</td>
                              <td style="color:#fff;background-color: #2c3742;">Application Description</td>
                          </tr>
                      </thead>
                      <tbody>                   
                      </tbody>                   
                </table>                
              </div>
            </div>
            <div class="modal-footer">
              <div class="btn-group" style="margin-left:200px;">                                 
                <a style="margin-left:10px;" class="btn btn-primary" data-dismiss="modal">
                    <i class="ace-icon fa fa-undo bigger-110"></i>
                    Cancel
                </a>
              </div>
            </div>
          </form>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function (){
  $('#chooseApplication').select2();
  getDropdownList();
  getAllApplicationData(function(data){
    constructUI(data);
  });
});
function saveRecord(){
  var dataDeploy = {
      "appDeployData": {
          "applicationName": "",
          "description": "",
          "projectId": ""
      }
  };
  var applicationName = $('#appNameInput').val();
  var applicationDescription = $('#applicationDescriptionInput').val();
  var projectId = urlParams.projid;
  if(!applicationName){
    $('#errorParam').empty();
    $('#errorParam').append('Application name should not be empty');
    return;
  }else{
    dataDeploy.appDeployData.description = applicationDescription;
    dataDeploy.appDeployData.projectId = projectId;
    dataDeploy.appDeployData.applicationName = applicationName;
    console.log(JSON.stringify(dataDeploy));
    $.ajax({
        url: '/app/deploy/data/create',
        data: JSON.stringify(dataDeploy),
        type: 'POST',
        contentType: "application/json",
        success: function(data) {
            console.log(data);
            var $chooseApplication = $('#chooseApplication');
            $chooseApplication.empty();
            $('#modalAppCardDetails').modal("hide");
        },
        error: function(jqxhr) {
            $("#errorParam").empty();
            $("#errorParam").append("    " + jqxhr.responseText);
        }
    });
  }
}
function getDropdownList(){
  if($chooseApplication){
    $chooseApplication.empty();
  }
  $.get('/app/deploy/data/list', function(dataTotalList) {
      var $chooseApplication = $('#chooseApplication');
      //$chooseApplication.append('');
      var applicationNameArr = [];
      var applicationDescArr = {};
      $.each(dataTotalList, function(key, val) {
          if (val.projectId) {
              applicationNameArr.push(val.applicationName);
              if (!applicationDescArr[val.applicationName]) {
                  applicationDescArr[val.applicationName] = val.description;
              }
          }
      });

      $.each(applicationNameArr, function(key, val) {
          $option = $('<option data-selectedAppName="' + val + '" value="' + val + '">' + val + '</option>');
          $chooseApplication.append($option);
      });
  }).fail(function() {
      alert("getDropdownList Error");
  });
}
function constructDataListTable(){
  var $taskenvArrayTable = $('#tableappParamDeploy').DataTable();
  $taskenvArrayTable.clear().draw(false);
  $.get('/app/deploy/data/list', function(dataTotalList) {
      $.each(dataTotalList, function(key, val) {
          var $taskenvArrayTable = $('#tableappParamDeploy');
          var rowindex1 = $taskenvArrayTable.dataTable().fnGetData().length;
          $taskenvArrayTable.dataTable().fnAddData([
              rowindex1 + 1,
              val.applicationName,
              val.description
          ]);
      });
  }).fail(function() {
      alert("getDropdownList Error");
  });
}
function getAllApplicationData(callback){
  $.get('/app/deploy/list', function(data) {
     callback(data);
  }).fail(function() {
      alert("getAllApplicationData Error");
  });
};
function getParticularApplicationData(selectedAppName){
  $("#accordion-AppDeploy").empty();
  $.ajax({
        url: '/app/deploy/data/' + selectedAppName + '/list',
        type: 'GET',
        contentType: "application/json",
        success: function(data) {
            constructUI(data);
        },
        error: function(jqxhr) {
          //$("#accordion-AppDeploy").append("No Data Available");
        },
        failure: function(data) {
          //$("#accordion-AppDeploy").append("No Data Available");
        }
    });
}
function constructUI(data) {
  $("#accordion-AppDeploy").empty();
  if(data.length){
    $("#nodataAppDeploy").css({"text-align": "center", "margin-top": "20px","display":"none"});
    var $accordianTemplate = $('.accordianTemplateContainer').find('.accordianTemplate');
    var dataenvAccordianName;
    if(data && data.length){
      for (var i = 0; i < data.length; i++) {
        if (data[i].projectId) {
          //alert(data[i].applicationName + data[i].envId);
          var $clone = $accordianTemplate.clone(true);
          if ($('#' + data[i].projectId+data[i].applicationName + data[i].envId + '_parentAccordian').length == 0) {
              $clone.attr('id', data[i].projectId+data[i].applicationName + data[i].envId + '_parentAccordian');
              $clone.find('.envAppDeployAnchor').attr('data-parent', '#' + data[i].projectId+data[i].applicationName + data[i].envId + '_parentAccordian');
              if (typeof data[i].projectId+data[i].applicationName + data[i].envId == 'undefined') {
                  dataenvAccordianName = '';
              } else {
                  dataenvAccordianName = 'Application : ' + data[i].applicationName + '  &  ' + 'Environment : ' + data[i].envId;
              }
              $clone.find('.envAppDeployName').html(dataenvAccordianName);
              $clone.find('.envAppDeployAnchor').attr('href', '#' + data[i].projectId+data[i].applicationName + data[i].envId + '_accordian');
              $clone.find('.envAppDeployAccordian').attr('id', data[i].projectId+data[i].applicationName + data[i].envId + '_accordian');
              $clone.find('.envAppDeployTable').attr('id', data[i].projectId+data[i].applicationName + data[i].envId + '_tableappDeploydetails');
              $('#accordion-AppDeploy').append($clone);
              if (!$.fn.dataTable.isDataTable('#' + data[i].projectId+data[i].applicationName + data[i].envId + '_tableappDeploydetails')) {
                  $('#' + data[i].projectId+data[i].applicationName + data[i].envId + '_tableappDeploydetails').DataTable({
                      "pagingType": "full_numbers",
                      "iDisplayLength": 5,
                      "aLengthMenu": [
                          [5, 40, 100, -1],
                          [5, 40, 100, "All"]
                      ],
                      "aoColumns": [{
                              "bSortable": true
                          }, {
                              "bSortable": true
                          }, {
                              "bSortable": true
                          }, {
                              "bSortable": true
                          }, {
                              "bSortable": true
                          },
                          {
                              "bSortable": true
                          }, {
                              "bSortable": true
                          },{
                              "bSortable": true
                          }, 
                          {
                              "bSortable": true
                          }, {
                              "bSortable": true
                          },{
                              "bSortable": false
                          }
                      ]
                  });
              }
          }
          var $taskenvArray = $('#' + data[i].projectId+data[i].applicationName + data[i].envId + '_tableappDeploydetails');
          var rowindex = $taskenvArray.dataTable().fnGetData().length;
          // if (data[i].applicationStatus == "Successful") {
          //     data[i].applicationStatus = '<img src="img/indicator_started.png">';
          // } else if (data[i].applicationStatus == "Failure") {
          //     data[i].applicationStatus = '<img src="img/indicator_stopped.png">';
          // } else {
          //     data[i].applicationStatus = '<img src="img/indicator_unknown.png">';
          // }
          // var appLinks = '<img style="height: 18px;margin-left: -5px;"src="img/projectdemo/app-performanceblack.png" title="App-Performance"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/logsblack.png" title="App-Logs"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/code_healthblack.png" title="Code-Health"><img style="height: 18px;margin-left: 5px;" src="img/projectdemo/UI_performanceblack.png" title="UI-Performance">';
          var logs = '<div class="moreinfoAppDeploy" id="" title="Logs Info" style="margin-left:27%"></div>';
          if(!data[i].applicationName){
            data[i].applicationName = "NA";
          }
          if(!data[i].applicationInstanceName){
             if(data[i].hostName){
                data[i].applicationInstanceName = data[i].hostName;
             }else{
                data[i].applicationInstanceName = "NA";
             }
          }
          if(!data[i].applicationVersion){
            data[i].applicationVersion = "NA";
          }
          if(!data[i].applicationType){
            data[i].applicationType = "NA";
          }
          if(!data[i].containerId){
            data[i].containerId = "NA";
          }
          if(!data[i].hostName){
            data[i].hostName = "NA";
          }
          if(!data[i].applicationNodeIP){
            data[i].applicationNodeIP = "NA";
          }
          if(!data[i].applicationLastDeploy){
            data[i].applicationLastDeploy = "NA";
          }
          if(!data[i].applicationStatus){
            data[i].applicationStatus = "NA";
          }
          $taskenvArray.dataTable().fnAddData([
              rowindex + 1,
              data[i].applicationName,
              data[i].applicationInstanceName,
              data[i].applicationVersion,
              data[i].applicationType,
              data[i].containerId,
              data[i].hostName,
              data[i].applicationNodeIP,
              data[i].applicationLastDeploy,
              data[i].applicationStatus,
              logs
          ]);
        }
      }
    }
  }else{
    $("#nodataAppDeploy").empty();
    $("#nodataAppDeploy").css({"text-align": "center", "margin-top": "20px","display":"block"}).append("No Data Available");
  }
}
var $chooseApplication = $('#chooseApplication');
$chooseApplication.change(function() {
  $selectedOption = $(this).find('option:selected');
  var selectedAppName = $selectedOption.attr('data-selectedAppName');
  console.log(selectedAppName);
  if (typeof selectedAppName != 'undefined') {
      $('#appDeployName').append().text("  for '" + selectedAppName + "'");
      $('#widgetAppDeploy').show();
  } else {
      $('#appDeployName').append().text("");
      $('#widgetAppDeploy').hide();
  }
  if(selectedAppName == 'All Application'){
    getAllApplicationData(function(data){
      constructUI(data);
    });
  }else{
    getParticularApplicationData(selectedAppName);
  }
});
$('#parameterAppDeploySaveBtn').on("click", function() {
  saveRecord();
  getDropdownList();
  getAllApplicationData(function(data){
      constructUI(data);
    });
});

$('.envAppDeployModal').click(function(e) {
   $('#formAppDeploy').trigger("reset");
   $("#errorParam").empty();
});
$('.envAppDeployList').click(function(e) {
  constructDataListTable();
});
if (!$.fn.dataTable.isDataTable('#tableappParamDeploy')) {
    $('#tableappParamDeploy').DataTable({
        "pagingType": "full_numbers",
        "iDisplayLength": 5,
        "aLengthMenu": [
            [5, 40, 100, -1],
            [5, 40, 100, "All"]
        ],
        "aoColumns": [{
                "bSortable": true
            }, {
                "bSortable": true
            }, {
                "bSortable": true
            }
        ]
    });
}
$("#tableappParamDeploy_length").hide();
$("#tableappParamDeploy_filter").hide();
  var urlParams = {};
  (window.onpopstate = function() {
      var url = window.location.href;
      var indexOfQues = url.lastIndexOf("?");
      if (indexOfQues != -1) {
          var sub = url.substring(indexOfQues + 1);
          console.log(sub);
          var params = sub.split('&')
          for (var i = 0; i < params.length; i++) {
              var paramParts = params[i].split('=');
              urlParams[paramParts[0]] = paramParts[1];
          }
      }
  })();
</script>