<style>
	.table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
		border-top: 0px !important;
	}

	tr.show-settings:hover .settings{
		display:block;
	}

	div.settings{
		display:none;
		width: 32px;
		height: 18px;
	}
	.dropdown-content{
		border-radius: 5px;
	    left: -30px;
	    min-width: 98px;
	    right: 0;
	}
	.show-settings input{
		border: 1px solid #999;
	}
	.show-settings input, span{
		height: 20px;
	}

</style>

<div class="clearfix"></div>
<ul class="nav nav-tabs " role="tablist">
	<li class="active"><a href="#organiz" role="tab" data-toggle="tab">Nodes</a></li>
</ul>

<!-- Tab panes -->
<div  class="tab-content nodeListContainer">
	<div  class="tab-pane active tabContent" id="organiz" style="display:none">
		<table class="table table-hover">
		
		<thead>
			<tr>
				<th style="text-align: center">Node Name</th>
				<th style="text-align: center">IP Address</th>
				<th style="text-align: center">FQDN</th>
				<th style="text-align: center">Platform</th>
				<th style="text-align: center">Uptime</th>
			
				<th style="text-align: center">Environment</th>
      
				<th style="text-align: center">Actions</th>
			</tr>
		</thead>
		<tbody>
	

		</tbody>
	</table>
   
  <div style="text-align:center"> <input type="button" class="btn btn-primary showChefImportNodesModalBtn" value="Import Nodes"/> </div>

</div>

</div>	

<div class="modal fade" id="chefImportNodesModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Import Nodes</h4>
      </div>
      <div class="modal-body">
         <form role="form" class="smart-form1">
          <fieldset>
          <div class="">
          <section class="col col-12">
            <div class="form-group">
              <label for="exampleInputEmail1">Orgs</label>
              <div class="">
                <select id="chefImportOrgSelect"  class="form-control" disabled>
                  
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="exampleInputEmail1">Business Groups</label>
              <div class="">
              <select id="chefImportBgSelect"  class="form-control" >
                
              </select>
            </div>
            </div>
         	
         	<div class="form-group">
    			<label for="exampleInputEmail1">Project</label>
          <div class="">
    			<select id="chefImportProjectSelect"  class="form-control" >
                
    			</select>
        </div>
    		</div>
      </section>
      
      <section class="col col-12">
        <div class="form-group">
          <label for="exampleInputEmail1">Provider</label>
          <div class="">
          <select id="chefImportProviderSelect"  class="form-control" >
                
          </select>
        </div>
        </div>
      </section>
      <section class="col col-12 credentialSection" style="display:none">
        <div class="form-group">
          <label for="exampleInputEmail1">Username</label>
          <div class="">
          <input type="text" id="importUsernameInput" />
        </div>
        </div>
      </section>
      <section class="col col-12 credentialSection" style="display:none">
        <div class="form-group">
          <label for="exampleInputEmail1">Password</label>
          <div class="">
          <input type="password" id="importPasswordInput" />
        </div>
        </div>
      </section>
      <section class="col col-12 credentialSection" style="display:none">
        <div class="form-group">
          <label for="exampleInputEmail1">Pem File</label>
          <div class="">
          <input type="checkbox" id="pemFileCheckbox" />&nbsp;<input type="file" id="importPemfileInput" style="display:inline" disabled/>
        </div>
        </div>
      </section>
      <section class="col col-12">
          <label class="label">Assign Users</label>
          <label class="select select-multiple">
              <div class="userListLoadingContainer"></div>
              <select class="custom-scroll" multiple="" id="userListSelect" style="display:none">
                  <option value="1">User1</option>
                  <option value="2">User2</option>
                  <option value="3">User3</option>
                  <option value="4">User4</option>
                  <option value="5">User5</option>
              </select> 
          </label>
      </section>
    </div>
    </fieldset>
         </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary importNodesBtn">Import</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="chefImportNodesResultModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Importing Nodes</h4>
      </div>
      <div class="modal-body">
      </div>
       <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">



drawBreadCrumb1();
var urlParams ={};
(window.onpopstate = function () {
  var url = window.location.href;
  var indexOfQues = url.lastIndexOf("?");
  if(indexOfQues!=-1) {
  var sub =  url.substring(indexOfQues+1);
   console.log(sub);
  urlParams.chefId = sub;
  
 }
     
})();
$(function(){


  var $pemFileCheckBox = $('#pemFileCheckbox').change(function(){
   
    if($(this).is(':checked')) {
      $('#importPemfileInput').attr('disabled',false);
      $('#importPasswordInput').attr('disabled',true);
    } else {
      $('#importPemfileInput').attr('disabled',true);
      $('#importPasswordInput').attr('disabled',false);
    } 
  });

 //drawBreadCrumb();
var $orgListInput = $('#chefImportOrgSelect');
 $bgList = $('#chefImportBgSelect');
var $projectList = $('#chefImportProjectSelect');

$('.nodeListContainer').append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');

$.get('../chef/servers/'+urlParams.chefId,function(data){
   console.log('chefServer ==>',data);
   $orgListInput.append($('<option></option>').val(data.orgname).html(data.orgname));
    var getProviders = getRelatedValues_Top(9, "providername", '', "providername");
    var $providerlist = $('#chefImportProviderSelect');
    $providerlist.append($('<option></option>').val('choose').html('Choose'));
    for(var i=0;i<getProviders.length;i++) {
      $providerlist.append($('<option></option>').val(getProviders[i]).html(getProviders[i]));
    }
    $providerlist.append($('<option></option>').val('azure').html('Azure Data Center'));
    $providerlist.append($('<option></option>').val('datacenter').html('Data Center'));

     $providerlist.change(function(e){
      var val = $providerlist.val();
      if(val == 'datacenter' || val == 'azure') {
         $('.credentialSection').show();
      } else {
         $('.credentialSection').hide();
      }


     });
   
    $bgList.empty();
    $bgList.append($('<option></option>').val('choose').html('Choose'));
    var getBGs = getRelatedValues_Top(2, "orgname",data.orgname, "productgroupname"); 
    for(var i=0;i<getBGs.length;i++) {
        $bgList.append($('<option></option>').val(getBGs[i]).html(getBGs[i]));
    }


    
    $bgList.change(function(e){
      var bgName = $(this).val();
      if(bgName == 'choose') {
          return;
      }
      $projectList.empty();
      $projectList.append($('<option></option>').val('choose').html('Choose'));

      var getProjs = getRelatedValues_Top(4, "productgroupname", bgName, "projectname");
      for(var i=0;i<getProjs.length;i++) {
         $projectList.append($('<option></option>').val(getProjs[i]).html(getProjs[i]));
      }
    });

  $.get('../chef/servers/'+urlParams.chefId+'/nodes',function(nodeList){
    $('.nodeListContainer img').remove();

    var $tableBody = $('.table-hover tbody');
    

    for(var i=0;i<nodeList.length;i++) {
       var $tr = $('<tr></tr>').addClass('show-settings').attr('data-nodeName',nodeList[i]);
       $tr.append($('<td></td>').addClass('chef-nodeName').append(nodeList[i]));
       $tr.append($('<td></td>').addClass('chef-ip').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
       $tr.append($('<td></td>').addClass('chef-fqdn').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
       $tr.append($('<td></td>').addClass('chef-platform').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
       $tr.append($('<td></td>').addClass('chef-uptime').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
    
       $tr.append($('<td></td>').addClass('chef-env').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
      
       $tr.append($('<td></td>').addClass('chef-checkbox').append($('<input class="nodeCheckBox" data-nodeName="'+nodeList[i]+'" type="checkbox" name="nodesChecked"/>'))); 
       $tableBody.append($tr);  

       $.get('../chef/servers/'+urlParams.chefId+'/nodes/'+nodeList[i],function(node){
           var $tr = $tableBody.find('tr[data-nodeName="'+node.name+'"]');
            var ip = 'unknown';
            if(node.automatic.ipaddress) {
                ip = node.automatic.ipaddress;
            }
            $tr.find('.chef-ip').empty().append('<span>'+ip+'</span>');

            var fqdn = 'unknown';
            if(node.automatic.fqdn) {
                fqdn = node.automatic.fqdn;
            }
            $tr.find('.chef-fqdn').empty().append('<span>'+fqdn+'</span>');
            var platform = 'unknown';
            if(node.automatic.platform) {
                platform = node.automatic.platform;
            }
            $tr.find('.chef-platform').empty().append('<span>'+platform+'</span>');

            var uptime = 'unknown';
            if(node.automatic.uptime) {
                uptime = node.automatic.uptime;
            }
            $tr.find('.chef-uptime').empty().append('<span>'+uptime+'</span>');


           
            
            var environment = 'unknown';
            if(node.chef_environment) {
                environment = node.chef_environment;
            }

            $tr.find('.chef-env').empty().append('<span>'+environment+'</span>');
            
            
            
         });


    }


    $('#organiz').show();

  });



});

  var serviceURL = "../d4dMasters/";

          function getRelatedValues_Top(jsonID, comparedField, filterByValue, outputField) {
                readMasterJson_Top(jsonID);
                formData = d4ddata.masterjson;
                // var comparedField = "orgname";
                //  var filterByValue = "Scholastic";
                //  var outputField = "productgroupname";
                var result = [];
                //debugger;
                $.each(eval(formData.rows.row), function (i, item) {
                    $.each(item.field, function (k, item1) {

                        if (item1.name == comparedField && (item1.values.value == filterByValue || filterByValue == '')) {
                            // alert(item1.values.value);
                            //found the row, now get the next column
                           // debugger;
                            $.each(item.field, function (j, item2) {
                                if (item2.name == outputField) {
                                    //  alert(item2.values.value);
                                    result.push(item2.values.value);
                                }
                            });
                        }
                    });
                });
                return (result);
            }

            function readMasterJson_Top(section) {

                $.ajax({
                    type: "get",
                    dataType: "text",

                    async: false,
                    url: serviceURL + "readmasterjson/" + section,
                    success: function (data) {
                        // alert(data.toString());   
                        d4ddata = JSON.parse(data);
                    },
                    failure: function (data) {
                        alert(data.toString());
                    }
                });
                return (d4ddata);
            }


$('.showChefImportNodesModalBtn').click(function(e){
	 var $checkBoxes = $('.nodeCheckBox:checked');
	 if(!$checkBoxes.length) {
        alert('Please Choose nodes first');
        return; 
	 }
	$('#chefImportNodesModal').modal('show');
});

 $('.importNodesBtn').click(function(e){
   var $checkBoxes = $('.nodeCheckBox:checked');
   var reqBody = {};
   reqBody.orgId = $orgListInput.val();
   reqBody.projectId = $projectList.val();
   reqBody.users = $('#userListSelect').val();
   if(!reqBody.users || !reqBody.users.length) {
     alert('Please Choose Users');
     return;
   }

   reqBody.selectedNodes = [];
   $checkBoxes.each(function(){
     reqBody.selectedNodes.push($(this).attr('data-nodeName'));
   });
 
   if($('.credentialSection').is(':visible')){
     reqBody.credentials = {};
     reqBody.credentials.username = $('#importUsernameInput').val();
     if(!$pemFileCheckBox.is(':checked')) {
       reqBody.credentials.password = $('#importPasswordInput').val();
       console.log(reqBody);
       makeRequest();
     } else {
       var pemFileInput = $('#importPemfileInput').get(0);
       if(!pemFileInput.files.length) {
         alert('Please choose a pem file');
         return;
       }
       var reader = new FileReader();

       // Closure to capture the file information.
       reader.onload = function(e) {
           // Render thumbnail.
            reqBody.credentials.pemFileData = e.target.result;
            makeRequest();
           
       };
       // Read in the image file as a data URL.
       reader.readAsText(pemFileInput.files[0]);
 
     }       
   } else {
     makeRequest();
   }

      function makeRequest() {
   $.post('../chef/servers/'+urlParams.chefId+'/sync/nodes',reqBody,function(data){
    console.log(data);
    var $chefResultModalContainer = $('#chefImportNodesResultModal');
    var $modalBody = $chefResultModalContainer.find('.modal-body');
    $modalBody.empty();
    var $progressBar = $('<progress value="0" max="'+reqBody.selectedNodes.length+'"></progress>').css({
      width:'100%'
    });
    var $msgDiv = $('<div class="messageDiv"></div>').css({
      width:'100%'
    });

     $modalBody.append($progressBar).append($msgDiv);
   	 $('#chefImportNodesModal').modal('hide');
     $chefResultModalContainer.modal('show');
     var timeout;
     var count = 0;
     function pollTaskStatus(taskId,timestamp) {
        timeout= setTimeout(function(){
          $.get('../task/'+taskId+'/status?timestamp='+timestamp,function(data){
            console.log(data);
            if(!data.completed) {
              if(data.statusList && data.statusList.length) {
                 
                 $progressBar.val(data.statusList.length);
                 $msgDiv.empty();
                 for(var i=0;i < data.statusList.length;i++) {
                   $msgDiv.append($('<div></div>').append(data.statusList[i].status.message));
                 }

                 pollTaskStatus(taskId,data.statusList[data.statusList.length -1].timestamp);
              } else {
                pollTaskStatus(taskId,timestamp);
              }
            } else {
              if(data.statusList && data.statusList.length) {
                $progressBar.val(data.statusList.length);
                  $msgDiv.empty();
                 for(var i=0;i < data.statusList.length;i++) {
                   $msgDiv.append($('<div></div>').append(data.statusList[i].status.message));
                 } 
               } 
               $progressBar.val(reqBody.selectedNodes.length);
            }
          })   
        },1000);

     }
     pollTaskStatus(data.taskId,0);

   }).error(function(){
    alert('Unable to import nodes. Please try again later');
   });
  }

 });

 });


(function(){

var $loadingContainer = $('.userListLoadingContainer').empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />').show();    
$.get('../users',function(userList){
  var $userListSelect = $('#userListSelect').empty(); 
  userList.sort(function(a, b){
    var keyA =Object.keys(a);
    var keyB =Object.keys(b);
    
    if(keyA[0] < keyB[0]) return -1;
    if(keyA[0] > keyB[0]) return 1;
    return 0;
  }); 
  for(var i=0;i<userList.length;i++) {
    var keys = Object.keys(userList[i]);
    var $option = $('<option></option>').append(keys[0]).val(keys[0]);
    $userListSelect.append($option);
  }
  $loadingContainer.hide();
  $userListSelect.show();
}).error(function(){
    $loadingContainer.empty().append('Unable to load users. Please try again later.');
});
})();



</script>
<script>
var b = $('#tabContent tr td').width();
var c = $('#tabContent tr ').width(); 
 b=c;
$('.tabContent tr').find('span').on('click', function(){
	var w = $(this).width();
	var h = $(this).height();
	var a = $(this).html();
	$(this).hide();
	$(this).parent().children('input').show().focus().val(a);
	$(this).parent().children('input').css({"width": w+'px'});
});

$('.tabContent tr').find('input').on('blur', function(){
	var inputVal = $(this).val();
	$(this).hide();
	$(this).parent().children('span').show().html(inputVal);
});
</script>