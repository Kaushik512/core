<style>
	.table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
		border-top: 0px !important;
	}

	tr.show-settings:hover .settings{
		display:block;
	}

	div.settings{
		display:none;
		width: 32px;
		height: 18px;
	}
	.dropdown-content{
		border-radius: 5px;
	    left: -30px;
	    min-width: 98px;
	    right: 0;
	}
	.show-settings input{
		border: 1px solid #999;
	}
	.show-settings input, span{
		height: 20px;
	}

</style>

<div class="clearfix"></div>
<ul class="nav nav-tabs " role="tablist">
	<li class="active"><a href="#organiz" role="tab" data-toggle="tab">Nodes</a></li>
</ul>

<!-- Tab panes -->
<div  class="tab-content nodeListContainer">
	<div  class="tab-pane active tabContent" id="organiz" style="display:none">
		<table class="table table-hover">
		
		<thead>
			<tr>
				<th>Node Name</th>
				<th>IP Address</th>
				<th>FQDN</th>
				<th>Platform</th>
				<th>Uptime</th>
				<th>Last Check In</th>
				<th>Environment</th>
				<th>Actions</th>

			</tr>
		</thead>
		<tbody>
	

		</tbody>
	</table>
   
  <div style="text-align:center"> <input type="button" class="btn btn-primary showChefImportNodesModalBtn" value="Import Nodes"/> </div>

</div>

</div>	

<div class="modal fade" id="chefImportNodesModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Import Nodes</h4>
      </div>
      <div class="modal-body">
         <form role="form" class="smart-form1">
          <fieldset>
          <div class="">
          <section class="col col-12">
            <div class="form-group">
              <label for="exampleInputEmail1">Orgs</label>
              <div class="">
                <select id="chefImportOrgSelect"  class="form-control" disabled>
                  
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="exampleInputEmail1">Business Groups</label>
              <div class="">
              <select id="chefImportBgSelect"  class="form-control" >
                
              </select>
            </div>
            </div>
         	
         	<div class="form-group">
    			<label for="exampleInputEmail1">Project</label>
          <div class="">
    			<select id="chefImportProjectSelect"  class="form-control" >
                
    			</select>
        </div>
    		</div>
      </section>
      
      <section class="col col-12">
        <div class="form-group">
          <label for="exampleInputEmail1">Provider</label>
          <div class="">
          <select id="chefImportProviderSelect"  class="form-control" >
                
          </select>
        </div>
        </div>
      </section>
      <section class="col col-12 credentialSection" style="display:none">
        <div class="form-group">
          <label for="exampleInputEmail1">Username</label>
          <div class="">
          <input type="text" id="importUsernameInput" />
        </div>
        </div>
      </section>
      <section class="col col-12 credentialSection" style="display:none">
        <div class="form-group">
          <label for="exampleInputEmail1">Password</label>
          <div class="">
          <input type="password" id="importPasswordInput" />
        </div>
        </div>
      </section>
      <section class="col col-12 credentialSection" style="display:none">
        <div class="form-group">
          <label for="exampleInputEmail1">Pem File</label>
          <div class="">
          <input type="checkbox" id="pemFileCheckbox" />&nbsp;<input type="file" id="importPemfileInput" style="display:inline" disabled/>
        </div>
        </div>
      </section>
      <section class="col col-12">
          <label class="label">Assign Users</label>
          <label class="select select-multiple">
              <div class="userListLoadingContainer"></div>
              <select class="custom-scroll" multiple="" id="userListSelect" style="display:none">
                  <option value="1">User1</option>
                  <option value="2">User2</option>
                  <option value="3">User3</option>
                  <option value="4">User4</option>
                  <option value="5">User5</option>
              </select> 
          </label>
      </section>
    </div>
    </fieldset>
         </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary importNodesBtn">Import</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script type="text/javascript">



drawBreadCrumb1();
var urlParams ={};
(window.onpopstate = function () {
  var url = window.location.href;
  var indexOfQues = url.lastIndexOf("?");
  if(indexOfQues!=-1) {
  var sub =  url.substring(indexOfQues+1);
   console.log(sub);
  urlParams.chefId = sub;
  
 }
     
})();
$(function(){


  var $pemFileCheckBox = $('#pemFileCheckbox').change(function(){
   
    if($(this).is(':checked')) {
      $('#importPemfileInput').attr('disabled',false);
      $('#importPasswordInput').attr('disabled',true);
    } else {
      $('#importPemfileInput').attr('disabled',true);
      $('#importPasswordInput').attr('disabled',false);
    } 
  });

 //drawBreadCrumb();
var $orgListInput = $('#chefImportOrgSelect');
 $bgList = $('#chefImportBgSelect');
var $projectList = $('#chefImportProjectSelect');

$('.nodeListContainer').append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');

$.get('../chef/servers/'+urlParams.chefId,function(data){
   console.log('chefServer ==>',data);
   $orgListInput.append($('<option></option>').val(data.orgname).html(data.orgname));
    var getProviders = getRelatedValues_Top(9, "providername", '', "providername");
    var $providerlist = $('#chefImportProviderSelect');
    $providerlist.append($('<option></option>').val('choose').html('Choose'));
    for(var i=0;i<getProviders.length;i++) {
      $providerlist.append($('<option></option>').val(getProviders[i]).html(getProviders[i]));
    }
    $providerlist.append($('<option></option>').val('azure').html('Azure Data Center'));
    $providerlist.append($('<option></option>').val('datacenter').html('Data Center'));

     $providerlist.change(function(e){
      var val = $providerlist.val();
      if(val == 'datacenter' || val == 'azure') {
         $('.credentialSection').show();
      } else {
         $('.credentialSection').hide();
      }


     });
   
    $bgList.empty();
    $bgList.append($('<option></option>').val('choose').html('Choose'));
    var getBGs = getRelatedValues_Top(2, "orgname",data.orgname, "productgroupname"); 
    for(var i=0;i<getBGs.length;i++) {
        $bgList.append($('<option></option>').val(getBGs[i]).html(getBGs[i]));
    }


    
    $bgList.change(function(e){
      var bgName = $(this).val();
      if(bgName == 'choose') {
          return;
      }
      $projectList.empty();
      $projectList.append($('<option></option>').val('choose').html('Choose'));

      var getProjs = getRelatedValues_Top(4, "productgroupname", bgName, "projectname");
      for(var i=0;i<getProjs.length;i++) {
         $projectList.append($('<option></option>').val(getProjs[i]).html(getProjs[i]));
      }
    });

  $.get('../chef/servers/'+urlParams.chefId+'/nodes',function(data){
    $('.nodeListContainer img').remove();

    var $tableBody = $('.table-hover tbody');
    var environments = Object.keys(data);
    for(var i=0;i<environments.length;i++) {
        var nodes = data[environments[i]].nodes;
      for(var j=0;j<nodes.length;j++) {
        var node = nodes[j];
        var $tr = $('<tr></tr>').addClass('show-settings');
            $tr.append($('<td></td>').append('<span>'+node.name+'</span>'));
            var ip = 'unknown';
            if(node.automatic.ipaddress) {
                ip = node.automatic.ipaddress;
            }
            $tr.append($('<td></td>').append('<span>'+ip+'</span>'));

            var fqdn = 'unknown';
            if(node.automatic.fqdn) {
                fqdn = node.automatic.fqdn;
            }
            $tr.append($('<td></td>').append('<span>'+fqdn+'</span>'));

            var platform = 'unknown';
            if(node.automatic.platform) {
                platform = node.automatic.platform;
            }
            $tr.append($('<td></td>').append('<span>'+platform+'</span>'));

            var uptime = 'unknown';
            if(node.automatic.uptime) {
                uptime = node.automatic.uptime;
            }
            $tr.append($('<td></td>').append('<span>'+uptime+'</span>'));

            var lastCheckIn = 'unknown';
            if(node.automatic.lastCheckIn) {
                lastCheckIn = node.automatic.lastCheckIn;
            }
            $tr.append($('<td></td>').append('<span>'+lastCheckIn+'</span>'));
            
            $tr.append($('<td></td>').append('<span>'+environments[i]+'</span>'));

            var runlist = [];
            if(node.run_list && node.run_list.length) {
              runlist = node.run_list;
            }
            runlist = runlist.join();
            var $checkbox = $('<input class="nodeCheckBox" data-nodeName="'+node.name+'" data-nodeIp="'+ip+'" data-nodeFqdn="'+fqdn+'" data-nodePlatform="'+platform+'" data-nodeEnv="'+environments[i]+'" data-nodeRunlist="'+runlist+'" type="checkbox" name="nodesChecked"/>'); 
            $checkbox.data('nodeData',node);
            $tr.append($('<td></td>').append($('<span></span>').append($checkbox)));

            
            $tableBody.append($tr);
            console.log('added');

      }

    }
    $('#organiz').show();

  });



});

  var serviceURL = "../d4dMasters/";

          function getRelatedValues_Top(jsonID, comparedField, filterByValue, outputField) {
                readMasterJson_Top(jsonID);
                formData = d4ddata.masterjson;
                // var comparedField = "orgname";
                //  var filterByValue = "Scholastic";
                //  var outputField = "productgroupname";
                var result = [];
                //debugger;
                $.each(eval(formData.rows.row), function (i, item) {
                    $.each(item.field, function (k, item1) {

                        if (item1.name == comparedField && (item1.values.value == filterByValue || filterByValue == '')) {
                            // alert(item1.values.value);
                            //found the row, now get the next column
                           // debugger;
                            $.each(item.field, function (j, item2) {
                                if (item2.name == outputField) {
                                    //  alert(item2.values.value);
                                    result.push(item2.values.value);
                                }
                            });
                        }
                    });
                });
                return (result);
            }

            function readMasterJson_Top(section) {

                $.ajax({
                    type: "get",
                    dataType: "text",

                    async: false,
                    url: serviceURL + "readmasterjson/" + section,
                    success: function (data) {
                        // alert(data.toString());   
                        d4ddata = JSON.parse(data);
                    },
                    failure: function (data) {
                        alert(data.toString());
                    }
                });
                return (d4ddata);
            }


$('.showChefImportNodesModalBtn').click(function(e){
	 var $checkBoxes = $('.nodeCheckBox:checked');
	 if(!$checkBoxes.length) {
        alert('Please Choose nodes first');
        return; 
	 }
	$('#chefImportNodesModal').modal('show');
});

 $('.importNodesBtn').click(function(e){
   var $checkBoxes = $('.nodeCheckBox:checked');
   var reqBody = {};
   reqBody.orgId = $orgListInput.val();
   reqBody.projectId = $projectList.val();
   reqBody.users = $('#userListSelect').val();
   if(!reqBody.users || !reqBody.users.length) {
     alert('Please Choose Users');
     return;
   }

   reqBody.selectedNodes = [];
   for(var i=0;i<$checkBoxes.length;i++) {
      var nodeInfo = {};
      var $ckb = $($checkBoxes.get(i));
      nodeInfo.nodeName = $ckb.attr('data-nodeName');
      nodeInfo.env = $ckb.attr('data-nodeEnv');
      console.log($ckb.attr('data-nodeRunlist'));
      nodeInfo.runlist = $ckb.attr('data-nodeRunlist').split(',');
      nodeInfo.platform = $ckb.attr('data-nodePlatform');
      nodeInfo.ip = $ckb.attr('data-nodeIp');
      var nodeData = $ckb.data('nodeData');
      nodeInfo.nodeData = {};
      nodeInfo.nodeData.automatic = {};
      if(!nodeData.automatic) {
         nodeData.automatic = {};
      } 
      if (nodeData.automatic.ec2) {
        nodeInfo.nodeData.automatic.ec2 = {};
        nodeInfo.nodeData.automatic.ec2.instance_id = nodeData.automatic.ec2.instance_id;;
        nodeInfo.nodeData.automatic.ec2.public_ipv4 = nodeData.automatic.ec2.public_ipv4;;
      }
      if (nodeData.automatic.kernel && nodeData.automatic.kernel.machine) {
          nodeInfo.nodeData.automatic.kernel = {};
          nodeInfo.nodeData.automatic.kernel.machine = nodeData.automatic.kernel.machine;
      }
      if (nodeData.automatic.platform) {
         nodeInfo.nodeData.automatic.platform = nodeData.automatic.platform;
      }
      if (nodeData.automatic.platform_version) {
         nodeInfo.nodeData.automatic.platform_version = nodeData.automatic.platform_version;
      }
      if (nodeData.automatic.memory) {
        nodeInfo.nodeData.automatic.memory = nodeData.automatic.memory;
      }
      reqBody.selectedNodes.push(nodeInfo);
   };

   if($('.credentialSection').is(':visible')){
     reqBody.credentials = {};
     reqBody.credentials.username = $('#importUsernameInput').val();
     if(!$pemFileCheckBox.is(':checked')) {
       reqBody.credentials.password = $('#importPasswordInput').val();
       console.log(reqBody);
       makeRequest();
     } else {
       var pemFileInput = $('#importPemfileInput').get(0);
       if(!pemFileInput.files.length) {
         alert('Please choose a pem file');
         return;
       }
       var reader = new FileReader();

       // Closure to capture the file information.
       reader.onload = function(e) {
           // Render thumbnail.
            reqBody.credentials.pemFileData = e.target.result;
            makeRequest();
           
       };
       // Read in the image file as a data URL.
       reader.readAsText(pemFileInput.files[0]);
 
     }       
   } else {
     makeRequest();
   }

      function makeRequest() {
   $.post('../chef/servers/'+urlParams.chefId+'/sync/nodes',reqBody,function(data){
   	$('#chefImportNodesModal').modal('hide');

   }).error(function(){
    alert('Unable to import nodes. Please try again later');
   });
  }

 });

 });


(function(){

var $loadingContainer = $('.userListLoadingContainer').empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />').show();    
$.get('../users',function(userList){
  var $userListSelect = $('#userListSelect').empty(); 
  userList.sort(function(a, b){
    var keyA =Object.keys(a);
    var keyB =Object.keys(b);
    
    if(keyA[0] < keyB[0]) return -1;
    if(keyA[0] > keyB[0]) return 1;
    return 0;
  }); 
  for(var i=0;i<userList.length;i++) {
    var keys = Object.keys(userList[i]);
    var $option = $('<option></option>').append(keys[0]).val(keys[0]);
    $userListSelect.append($option);
  }
  $loadingContainer.hide();
  $userListSelect.show();
}).error(function(){
    $loadingContainer.empty().append('Unable to load users. Please try again later.');
});
})();



</script>
<script>
var b = $('#tabContent tr td').width();
var c = $('#tabContent tr ').width(); 
 b=c;
$('.tabContent tr').find('span').on('click', function(){
	var w = $(this).width();
	var h = $(this).height();
	var a = $(this).html();
	$(this).hide();
	$(this).parent().children('input').show().focus().val(a);
	$(this).parent().children('input').css({"width": w+'px'});
});

$('.tabContent tr').find('input').on('blur', function(){
	var inputVal = $(this).val();
	$(this).hide();
	$(this).parent().children('span').show().html(inputVal);
});
</script>