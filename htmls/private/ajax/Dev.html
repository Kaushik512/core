<div class="row">

    <article class="col-sm-12 col-md-12 col-lg-12">

            <div class="widget-body" style="font-size:12px;">


                <ul id="myTab3" class="nav nav-tabs tabs-pull-left">
                    <li class="active">
                        <a href="#l1" data-toggle="tab"><i class="fa fa-reorder"></i>&nbsp;Instances</a>
                    </li>
                    <!--<li class="pull-left">
                        <a href="#l2" data-toggle="tab">DevOps Roles</a>
                    </li>-->
                    <li class="pull-left">
                        <a href="#l2" data-toggle="tab"><i class="fa fa-crosshairs"></i>&nbsp;Blueprints</a>
                    </li>
                    <li class="pull-left">
                        <a href="#l3" data-toggle="tab"><i class="fa fa-upload"></i>&nbsp;Deployments</a>
                    </li>
                    <!--<li class="pull-left">
                        <a href="#l4" data-toggle="tab">Enviornments</a>
                    </li>
                    <li class="pull-left">
                        <a href="#l5" data-toggle="tab">Usage</a>
                    </li>-->
                </ul>

                <div id="myTabContent3" class="nav tab-content">

                    <div class="tab-pane fade in active" id="l1">
                        <div class="jarviswidget jarviswidget-color-blueLight" id="wid-id-10" data-widget-colorbutton="false" data-widget-editbutton="false" data-widget-togglebutton="false" data-widget-deletebutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-sortable="false">

                            <div>


                                <div class="jarviswidget-editbox">


                                </div>
                                <div class="widget-body no-padding">

                                    <div class="panel-group smart-accordion-default" id="accordion-1" style="height:444px;overflow-y: auto;">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                <h4 class="panel-title"><a data-toggle="collapse">Instance</a></h4>
                                                <span class="pull-right swap-view"><a class="btn1" id="defaultViewButton" style="" onclick="$('#divinstancestableview').hide();$('#divinstancescardview').show();return(false);"><!--<img src="img/galleryIcons/Table-view.png"/> --> <i class="fa fa-th fa-2x txt-color-blue" title="Card View"/></a>&nbsp;<a class="btn1" onclick="$('#divinstancestableview').show();$('#divinstancescardview').hide();return(false);"> <i class="fa fa-align-justify fa-2x txt-color-blue" title="Table View"/></a></span>
                                            </div>
                                            <div id="collapseOne-1" class="panel-collapse collapse in">
                                                <div class="panel-body">
                                                    <div class="widget-box" id="divinstancestableview">
                                                        <div class="widget-body">
                                                            <div class="widget-main" style="min-height:300px"> 
                                                                <div class="col-md-12" style="padding-left:0px; padding-right:0px;padding-top:50px">
                                                                    <div class="table-responsive table-div" >
                                                                            <table id="tableinstanceview" class="table table-striped table-bordered table-hover dataTable" cellpadding="5px" width="100%" style="border:1px solid #eeeeee !important">
                                                                                <thead>
                                                                                    <tr class="rowCustomStyle" style="font-weight:bold;">
                                                                                        <td>S.No.</td>
                                                                                        <td>Logo</td>
                                                                                        <td>Name</td>
                                                                                        <td>IPAddress</td>
                                                                                        <td>Recipes</td>
                                                                                        <td>Status</td>
                                                                                        <td>Log Info</td>
                                                                                        <td>Chef Run</td>
                                                                                        <td class="widthAdjustment">Action</td>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    
                                                                                   
                                                                                </tbody>
                                                                                
                                                                            </table>
                                                                    </div>
                                                               </div>
                                                            </div> 
                                                            
                                                        </div>
                                                        <div class="widget-toolbox padding-8 clearfix">
                                                               <div id="tableFooterLeft" class="pull-left"></div>
                                                               <div id="tableFooterRight" class="pull-right"></div>
                                                            </div>
                                                    </div>
                                                    <ul class="thumbnails list-unstyled instancesList" id="divinstancescardview">


                                                        <!--Card for Planning starts here
                                                        <!--Card for Planning ends here-->


                                                    </ul>

                                                </div>
                                            </div>
                                        </div>

                                        

                                    </div>

                                </div>


                            </div>


                        </div>
                        <div class="row" style="margin-top:20px;position:static">
                            <div class="col-md-12">
                                <div class="clearfix form-actions" style="text-align:center">
                                    <div class="btn-group">
                                        
                                        <button class="btn pull-left btn-primary actionControlPanel" style="margin-left:5px">
                                            <i class="fa fa-gears"></i>
                                            Control Panel
                                        </button>
                                        
                                         <!--<button class="btn pull-left btn-primary ChefconfigPanel" style="margin-left:5px">
                                            <i class="fa fa-home"></i>
                                            Chef config Panel
                                        </button>-->
                                    </div>
                                </div>
                            </div>
                        </div><!--Launch div ends here-->

                    </div>

                    <div class="tab-pane" id="l2">
                        <div class="jarviswidget jarviswidget-color-blueLight" id="wid-id-10" data-widget-colorbutton="false" data-widget-editbutton="false" data-widget-togglebutton="false" data-widget-deletebutton="false" data-widget-fullscreenbutton="false" data-widget-custombutton="false" data-widget-sortable="false">

                            <div>


                                <div class="jarviswidget-editbox">


                                </div>
                                <div class="widget-body no-padding">

                                    <div class="panel-group smart-accordion-default" id="accordion-2" style="height:444px;overflow-y: auto;">
                                        <div class="devopsRolePanel panel panel-default blueprintContainer">
                                            <div class="panel-heading">
                                                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion-2" href="#collapseOne-2"> <i class="fa fa-fw fa-plus-circle txt-color-blue"></i> <i class="fa fa-fw fa-minus-circle txt-color-red"></i>Devop Roles</a></h4>
                                            </div>
                                            <div id="collapseOne-2" class="panel-collapse collapse">
                                                <div class="panel-body">


                                                </div>
                                            </div>
                                        </div>


                                        <!--App Factory Starts here-->
                                        <div class="appFactoryPanel panel panel-default blueprintContainer">
                                            <div class="panel-heading">
                                                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion-2" href="#collapse2"><i class="fa fa-fw fa-plus-circle txt-color-blue"></i> <i class="fa fa-fw fa-minus-circle txt-color-red"></i>App Factory</a></h4>
                                            </div>
                                            <div id="collapse2" class="panel-collapse collapse">
                                                <div class="panel-body">

                                                </div>
                                            </div>
                                        </div>
                                        <!--App Factory ends here-->

                                        <div class="panel panel-default blueprintContainer">
                                            <div class="panel-heading ">
                                                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion-2" href="#collapse3" class="collapsed"> <i class="fa fa-fw fa-plus-circle txt-color-blue"></i> <i class="fa fa-fw fa-minus-circle txt-color-red"></i>Cloud Formation</a></h4>
                                            </div>
                                            <div id="collapse3" class="panel-collapse collapse in">
                                                <div class="panel-body">
                                                    
                                                </div>
                                            </div>
                                        </div>

                                    </div>

                                </div>


                            </div>


                        </div>
                        <div class="row" style="margin-top:20px;position:static">
                            <div class="col-md-12">
                                <div class="clearfix form-actions" style="text-align:center">
                                    <div class="btn-group">
                                        <!--<button class="btn pull-left btn-primary editBtn" style="margin-left:5px">
                                            <i class="ace-icon fa fa-pencil  bigger-110"></i>
                                            Edit
                                        </button>-->                                       
                                         <button class="btn pull-left btn-primary launchBtn" style="margin-left:5px">
                                            <i class="ace-icon fa  fa-location-arrow bigger-110"></i>
                                            Launch
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div><!--Launch div ends here-->
                    </div>

                    <div class="tab-pane" id="l3">
                        

                        <form class="smart-form" action="">
 

                            <fieldset>
                               
                                <section class="col col-4">
                                    <label class="label">
                                        <img src="img/templateicons/Select-nodes---deployment.png">
                                        <strong>Select Nodes</strong>
                                    </label>
                                    <div class="row">
                                        <div class="col col-10">
                                            <ul style="border:1px solid #dddddd;list-style:none outside none;height:300px;overflow-y:auto;" class="deploymentNodeList">
                                               
                                            </ul>
                                        </div>
                                        
                                        
                                    </div>
                                </section>
                                <section class="col col-4">
                                    <label class="label">
                                        <img src="img/templateicons/Create-run-list---deployment.png">
                                        <strong>Create Runlist</strong>
                                    </label>
                                    <div class="row">
                                        <div class="col col-10">
                                            <ul style="border:1px solid #dddddd;list-style:none outside none;height:150px;overflow-y:auto;" class="deploymentCookbookList">
                                                <label class="label" style="text-align:center;">Select Cookbooks</label>
                                                <hr>
                                                
                                            </ul>
                                            <ul style="border:1px solid #dddddd;list-style:none outside none;height:150px;overflow-y:auto;"  class="deploymentRolesList">
                                                
                                                <label class="label" style="text-align:center;">Select Roles</label>
                                                <hr>
                                                
                                            </ul>
                                        </div>
                                        <div style="margin-top: 122px;" class="col col-2">
                                            <div class="input-group">
                                                <div style="padding-bottom: 10px;" class="btn-group">
                                                    <button id="btnDeploymentAddSelectedCookbook" class="btn btn-default btn-primary" style="width:30px;height:27px;" type="button"><i style="font-size:20px;" class="fa fa-angle-double-right"></i></button>
                                                </div>
                                                <div class="clearfix"></div>
                                                <div class="btn-group">
                                                    <button id="btnDeploymentRemoveSelectedCookbook" class="btn btn-default btn-primary" style="width:30px;height:27px;" type="button"><i style="font-size:20px;" class="fa fa-angle-double-left"></i></button>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </section>
                                <section class="col col-4">
                                    <label class="label">
                                        <img src="img/templateicons/Order-run-list---deployment.png">
                                        <strong>Order RunList</strong>
                                    </label>
                                    <div class="row">
                                        <div class="col col-10">
                                            <ul style="border:1px solid #dddddd;list-style:none outside none;height:300px;overflow-y:auto;" class="deploymentSelectedRunList">
                                                
                                            </ul>
                                        </div>
                                        <!-- <div style="margin-top: 122px;" class="col col-2">
                                            <div class="input-group">
                                                <div style="padding-bottom: 10px;" class="btn-group">
                                                    <button id="btnItemUp" class="btn btn-default btn-primary" style="width:30px;height:27px;" type="button"><i style="font-size:20px;" class="fa fa-angle-double-up"></i></button>
                                                </div>
                                                <div class="clearfix"></div>
                                                <div class="btn-group">
                                                    <button id="btnItemDown" class="btn btn-default btn-primary" style="width:30px;height:27px;" type="button"><i style="font-size:20px;" class="fa fa-angle-double-down"></i></button>
                                                </div>
                                            </div>
                                        </div> -->
                                        
                                    </div>
                                </section>

                            
                            </fieldset>

                        </form>
                        <div class="row" style="margin-top:90px;position:static">
                            <div class="col-md-12">
                                <div class="clearfix form-actions" style="text-align:center">
                                    <div class="btn-group">
                                        <button class="btn pull-left btn-primary editBtn deploymentChefRunBtn" style="margin-left:5px">
                                            <i class="ace-icon fa fa-pencil  bigger-110"></i>
                                            Execute Chef Run
                                        </button>                                       
                                         
                                    </div>
                                </div>
                            </div>
                        </div><!--Launch div ends here-->
                    
                    </div>

                </div>

            </div>

    </article>
</div>

<!-- Modal -->
<div class="modal fade" id="launchResultContainer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Blueprint Launch Result</h4>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="blueprintEditResultContainer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Blueprint Edit</h4>
      </div>
      <div class="modal-body">
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-primary blueprintUpdateBtn" data-dismiss="modal">Save Version</button>
        <button type="button" class="btn btn-default btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="chefRunModalContainer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Update Runlist</h4>
      </div>
      <div class="modal-body">
         <select class="chefCookbookList" multiple>
         </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-primary btnUpdateInstanceRunlist">Update</button>
        <button type="button" class="btn btn-default btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="instanceLogModalContainer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Instance Logs</h4>
      </div>
      <div class="modal-body">
        <div class="logsArea"></div>
         
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalTableRunlist" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title">
                    Chef-Receipes
                </h4>
            </div>
            <div class="modal-body no-padding">
         

            </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-default btn-primary" data-dismiss="modal">Close</button>
             </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script type="text/javascript">

// $(document.body).on('click', '.card', function () {
      
//       document.querySelector('#flip-toggle').classList.toggle('flip');
//   });

//setting the workzone link to current page
//alert(window.location.href);
//alert('what is this');
var wzlink = window.location.href.split('#')[1];
//alert(wzlink);
$('li[navigation*="Workspace"]').find('a').attr('href','#' + wzlink);

var urlParams = {};
(window.onpopstate = function() {
    var url = window.location.href;
    var indexOfQues = url.lastIndexOf("?");
    if (indexOfQues != -1) {
        var sub = url.substring(indexOfQues + 1);
        console.log(sub);
        var params = sub.split('&')
        for (var i = 0; i < params.length; i++) {
            var paramParts = params[i].split('=');
            urlParams[paramParts[0]] = paramParts[1];
        }
    }

})();
console.log(urlParams);
var projectId = urlParams['projid'];
var envId = urlParams['envid'];

//for Table view
$('#defaultViewButton').click(); //setting the detault view

$.get('/organizations/' + urlParams.org + '/cookbooks', function(data) {
    console.log(data);
    var cookbooks = data.cookbooks;
    var keys = Object.keys(cookbooks);
    var $deploymentCookbookList = $('.deploymentCookbookList');
    for (i = 0; i < keys.length; i++) {
        $deploymentCookbookList.append($('<li><label class="checkbox" style="margin: 5px;"><input type="checkbox"  name="checkboxCookbooks" value="recipe[' + keys[i] + ']" data-cookbookName="' + keys[i] + '"><i></i>' + keys[i] + '</label></li>'));
    }

});

$.get('/organizations/' + urlParams.org + '/roles', function(data) {
    console.log(data);
    var roles = data.roles;
    var keys = Object.keys(roles);
    var $deploymentRolesList = $('.deploymentRolesList');
    for (i = 0; i < keys.length; i++) {
        $deploymentRolesList.append($('<li><label class="checkbox" style="margin: 5px;"><input type="checkbox"  name="checkboxRoles" value="role[' + keys[i] + ']" data-roleName="' + keys[i] + '"><i></i>' + keys[i] + '</label></li>'));
    }

});

$('#btnDeploymentAddSelectedCookbook').click(function(e) {
    var $deploymentSelectedList = $('.deploymentSelectedRunList');
    var $selectedCookbooks = $("input[name=checkboxCookbooks]:checked");
    $selectedCookbooks.each(function(idx) {
        var $this = $(this);
        $deploymentSelectedList.append($('<li><label style="margin: 5px;"><input type="hidden" value="' + $this.val() + '"/>' + $this.attr('data-cookbookName') + '</label></li>').on('click', function(e) {
            if ($(this).hasClass('deploymentCookbookSelected')) {
                $(this).removeClass('deploymentCookbookSelected');
            } else {
                $(this).addClass('deploymentCookbookSelected');
            }
        }));
        $this.attr('checked', false);
        $this.parents('li').hide();

    });

    var $selectedRoles = $("input[name=checkboxRoles]:checked");
    $selectedRoles.each(function(idx) {
        var $this = $(this);
        $deploymentSelectedList.append($('<li><label style="margin: 5px;"><input type="hidden" value="' + $this.val() + '"/>' + $this.attr('data-roleName') + '</label></li>').on('click', function(e) {
            if ($(this).hasClass('deploymentCookbookSelected')) {
                $(this).removeClass('deploymentCookbookSelected');
            } else {
                $(this).addClass('deploymentCookbookSelected');
            }
        }));
        $this.attr('checked', false);
        $this.parents('li').hide();


    });

    $deploymentSelectedList.sortable({
        cursor: "move"
    });
});

$('#btnDeploymentRemoveSelectedCookbook').click(function(e) {
    var $deploymentSelectedList = $('.deploymentSelectedRunList');
    $deploymentSelectedList.find('.deploymentCookbookSelected').each(function() {
        var value = $(this).find('input').val();
        var selector = 'input[name=checkboxRoles][value="' + value + '"]';
        console.log(selector);
        $('input[name=checkboxRoles][value="' + value + '"]').parents('li').show();
        $('input[name=checkboxCookbooks][value="' + value + '"]').parents('li').show();
        $(this).remove();

    });

});




$('.deploymentChefRunBtn').click(function(e) {

    var $selectedNodes = $('input[name=deploymentNodesCheckBox]:checked');
    var $runlistInput = $('.deploymentSelectedRunList input');
    var runlist = [];
    $runlistInput.each(function() {
        runlist.push($(this).val());
    });
    console.log(runlist);
    $selectedNodes.each(function(e) {
        $.post('/instances/' + $(this).val() + '/updateRunlist', {
            runlist: runlist
        }, function(data) {
            console.log('instance runlist updated');
        });
    })



});


$.get('/projects/' + projectId + '/environments/' + envId + '/blueprints', function(data) {

    var $AppFactpanelBody = $('.appFactoryPanel').find('.panel-body');
    $AppFactpanelBody.empty();

    var $devopsRolepanelBody = $('.devopsRolePanel').find('.panel-body');
    $devopsRolepanelBody.empty();



    for (var i = 0; i < data.length; i++) {


        var $itemContainer = $('<div></div>').addClass("productdiv4");

        var $itemBody = $('<div></div>').addClass('productdiv1 cardimage').attr('data-blueprintId', data[i]._id).attr('data-projectId', data[i].projectId).attr('data-envId', data[i].envId).attr('data-chefServerId', data[i].chefServerId);
        var $ul = $('<ul></ul>').addClass('list-unstyled system-prop').css({
            'text-align': 'center'
        });
        var $img = $('<img />').attr('src', 'img/templateicons/' + data[i].templateId + '.png').attr('alt', data[i].name).addClass('cardLogo');
        var $liImage = $('<li></li>').append($img);
        $ul.append($liImage);
        //Arabinda changed the css below licardName //.css({"font-size":'12px',"overflow": 'hidden',"padding-left": '7px',"text-overflow": 'ellipsis',"white-space": 'nowrap'})
        var $liCardName = $('<li title="' + data[i].name + '"></li>').addClass('Cardtextoverflow').html('<u><b>' + data[i].name + '</b></u>');

        //For Table View
        //$rowContainter.append('<td>' +data[i].name + '</td>');



        $ul.append($liCardName);


        var $selecteditBtnContainer = $('<div style="position:absolute;padding-left:27px;bottom:11px;"></div>');
        if (data[i].versionsList) {
            var $selectVerEdit = $('<a style="padding:0px 4px;margin-left:3px;border-radius:5px;" class="bpEditBtn"><i class="ace-icon fa fa-pencil"></i></a>').addClass('btn btn-primary').attr('rel', 'tooltip').attr('data-placement', 'top').attr('data-original-title', 'Edit');
            var $selectVer = $('<select style="padding:1px;"></select>').addClass('blueprintVersionDropDown').attr('data-blueprintId', data[i]._id);

            $selectVerEdit.click(function(e) {
                var $parent = $(this).parents('.cardimage');
                var $blueprintEditResultContainer = $('#blueprintEditResultContainer');
                $blueprintEditResultContainer.find('.modal-body').empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');
                $blueprintEditResultContainer.modal('show');

                var projectId = $parent.attr('data-projectId');
                var envId = $parent.attr('data-envId');
                var blueprintId = $parent.attr('data-blueprintId');
                var chefServerId = $parent.attr('data-chefServerId');
                var version = $parent.find('.blueprintVersionDropDown').val();

                $.get('/blueprints/' + blueprintId + '/versions/' + version, function(data) {

                    $.get('/chef/servers/' + chefServerId + '/cookbooks', function(data) {
                        var keys = Object.keys(data);

                        var $cookbooksList = $('<select></select>').addClass('blueprintChefCookbookList').attr('data-blueprintId', blueprintId).attr('multiple', true);
                        for (var i = 0; i < keys.length; i++) {
                            var $option = $('<option></option>').append(keys[i]).val('recipe[' + keys[i] + ']');
                            $cookbooksList.append($option);
                        }
                        $blueprintEditResultContainer.find('.modal-body').empty();
                        $blueprintEditResultContainer.find('.modal-body').append($cookbooksList);
                    }).error(function() {
                        $blueprintEditResultContainer.find('.modal-body').empty();
                        $blueprintEditResultContainer.find('.modal-body').append('<span>Oops! Something went wrong. Please try again later</span>');
                    });;
                }).error(function() {
                    $blueprintEditResultContainer.find('.modal-body').empty();
                    $blueprintEditResultContainer.find('.modal-body').append('<span>Oops! Something went wrong. Please try again later</span>');
                });

            });


            var $li = $('<li></li>').css({
                "font-size": '10px'
            }).append($selectVer, $selectVerEdit);
            for (var j = 0; j < data[i].versionsList.length; j++) {
                var $options = $('<option></option>').append(data[i].versionsList[j].ver).val(data[i].versionsList[j].ver);
                $selectVer.append($options);
            }
            $selecteditBtnContainer.append($li);
        }

        $itemBody.append($ul);
        $itemBody.append($selecteditBtnContainer);




        $itemContainer.append($itemBody);
        if (data[i].templateType == 'appFactory') {
            $AppFactpanelBody.append($itemContainer);
        } else {
            $devopsRolepanelBody.append($itemContainer);
        }
    }
    var $productdiv1 = $('.productdiv1');

    $productdiv1.click(function(e) {
        $productdiv1.removeClass('role-Selected1');
        $(this).addClass('role-Selected1');
    });

    var expanded = false;
    if ($devopsRolepanelBody.children().length) {
        var $devopsRolePanel = $devopsRolepanelBody.parents('.devopsRolePanel').show();
        $devopsRolePanel.find('.collapse').addClass('in');
        expanded = true;
    }

    if ($AppFactpanelBody.children().length) {
        var $appFactoryPanel = $AppFactpanelBody.parents('.appFactoryPanel').show();
        if (!expanded) {
            $appFactoryPanel.find('.collapse').addClass('in');
        }
    }

    pageSetUp();

});


function getCssClassFromStatus(status) {
    var cssClasses = {

    };
    switch (status) {

        case 'running':
            cssClasses.ringClass = 'started';
            cssClasses.textClass = 'instance-state-text-started';
            cssClasses.tableViewStatusClass = "started";
            break;

        case 'stopped':
            cssClasses.ringClass = 'stopped';
            cssClasses.textClass = 'instance-state-text-stopped';
            cssClasses.tableViewStatusClass = "stopped";
            break;

        case 'terminated':
            cssClasses.ringClass = 'stopped';
            cssClasses.textClass = 'instance-state-text-stopped';
            cssClasses.tableViewStatusClass = "stopped";
            break;

        default:
            cssClasses.ringClass = 'pending';
            cssClasses.textClass = 'instance-state-text-pending';
            cssClasses.tableViewStatusClass = "pending";

    }

    return cssClasses;
}


function pollInstanceState(instanceId, state, delay) {
    var $parent = $('.domain-roles-caption[data-instanceId="' + instanceId + '"]');
    var timeout = setTimeout(function() {
        $.get('/instances/' + instanceId, function(data) {
            if (data) {
                if (data.instanceState === state) {
                    pollInstanceState(instanceId, state, 5000);
                } else {
                    console.log('polling complete');
                    var cssClassed = getCssClassFromStatus(data.instanceState);
                    $parent.find('.componentlistContainer').removeClass().addClass('componentlistContainer').addClass(cssClassed.ringClass);
                    $parent.find('.instance-state').removeClass().addClass('instance-state').addClass(cssClassed.textClass).html(data.instanceState);
                    $('.instancestatusindicator[data-instanceId="' + instanceId + '"]').removeClass().addClass('instancestatusindicator').addClass(cssClassed.tableViewStatusClass);
                    $parent.find('.instance-details-id strong').html(data.instanceIP);
                    $('tr[data-instanceId="' + instanceId + '"] td.instanceIPCol').html(data.instanceIP);
                }
            }
        })
    }, delay);
}


var startStopInstanceHandler = function(e) {
    var $this = $(this);
    var instanceId = $this.parents('.instanceActionBtnCtr').attr('data-instanceId');;
    var type = $this.attr('data-actionType');
    url = '/instances/' + instanceId + '/startInstance';
    if (type === 'stop') {
        url = '/instances/' + instanceId + '/stopInstance'
    }
    var $parent = $('.domain-roles-caption[data-instanceId="' + instanceId + '"]');
    $parent.find('.moreInfo').trigger('click');
    $.get(url, function(data) {

        console.log($parent.length, $parent);



        var cssClassed = getCssClassFromStatus(data.instanceCurrentState);

        var oldState = data.instanceCurrentState;


        $parent.find('.componentlistContainer').removeClass().addClass('componentlistContainer').addClass(cssClassed.ringClass);

        $parent.find('.instance-state').removeClass().addClass('instance-state').addClass(cssClassed.textClass).html(data.instanceCurrentState);

        $('.instancestatusindicator[data-instanceId="' + instanceId + '"]').removeClass().addClass('instancestatusindicator').addClass(cssClassed.tableViewStatusClass);

        pollInstanceState(instanceId, oldState, 2000);
    });
}


var instanceUpdateRunlistHandler = function(e) {
    var $this = $(this);
    var instanceId = $this.attr('data-instanceId');
    var chefServerId = $this.attr('data-chefServerId');
    console.log(instanceId);
    $chefRunModalContainer = $('#chefRunModalContainer');
    $chefRunModalContainer.find('.modal-body').empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif"/>');
    $chefRunModalContainer.modal('show');
    $.get('/chef/servers/' + chefServerId + '/cookbooks', function(data) {
        var keys = Object.keys(data);
        var $cookbooksList = $('<select></select>').addClass('chefCookbookList').attr('data-instanceId', instanceId).attr('multiple', true);
        for (var i = 0; i < keys.length; i++) {
            var $option = $('<option></option>').append(keys[i]).val('recipe[' + keys[i] + ']');
            $cookbooksList.append($option);
        }
        $chefRunModalContainer.find('.modal-body').empty().append($cookbooksList);

    }).error(function() {
        $chefRunModalContainer.find('.modal-body').empty().append('<span>Oops! Something went wrong. Please try again later</span>');
    });

};

var instanceLogsHandler = function(e) {
    var instanceId = $(this).attr('data-instanceId');
    var timeout;
    var $instanceLogModalContainer = $('#instanceLogModalContainer');
    $instanceLogModalContainer.on('hidden.bs.modal', function(e) {
        $instanceLogModalContainer.off('hidden.bs.modal');
        if (timeout) {
            clearTimeout(timeout);
        }
    });
    $instanceLogModalContainer.find('.logsArea').empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');
    $instanceLogModalContainer.modal('show');
    var lastTimestamp;

    function pollLogs(timestamp, delay, clearData) {
        var url = '/instances/' + instanceId + '/logs';
        if (timestamp) {
            url = url + '?timestamp=' + timestamp;
        }

        timeout = setTimeout(function() {
            $.get(url, function(data) {
                var $modalBody = $instanceLogModalContainer.find('.logsArea')
                if (clearData) {
                    $modalBody.empty();
                }
                var $table = $('<div></div>');

                for (var i = 0; i < data.length; i++) {
                    var $rowDiv = $('<div class="row"></div>');
                    var timeString = new Date().setTime(data[i].timestamp);
                    var date = new Date(timeString).toUTCString(); //converts to human readable strings
                    $rowDiv.append($('<div class="col-lg-4 col-sm-4"></div>').append('<div>' + date + '</div>'));

                    if (data[i].err) {
                        $rowDiv.append($('<div class="col-lg-8 col-sm-8" style="color:red;"></div>').append('<span>' + data[i].log + '</span>'));
                    } else {
                        $rowDiv.append($('<div class="col-lg-8 col-sm-8 " style="color:DarkBlue;"></div>').append('<span>' + data[i].log + '</span>'));
                    }

                    $table.append($rowDiv);
                    $table.append('<hr/>');

                }


                if (data.length) {
                    lastTimestamp = data[data.length - 1].timestamp;
                    console.log(lastTimestamp);
                    $modalBody.append($table);
                    $modalBody.scrollTop($modalBody[0].scrollHeight + 100);
                }


                console.log('polling again');
                if ($instanceLogModalContainer.data()['bs.modal'].isShown) {
                    pollLogs(lastTimestamp, 1000, false);
                } else {
                    console.log('not polling again');
                }
            });
        }, delay);
    }
    pollLogs(lastTimestamp, 0, true);
};



function addInstanceToDOM(data) {

    var $instancesList = $('.instancesList');
    var $deploymentNodeList = $('.deploymentNodeList');

    $deploymentNodeList.append($('<li><label class="checkbox" style="margin: 5px;font-size:13px;"><input type="checkbox" name="deploymentNodesCheckBox" value="' + data._id + '"><i></i>' + data.chefNodeName + '</label></li>'));

    var $rowContainter = $('<tr data-instanceId="' + data._id + '"></tr>');


    var $li = $('<li></li>').addClass('domain-role-thumbnail');
    var $container = $('<div class="flip-toggle"></div>').addClass('container'); //<div class="container" id="flip-toggle">
    var $card = $('<div></div>').addClass('card'); //<div class="card">
    var $front = $('<div></div>').addClass('front'); //<div class="front">
    var $div = $('<div></div>').addClass('domain-roles ');
    var $divDomainRolesCaption = $('<div></div>').addClass('domain-roles-caption').attr('data-instanceId', data._id);
    var $divHeading = $('<div></div>').addClass('domain-roles-heading');


    var $spanheadingLeft = $('<span></span>').addClass('domain-roles-icon').html('<img src="img/templateicons/' + data.blueprintData.templateId + '.png" style="height:22px;width:33px;margin-right:5px;margin-top:-10px;"/>').attr('contenteditable', 'false');

    var $spanheadingMiddle = $('<span>' + data.blueprintData.blueprintName + '</span>').addClass('cardHeadingTextoverflow').attr('rel', 'tooltip').attr('data-placement', 'top').attr('data-original-title', ''+ data.blueprintData.blueprintName +'');
    var $spanheadingRight = $('<span></span>').css({
        'float': 'right'
    }).append($('<a href="javascript:void(0)" data-instanceId="' + data._id + '"></a>').addClass('moreInfo').attr('rel', 'tooltip').attr('data-placement', 'top').attr('data-original-title', 'MoreInfo'));

    $divHeading.append($spanheadingLeft);
    $divHeading.append($spanheadingMiddle);
    $divHeading.append($spanheadingRight);
    $divDomainRolesCaption.append($divHeading);
    $divDomainRolesCaption.append($('<hr>'));
    var $divComponentListContainer;
    var $tdInstanceStatusIndicator;

    if (data.instanceState == 'running') {
        $divComponentListContainer = $('<div></div>').addClass('componentlistContainer started');
        $tableInstanceStatusIndicator = $('<td></td>').addClass('instancestatusindicator started');
    } else if (data.instanceState == 'terminated') {
        $divComponentListContainer = $('<div></div>').addClass('componentlistContainer stopped');
        $tableInstanceStatusIndicator = $('<td></td>').addClass('instancestatusindicator stopped');
    } else if (data.instanceState == 'stopped') {
        $divComponentListContainer = $('<div></div>').addClass('componentlistContainer stopped');
        $tableInstanceStatusIndicator = $('<td></td>').addClass('instancestatusindicator stopped');
    } else {
        $divComponentListContainer = $('<div></div>').addClass('componentlistContainer pending');
        $tableInstanceStatusIndicator = $('<td></td>').addClass('instancestatusindicator pending');
    }
    $tableInstanceStatusIndicator.attr('data-instanceId', data._id);


    $divComponentList = $('<div></div>').addClass('instance-bootstrap-list');

    /*for(var j=0;j<data.runlist.length;j++) { 
          var $divComponentItem;
           if(j == 0) {
          
            $divComponentItem = $('<span title="'+data.runlist[j]+'" style="margin-top:8px;overflow:hidden;text-overflow:ellipsis;width:62px;"></span>').addClass('instance-details-item').append(data.runlist[j]);

           } else {
            $divComponentItem = $('<span title="'+data.runlist[j]+'" style="overflow:hidden;text-overflow:ellipsis;width:62px;"></span>').addClass('instance-details-item').append(data.runlist[j]);
           }
           $divComponentList.append($divComponentItem);
            if(j==2) {
                break;
            }
        }*/
    //var $backdivai = $('<i></i>').addClass('fa fa-lg fa-fw fa-book txt-color-blue');
    $divComponentItem = $('<span style="overflow:hidden;text-overflow:ellipsis;width:62px;padding-right:0px;"></span>').addClass('instance-details-item').append($('<a class="btn"><i class="fa fa-2x fa-list txt-color-blue"></i></a>').attr('href', 'javascript:void').attr('rel', 'tooltip').attr('data-placement', 'top').attr('data-original-title', 'View All Runlist').addClass('instance-bootstrap-list-faimage'));

    $divComponentItem.click(function(e) {
        $(this).parents('.flip-toggle').toggleClass('flip');
    });


    $divComponentList.append($divComponentItem);


    $divComponentListContainer.append($divComponentList);



    $divComponentListImage = $('<a class="btn chefClientRunlistImage"><img src="img/galleryIcons/Chefimport.png" alt="Chefimport"></a>').attr('rel', 'tooltip').attr('data-placement', 'top').attr('data-original-title', 'Chef Client Run').addClass('instance-bootstrap-list-image').attr('data-chefServerId', data.chef.serverId).attr('data-instanceId',data._id);

    $divComponentListContainer.append($divComponentListImage);

    //For Table View

    var numberOfRows = $("#tableinstanceview").find('tbody tr').length;

    $rowContainter.append('<td>' + (numberOfRows + 1) + '</td>');
    $rowContainter.append('<td><img src="img/templateicons/' + data.blueprintData.templateId + '.png" style="height:27px;width:54px;"/></td>');


    $rowContainter.append('<td>' + data.blueprintData.blueprintName + '</td>');
    //$rowContainter.append('<td>' +$divComponentList.text()+ '</td>');
    $rowContainter.append('<td class="instanceIPCol">' + data.instanceIP + '</td>');
    var $tableRunlistDiv = $('<div></div>'); /*.append('<span>'+data.runlist.join()+'</span>');*/
   
    var $viewAllA;
    if (data.runlist.length) {
        $viewAllA  = $('<a></a>').attr('href', 'javascript:void(0)').append("View All Runlist").data('runlist', data.runlist.join());
        $viewAllA.click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            var $modal = $('#modalTableRunlist');
            var $modalBody = $('#modalTableRunlist .modal-body').empty();
            var runlist = $(this).data('runlist').split(',');
            for (var j = 0; j < runlist.length; j++) {
                var $divComponentItem;
                if (j == 0) {

                    $divComponentItem = $('<span title="' + runlist[j] + '" style="margin-top:8px;overflow:hidden;text-overflow:ellipsis;width:300px;"></span>').addClass('instance-details-item').append(runlist[j]);

                } else {
                    $divComponentItem = $('<span title="' + runlist[j] + '" style="overflow:hidden;text-overflow:ellipsis;width:300px;"></span>').addClass('instance-details-item').append(runlist[j]);
                }

                $modalBody.append($divComponentItem);
            }
            $modal.modal('show');
            return false;
        });
    } else {
       $viewAllA  = $('<span></span>').append("View All Runlist");
    }
    var $divComponentItem = $('<span title="View all runlist" style="overflow:hidden;text-overflow:ellipsis;width:111px;"></span>').addClass('instance-details-item').append($viewAllA);
    $tableRunlistDiv.append($divComponentItem);


    $rowContainter.append($('<td></td>').append($tableRunlistDiv));
    //$rowContainter.append('<td><img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/aws_logo.png" /></td>');
    $rowContainter.append($tableInstanceStatusIndicator);

    $rowContainter.append('<td><a class="tableMoreInfo" data-instanceId="' + data._id + '" href="javascript:void(0)" rel="tooltip" data-placement="top" data-original-title="MoreInfo"><img class="center-block"  src="img/galleryIcons/moreinfo.png" /></a></td>');

    $divDomainRolesCaption.append($divComponentListContainer);
    var $divInstanceDetails = $('<div></div>')
    var $instanceDetailsList = $('<div></div>').addClass('instance-details-list');
    var $instanceDetailItemId = $('<span></span>').addClass('instance-details-id').html('IP : <strong>' + data.instanceIP + '</strong>');
    $instanceDetailsList.append($instanceDetailItemId);
    var $instanceDetailItemStatus;
    if (data.instanceState == 'running') {
        $instanceDetailItemStatus = $('<span></span>').addClass('instance-details-id').html('status : <span class="instance-state instance-state-text-started">' + data.instanceState + '</strong>');
    } else if (data.instanceState == 'terminated') {
        $instanceDetailItemStatus = $('<span></span>').addClass('instance-details-id').html('status : <span class="instance-state instance-state-text-stopped">' + data.instanceState + '</strong>');
    } else if (data.instanceState == 'stopped') {
        $instanceDetailItemStatus = $('<span></span>').addClass('instance-details-id').html('status : <span class="instance-state instance-state-text-stopped">' + data.instanceState + '</strong>');
    } else {
        $instanceDetailItemStatus = $('<span></span>').addClass('instance-details-id').html('status : <span class="instance-state instance-state-text-pending">' + data.instanceState + '</strong>');
    }

    $instanceDetailsList.append($instanceDetailItemStatus);

    $divInstanceDetails.append($instanceDetailsList);

    $divDomainRolesCaption.append($divInstanceDetails);

    $divDomainRolesCaption.append($('<hr>'));


    //data-original-title="Moreinfo" data-placement="top" rel="tooltip"
    var $divActionBtnContainer = $('<div style="width:140px !important;"></div>').addClass('instanceActionBtnCtr').attr('data-instanceId', data._id);

    var $divActionStartContainer = $('<div></div>').addClass('instance-bootstrap-ActionStart').append($('<a href="javascript:void(0)"></a>').addClass('actionbuttonStart instanceActionBtn').attr('data-actionType', 'Start').attr('data-original-title', 'Start').attr('data-placement', 'top').attr('rel', 'tooltip'));
    $divActionBtnContainer.append($divActionStartContainer);
    if (!data.chef) {
        data.chef = {};
    }
    var $divActionReStartContainer = $('<div></div>').addClass('instance-bootstrap-ActionRestart').append($('<a href="javascript:void(0)"></a>').addClass('actionbuttonRestart instanceActionBtnUpdateRunlist').attr('data-chefServerId', data.chef.serverId).attr('rel', 'tooltip').attr('data-placement', 'top').attr('data-original-title', 'Restart'));
    $divActionBtnContainer.append($divActionReStartContainer);
    var $divActionShutdownContainer = $('<div></div>').addClass('instance-bootstrap-ActionShutdown').append($('<a href="javascript:void(0)"></a>').addClass('actionbuttonShutdown instanceActionBtn').attr('data-actionType', 'stop').attr('rel', 'tooltip').attr('data-placement', 'top').attr('data-original-title', 'Shutdown'));
    $divActionBtnContainer.append($divActionShutdownContainer);
    var $back = $('<div></div>').addClass('back card-backflip');
    var $backRunlistContainer = $('<div></div>').addClass('cardBackRunlistContaner');

    var $backdiv = $('<span></span>').addClass('card-backflip-margin');
    var $backdiva = $('<a style="color:#333;"></a>');
    var $backdivai = $('<i></i>').addClass('fa fa-lg fa-fw fa-book txt-color-blue');
    var $backdivaspan = $('<span style="font-size:12px;font-family:Open sans;padding-left:5px;color:#333"></span>').addClass('menu-item-parent').html('Cookbooks');
    var $backhr = $('<hr>');


    $backdivai.append($backdivaspan);
    $backdiva.append($backdivai);
    //$backdiva.append($backhr);
    $backdiv.append($backdiva);

    $back.append($backdiv);

    $back.append($backRunlistContainer);
    $backdiv.append($backhr);

    for (var j = 0; j < data.runlist.length; j++) {
        var $divComponentItem;
        if (j == 0) {

            $divComponentItem = $('<span title="' + data.runlist[j] + '" style="margin-top:8px;overflow:hidden;text-overflow:ellipsis;width:130px;color:#3a87ad"></span>').addClass('instance-details-item').append(data.runlist[j]);

        } else {
            $divComponentItem = $('<span title="' + data.runlist[j] + '" style="overflow:hidden;text-overflow:ellipsis;width:130px;color:#3a87ad></span>').addClass('instance-details-item').append(data.runlist[j]);
        }
        $backRunlistContainer.append($divComponentItem);

    }
    var $flipbackdivaspanhr = $('<hr>');
    $back.append($flipbackdivaspanhr);
    var $flipbackdivaspan = $('<span style="width:160px;text-align:center;display:block;margin-top:8px"></span>').append($('<a style="color:#333"></a>').attr('href', 'javascript:void').append("Go Back"));
    $flipbackdivaspan.click(function(e) {
        $(this).parents('.flip-toggle').toggleClass('flip');
    });
    $back.append($flipbackdivaspan);

    $divDomainRolesCaption.append($divActionBtnContainer);
    $front.append($div);
    $card.append($front);
    $card.append($back);
    $container.append($card);
    $li.append($container);
    //$li.append($div);
    $div.append($divDomainRolesCaption);

    $instancesList.append($li);

    //For Table View
    $divComponentListImage
    $rowContainter.append('<td>' + $('<div></div>').append($divComponentListImage.clone()).html() + '</td>');
    $rowContainter.append('<td>' + $('<div></div>').append($divActionBtnContainer.clone()).html() + '</td>');
    $("#tableinstanceview").append($rowContainter);




    if (data.instanceState === 'pending' || data.instanceState === 'stopping') {
        pollInstanceState(data._id, data.instanceState, 2000);
    }



    //handling events



    $rowContainter.find('.instanceActionBtn').click(startStopInstanceHandler);
    $li.find('.instanceActionBtn').click(startStopInstanceHandler);


    $rowContainter.find('.instance-bootstrap-list-image').click(instanceUpdateRunlistHandler);
    $li.find('.instance-bootstrap-list-image').click(instanceUpdateRunlistHandler);


    $rowContainter.find('.tableMoreInfo').click(instanceLogsHandler);
    $li.find('.moreInfo').click(instanceLogsHandler);

    var $cardContainer = $li.find('.container').click(function(e) {
        $('.container').removeClass('role-Selectedcard');
        $(this).addClass('role-Selectedcard');

    });
    pageSetUp();


}



$.get('/projects/' + projectId + '/environments/' + envId + '/instances', function(data) {
    console.log(">>>>>>>>>>>>>> Hit");

    var $instancesList = $('.instancesList').empty();
    var $deploymentNodeList = $('.deploymentNodeList').empty();

    //alert(data.length);

    for (var i = 0; i < data.length; i++) {

        addInstanceToDOM(data[i]);

    }
    //for table view
    if (!$.fn.dataTable.isDataTable('#tableinstanceview')) {
        var tableinstanceview = $('#tableinstanceview').dataTable({
            "pagingType": "full_numbers",
            "aoColumns": [null,
                {
                    "bSortable": false
                },
                null,
                null,
                {
                    "bSortable": false
                },
                {
                    "bSortable": false
                },
                {
                    "bSortable": false
                },
                {
                    "bSortable": false
                },
                {
                    "bSortable": false
                }
            ]
        });
    }
    $('#tableinstanceview tbody').on('click','tr',function(){
        if($(this).hasClass('rowcustomselected')){
            $(this).removeClass('rowcustomselected');
        }
        else{
            tableinstanceview.$('tr').removeClass('rowcustomselected');
            $(this).addClass('rowcustomselected');
        }

    });

    console.log('loading table');
    $('#tableinstanceview' + '_info').detach().appendTo('#tableFooterLeft');
    $('#tableinstanceview' + '_paginate').detach().appendTo('#tableFooterRight');
    $('input[type="search"]').css('margin-left','5px'); //providing a space between search and input box
    //$('#tableinstanceview' + '_filter').detach().appendTo('#envtable_tools1');
    // $('#tableinstanceview' + '_length').detach().appendTo('#envtable_tools2');

    //handling instance action btn
    //default selecting first card in Instance and Blueprints
    if($("#divinstancescardview li").length > 0)
        $("#divinstancescardview li").first().find('.flip-toggle').trigger('click');

    $(".appFactoryPanel").find(".productdiv1").first().trigger('click');

});



$('#bootstrap-wizard-1').bootstrapWizard({
    'tabClass': 'form-wizard',
    'onNext': function(tab, navigation, index) {
        console.log(typeof index, index)
        if (index === 1) {
            console.log('in here')
            var $selectedItem = $('.role-Selected');
            if (!$selectedItem.length) {
                alert('please choose a role')
                return false;
            }
            var $clone = $selectedItem.clone().removeClass('role-Selected');
            $('#tab' + (index + 1)).find('.temp').empty().append($clone);
        } else {

        }
        $('#bootstrap-wizard-1').find('.form-wizard').children('li').eq(index - 1).addClass(
            'complete');
        $('#bootstrap-wizard-1').find('.form-wizard').children('li').eq(index - 1).find('.step')
            .html('<i class="fa fa-check"></i>');
        //$('#tab'+(index)).removeClass('active');
        //$('#tab'+(index+1)).addClass('active');
        //return true;


    },
    'onPrevious': function(tab, navigation, index) {
        //console.log(index);
        $('#bootstrap-wizard-1').find('.form-wizard').children('li').eq(index + 1).removeClass(
            'complete');
        $('#bootstrap-wizard-1').find('.form-wizard').children('li').eq(index + 1).find('.step')
            .html(index + 2);

    }
});
$('.launchBtn').click(function(e) {
    var $selectedItems = $('.role-Selected1');
    var $launchResultContainer = $('#launchResultContainer');
    $launchResultContainer.find('.modal-body').empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');
    $launchResultContainer.modal('show');
    for (var i = 0; i < $selectedItems.length; i++) {
        var projectId = $($selectedItems.get(i)).attr('data-projectId');
        var envId = $($selectedItems.get(i)).attr('data-envId');
        var blueprintId = $($selectedItems.get(i)).attr('data-blueprintId');
        var version = $($selectedItems.get(i)).find('.blueprintVersionDropDown').val();

        $.get('/blueprints/' + blueprintId + '/launch?version=' + version, function(data) {

            var $msg = $('<div></div>').append('<h3 class=\"alert alert-success\"><b>Congratulations!</b> Blueprint Launched Successfully</h3>').append('Instance Id : ' + data.id).append('<br/>Instance Logs :- ');

            $launchResultContainer.find('.modal-body').empty();
            $launchResultContainer.find('.modal-body').append($msg);

            var instanceId = data.id;
            var timeout;

            $launchResultContainer.on('hidden.bs.modal', function(e) {
                $launchResultContainer.off('hidden.bs.modal');
                if (timeout) {
                    clearTimeout(timeout);
                }
            });
            $divBootstrapLogArea = $('<div></div>').addClass('logsAreaBootstrap');

            $launchResultContainer.find('.modal-body').append($divBootstrapLogArea);

            var lastTimestamp;

            function pollLogs(timestamp, delay, clearData) {
                var url = '/instances/' + instanceId + '/logs';
                if (timestamp) {
                    url = url + '?timestamp=' + timestamp;
                }

                timeout = setTimeout(function() {
                    $.get(url, function(data) {
                        var $modalBody = $divBootstrapLogArea;
                        if (clearData) {
                            $modalBody.empty();
                        }
                        var $table = $('<div></div>');

                        for (var i = 0; i < data.length; i++) {
                            var $rowDiv = $('<div class="row"></div>');
                            var timeString = new Date().setTime(data[i].timestamp);
                            var date = new Date(timeString).toUTCString(); //converts to human readable strings
                            //$rowDiv.append($('<div class="col-lg-4 col-sm-4"></div>').append('<div>' + date + '</div>'));

                            if (data[i].err) {
                                $rowDiv.append($('<div class="col-lg-12 col-sm-12" style="color:red;"></div>').append('<span>' + data[i].log + '</span>'));
                            } else {
                                $rowDiv.append($('<div class="col-lg-12 col-sm-12 " style="color:white;"></div>').append('<span>' + data[i].log + '</span>'));
                            }

                            $table.append($rowDiv);
                        }


                        if (data.length) {
                            lastTimestamp = data[data.length - 1].timestamp;
                            console.log(lastTimestamp);
                            $modalBody.append($table);
                            $modalBody.scrollTop($modalBody[0].scrollHeight + 100);
                        }


                        console.log('polling again');
                        if ($launchResultContainer.data()['bs.modal'].isShown) {
                            pollLogs(lastTimestamp, 1000, false);
                        } else {
                            console.log('not polling again');
                        }
                    });
                }, delay);
            }
            pollLogs(lastTimestamp, 0, true);

            $.get('/instances/' + data.id, function(data) {
                addInstanceToDOM(data);
            });

        }).error(function() {
            $launchResultContainer.find('.modal-body').empty().append('<span>Oops! Something went wrong. Please try again later</span>');
        });
    }
});



$('.blueprintUpdateBtn').click(function(e) {

    var $blueprintEditResultContainer = $('#blueprintEditResultContainer');
    var $chefRunlist = $blueprintEditResultContainer.find('.blueprintChefCookbookList');
    var blueprintId = $chefRunlist.attr('data-blueprintId');
    if (blueprintId) {
        console.log($chefRunlist.val());
        var blueprintData = {
            runlist: $chefRunlist.val(),
            expirationDays: 0,
        };

        $.post('/blueprints/' + blueprintId + '/update', {
            blueprintUpdateData: blueprintData
        }, function(data) {
            $('.blueprintVersionDropDown[data-blueprintId="' + blueprintId + '"]').append($('<option value="' + data.version + '">' + data.version + '</option>').attr('selected', true));
            console.log(data);
        });

    }
});

$('.btnUpdateInstanceRunlist').click(function(e) {
    var instanceId = $('.chefCookbookList').attr('data-instanceId');
    var runlist = $('.chefCookbookList').val();
    console.log(runlist);
    $.post('/instances/' + instanceId + '/updateRunlist', {
        runlist: runlist
    }, function(data) {
        $chefRunModalContainer = $('#chefRunModalContainer').modal('hide');
        var $parent = $('.domain-roles-caption[data-instanceId="' + instanceId + '"]');
        $parent.find('.moreInfo').trigger('click');
        console.log(data);
    });
});

$('.actionControlPanel').click(function(e) {
   
    if ($('#divinstancescardview').is(':visible')) {

        var $selectedCard = $('.role-Selectedcard');
        if ($selectedCard.length) {
            var instanceId = $selectedCard.find('.domain-roles-caption').attr('data-instanceId');
            if (instanceId) {
                window.location.href = 'index.html#ajax/Controlpanel.html?id=' + instanceId;
            }
        }
    } else {
        var $selectedCard = $('.rowcustomselected');
        if ($selectedCard.length) {
            var instanceId = $selectedCard.attr('data-instanceId');
            if (instanceId) {
                window.location.href = 'index.html#ajax/Controlpanel.html?id=' + instanceId;
            }
        }
    }
}); 

</script>

